                         <div class="bg-green-500 text-white p-3 rounded-full"><i class="fas fa-box-open"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–î–æ—Å—Ç–∞–≤–∫–∞</div>
                             <div class="text-xs text-gray-600">–ü—Ä–æ–¥—É–∫—Ç—ã, –ø–æ—Å—ã–ª–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
                         </div>
                    </button>
                    <button onclick="window.closeModal('servicesMenuModal'); window.openModal('cargoModal');" class="p-4 bg-yellow-50 rounded-xl flex items-center space-x-4 hover:bg-yellow-100 transition w-full text-left">
                         <div class="bg-yellow-500 text-white p-3 rounded-full"><i class="fas fa-truck"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–ì—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏</div>
                             <div class="text-xs text-gray-600">–ì–∞–∑–µ–ª—å, –ø–µ—Ä–µ–µ–∑–¥—ã</div>
                         </div>
                    </button>
                    <button onclick="window.closeModal('servicesMenuModal'); window.openModal('soberDriverModal');" class="p-4 bg-red-50 rounded-xl flex items-center space-x-4 hover:bg-red-100 transition w-full text-left">
                         <div class="bg-red-500 text-white p-3 rounded-full"><i class="fas fa-cocktail"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–¢—Ä–µ–∑–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</div>
                             <div class="text-xs text-gray-600">–ü–µ—Ä–µ–≥–æ–Ω –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ</div>
                         </div>
                    </button>
                    <button onclick="window.closeModal('servicesMenuModal'); window.openModal('assistanceModal');" class="p-4 bg-indigo-50 rounded-xl flex items-center space-x-4 hover:bg-indigo-100 transition w-full text-left">
                         <div class="bg-indigo-500 text-white p-3 rounded-full"><i class="fas fa-life-ring"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–ü–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–µ</div>
                             <div class="text-xs text-gray-600">–ü—Ä–∏–∫—É—Ä–∏—Ç—å, –±—É–∫—Å–∏—Ä, –∑–∞–º–µ–Ω–∞ –∫–æ–ª–µ—Å–∞</div>
                         </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. DELIVERY MODAL -->
    <div id="deliveryModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="deliveryModal">√ó</button>
                </div>
                <form id="deliveryForm" class="space-y-4">
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ß—Ç–æ –∫—É–ø–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å?</label>
                         <input id="delWhat" type="text" class="form-input-control" placeholder="–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å—ã–ª–∫–∏" required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–û—Ç–∫—É–¥–∞ (–ú–∞–≥–∞–∑–∏–Ω/–ê–¥—Ä–µ—Å)</label>
                         <input id="delFrom" type="text" class="form-input-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å" required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞ –≤–µ–∑—Ç–∏</label>
                         <input id="delTo" type="text" class="form-input-control" placeholder="–í–∞—à –∞–¥—Ä–µ—Å" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–ó–∞–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 6. CARGO MODAL -->
    <div id="cargoModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üöö –ì—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="cargoModal">√ó</button>
                </div>
                <form id="cargoForm" class="space-y-4">
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ß—Ç–æ –≤–µ–∑–µ–º?</label>
                         <input id="cargoWhat" type="text" class="form-input-control" placeholder="–ú–µ–±–µ–ª—å, —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø–µ—Ä–µ–µ–∑–¥..." required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–û—Ç–∫—É–¥–∞</label>
                         <input id="cargoFrom" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å –∑–∞–≥—Ä—É–∑–∫–∏" required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞</label>
                         <input id="cargoTo" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å –≤—ã–≥—Ä—É–∑–∫–∏" required>
                    </div>
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–ó–∞–∫–∞–∑–∞—Ç—å –ì–∞–∑–µ–ª—å</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 7. SOBER DRIVER MODAL -->
    <div id="soberDriverModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üç∑ –¢—Ä–µ–∑–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="soberDriverModal">√ó</button>
                </div>
                <form id="soberDriverForm" class="space-y-4">
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ì–¥–µ –º–∞—à–∏–Ω–∞?</label>
                         <input id="soberFrom" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å, –≥–¥–µ —Å—Ç–æ–∏—Ç –≤–∞—à–µ –∞–≤—Ç–æ" required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞ –µ–¥–µ–º?</label>
                         <input id="soberTo" type="text" class="form-input-control" placeholder="–ö–æ–Ω–µ—á–Ω—ã–π –∞–¥—Ä–µ—Å" required>
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–í—ã–∑–≤–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 8. ASSISTANCE MODAL -->
    <div id="assistanceModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üÜò –ü–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–µ</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="assistanceModal">√ó</button>
                </div>
                <form id="assistanceForm" class="space-y-4">
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?</label>
                         <input id="assistWhat" type="text" class="form-input-control" placeholder="–°–µ–ª –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä, –ø—Ä–æ–±–∏–ª –∫–æ–ª–µ—Å–æ..." required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ì–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?</label>
                         <input id="assistLoc" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–í—ã–∑–≤–∞—Ç—å –ø–æ–º–æ—â—å</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 9. PARTNER MODAL -->
    <div id="partnerModal" class="modal-overlay" aria-hidden="true" role="dialog">
         <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">ü§ù –°—Ç–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="partnerModal">√ó</button>
                </div>
                <div class="text-center space-y-4">
                    <p class="text-gray-600">–•–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∞–º–∏ –∏–ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Ä–µ–∫–ª–∞–º—É?</p>
                    <a href="https://wa.me/77770649648?text=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!%20–•–æ—á—É%20—Å—Ç–∞—Ç—å%20–ø–∞—Ä—Ç–Ω–µ—Ä–æ–º." target="_blank" class="block w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 transition">
                        –ù–∞–ø–∏—Å–∞—Ç—å –≤ WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. PWA INSTALL MODAL -->
    <div id="pwaModal" class="modal-overlay" aria-hidden="true" role="dialog">
         <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="pwaModal">√ó</button>
                </div>
                <div class="space-y-4 text-sm text-gray-600">
                    <p>–ß—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ iPhone:</p>
                    <ol class="list-decimal list-inside space-y-1 ml-2">
                        <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"</strong> <i class="fas fa-share-square"></i> –≤–Ω–∏–∑—É –±—Ä–∞—É–∑–µ—Ä–∞ Safari.</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>"–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª"</strong>.</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–î–æ–±–∞–≤–∏—Ç—å"</strong>.</li>
                    </ol>
                    <p class="mt-4">–ù–∞ Android:</p>
                    <ol class="list-decimal list-inside space-y-1 ml-2">
                        <li>–ù–∞–∂–º–∏—Ç–µ —Ç—Ä–∏ —Ç–æ—á–∫–∏ –≤ —É–≥–ª—É –±—Ä–∞—É–∑–µ—Ä–∞ Chrome.</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>"–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"</strong>.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- 11. HISTORY MODAL -->
    <div id="historyModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üïí –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="historyModal">√ó</button>
                </div>
                <div id="fullHistoryContainer" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- JS MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, updateDoc, addDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBAL VARS
        let app, db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const DRIVERS_COLLECTION = 'active_drivers';
        const ORDERS_COLLECTION = 'orders';
        const LOCAL_STORAGE_HISTORY_KEY = 'taxi_address_history_v1';
        const FULL_HISTORY_KEY = 'taxi_full_orders_history';
        const PHONE_NUMBER = '77770649648';

        // INTERCITY PRICES
        const INTERCITY_PRICES = {
            "—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫": "–æ—Ç 4800‚Äì6210 —Ç–≥", "–≥–ª—É–±–æ–∫–æ–µ": "–æ—Ç 4200 —Ç–≥", "—Ä–∏–¥–¥–µ—Ä": "–æ—Ç 25300 —Ç–≥",
            "—à–µ–º–æ–Ω–∞–∏—Ö–∞": "–æ—Ç 20700 —Ç–≥", "–∞–ª—Ç–∞–π": "–æ—Ç 45540 —Ç–≥", "—É—Å—Ç—å-—Ç–∞–ª–æ–≤–∫–∞": "–æ—Ç 19780 —Ç–≥", 
            "—Å–µ–∫–∏—Å–æ–≤–∫–∞": "–æ—Ç 6440 —Ç–≥", "–Ω–æ–≤–∞—è –±—É—Ö—Ç–∞—Ä–º–∞": "–æ—Ç 24150 —Ç–≥"
        };
        
        let driverLogicInitialized = false;
        
        // --- GLOBAL ORDER MAP for Robust Button Handling ---
        window.activeOrdersMap = new Map();

        // --- AUTH & INIT ---
        async function initFirebaseAndAuth() {
            if(!firebaseConfig) return;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        syncAddressHistory();
                        initDriverLogic();
                        checkDriverStatus();
                        subscribeToDrivers();
                    } else {
                        // Retry logic or prompt could go here, but anonymous login should handle it
                        console.warn("User not authenticated yet");
                    }
                    setAddressHistory();
                });
            } catch (e) {
                console.error("Auth failed:", e);
            }
        }

        // --- DRIVER LOGIC ---
        function initDriverLogic() {
            if (driverLogicInitialized) return;
            driverLogicInitialized = true;
            
            const btnOnline = document.getElementById('goOnlineBtn');
            const btnOffline = document.getElementById('goOfflineBtn');
            const ordersContainer = document.getElementById('driverOrdersContainer');
            const form = document.getElementById('driverForm');
            const modalTitle = document.getElementById('driverModalTitle');
            
            const savedDriver = JSON.parse(localStorage.getItem('taxi_driver_data') || '{}');
            if(savedDriver.name) document.getElementById('driverName').value = savedDriver.name;
            if(savedDriver.car) document.getElementById('driverCar').value = savedDriver.car;
            if(savedDriver.plate) document.getElementById('driverPlate').value = savedDriver.plate;

            btnOnline.addEventListener('click', async () => {
                const name = document.getElementById('driverName').value.trim();
                const car = document.getElementById('driverCar').value.trim();
                const plate = document.getElementById('driverPlate').value.trim();
                if(!name || !car || !plate) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!'); return; }
                if(!userId) { alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'); return; }
                
                // Show loading
                const originalText = btnOnline.innerHTML;
                btnOnline.innerHTML = '<i class="fas fa-spinner animate-spin"></i> –í–•–û–î...';
                btnOnline.disabled = true;
                
                try {
                    localStorage.setItem('taxi_driver_data', JSON.stringify({name, car, plate}));
                    // Strict Path: /artifacts/{appId}/public/data/{collectionName}
                    const driverRef = doc(db, 'artifacts', appId, 'public', 'data', DRIVERS_COLLECTION, userId);
                    await setDoc(driverRef, { name, car, plate, status: 'online', timestamp: Date.now() });
                    setDriverUI(true);
                } catch (error) {
                    console.error("Online Error:", error);
                    alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –ª–∏–Ω–∏—é: ' + error.message);
                } finally {
                    btnOnline.innerHTML = originalText;
                    btnOnline.disabled = false;
                }
            });

            btnOffline.addEventListener('click', async () => {
                if(!userId) return;
                try {
                    const driverRef = doc(db, 'artifacts', appId, 'public', 'data', DRIVERS_COLLECTION, userId);
                    await deleteDoc(driverRef);
                    setDriverUI(false);
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —É—Ö–æ–¥–∞ —Å –ª–∏–Ω–∏–∏: ' + error.message);
                }
            });
        }

        function setDriverUI(isOnline) {
            const form = document.getElementById('driverForm');
            const ordersContainer = document.getElementById('driverOrdersContainer');
            const modalTitle = document.getElementById('driverModalTitle');
            
            if (isOnline) {
                form.classList.add('hidden');
                ordersContainer.classList.remove('hidden');
                modalTitle.innerHTML = 'üöñ –õ–µ–Ω—Ç–∞ –ó–∞–∫–∞–∑–æ–≤';
                subscribeToOrders();
            } else {
                form.classList.remove('hidden');
                ordersContainer.classList.add('hidden');
                modalTitle.innerHTML = 'üöñ –ö–∞–±–∏–Ω–µ—Ç –í–æ–¥–∏—Ç–µ–ª—è';
            }
        }
        
        // --- ORDER LISTENER ---
        let ordersUnsubscribe = null;
        
        function subscribeToOrders() {
            if(ordersUnsubscribe) ordersUnsubscribe(); // Clear previous
            const listEl = document.getElementById('ordersList');
            const q = collection(db, 'artifacts', appId, 'public', 'data', ORDERS_COLLECTION);
            
            ordersUnsubscribe = onSnapshot(q, (snapshot) => {
                const orders = [];
                window.activeOrdersMap.clear(); // Clear old orders from memory
                
                snapshot.forEach(d => {
                    const data = { id: d.id, ...d.data() };
                    orders.push(data);
                    window.activeOrdersMap.set(data.id, data);
                });
                
                // Sort by new, FILTER OUT accepted orders
                const pendingOrders = orders
                    .filter(o => o.status !== 'accepted')
                    .sort((a,b) => b.timestamp - a.timestamp);
                
                if (pendingOrders.length === 0) {
                    listEl.innerHTML = '<div class="text-center text-gray-400 py-6"><i class="fas fa-search text-2xl mb-2"></i><br>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                    return;
                }
                
                listEl.innerHTML = '';
                pendingOrders.forEach(order => {
                    const el = document.createElement('div');
                    el.className = 'driver-order-card';
                    const isUrgent = order.type === 'taxi'; 
                    if (isUrgent) el.classList.add('priority');
                    
                    // IMPORTANT: Using onclick in HTML string is cleaner for dynamic lists than addEventListener inside loops
                    // which can cause binding issues upon re-renders.
                    // FIX: Pass 'this' to get exact button reference
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="driver-order-type">${order.typeLabel || '–ó–∞–∫–∞–∑'}</span>
                            <span class="text-xs text-gray-500 font-mono">${new Date(order.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="mb-2">
                            <div class="flex items-center text-gray-700 font-bold text-sm mb-1">
                                <i class="fas fa-map-marker-alt text-green-500 w-5"></i> ${order.from}
                            </div>
                            <div class="flex items-center text-gray-700 font-bold text-sm">
                                <i class="fas fa-flag-checkered text-red-500 w-5"></i> ${order.to}
                            </div>
                        </div>
                        <div class="flex justify-between items-center border-t pt-2 mt-2">
                            <div class="text-sm font-bold text-blue-600">${order.price || '–ü–æ —Ç–∞–∫—Å–æ–º–µ—Ç—Ä—É'}</div>
                            <button onclick="event.stopPropagation(); window.acceptOrderWrapper('${order.id}', this)" class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold uppercase shadow-sm hover:bg-green-700 active:scale-95 transition accept-btn">
                                –ü—Ä–∏–Ω—è—Ç—å
                            </button>
                        </div>
                        ${order.wishes ? `<div class="text-xs text-gray-500 mt-1 italic">"${order.wishes}"</div>` : ''}
                    `;
                    listEl.appendChild(el);
                });
            });
        }
        
        // --- GLOBAL WRAPPER FOR ACCEPT BUTTON ---
        window.acceptOrderWrapper = function(orderId, btnElement) {
            // FIX: Use passed element instead of activeElement which is flaky on mobile
            const order = window.activeOrdersMap.get(orderId);
            
            if(!order) {
                alert('–û—à–∏–±–∫–∞: –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–º—è—Ç–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫.');
                return;
            }
            
            acceptOrder(order, btnElement);
        }

        async function acceptOrder(order, btnElement) {
            // Check for double click
            if(btnElement && btnElement.disabled) return;
            
            if(!confirm('–ü—Ä–∏–Ω—è—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) return;
            
            // MOBILE FIX: Open window IMMEDIATELY to secure a "user gesture" token
            // This prevents popup blockers on iOS/Android from killing the WhatsApp redirect later
            const waWindow = window.open('', '_blank');
            if (waWindow) {
                waWindow.document.write(`
                    <html>
                    <body style="font-family:sans-serif;text-align:center;padding-top:50px;">
                        <h1>–û–±—Ä–∞–±–æ—Ç–∫–∞...</h1>
                        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ.</p>
                        <p>–°–æ–µ–¥–∏–Ω—è–µ–º —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö...</p>
                    </body>
                    </html>
                `);
            }

            // Show loading state on button
            const originalText = btnElement ? btnElement.innerText : '–ü—Ä–∏–Ω—è—Ç—å';
            if(btnElement) {
                btnElement.innerText = '‚è≥';
                btnElement.disabled = true;
            }

            try {
                // 1. Validation & Data Prep
                let currentUserId = userId;
                if (!currentUserId && auth.currentUser) {
                    currentUserId = auth.currentUser.uid;
                }
                
                if (!currentUserId) {
                    throw new Error("–°–∏—Å—Ç–µ–º–∞ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                }
                
                // Robustly get driver data with fallbacks for EVERYTHING to prevent DB errors
                let driverData = {};
                try {
                    driverData = JSON.parse(localStorage.getItem('taxi_driver_data') || '{}');
                } catch(e) { console.warn("Localstorage error", e); }
                
                // CRITICAL: Ensure no undefined values are passed to Firestore
                const dName = driverData.name ? String(driverData.name) : '–í–æ–¥–∏—Ç–µ–ª—å';
                const dCar = driverData.car ? String(driverData.car) : '–ú–∞—à–∏–Ω–∞';
                const dPlate = driverData.plate ? String(driverData.plate) : '---';
                
                const updatePayload = {
                    status: 'accepted',
                    driverName: dName,
                    driverCar: dCar,
                    driverPlate: dPlate,
                    driverId: String(currentUserId)
                };

                // 2. Prepare WhatsApp URL
                const msg = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–æ–¥–∏—Ç–µ–ª—å —Ç–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª (${dName}, ${dCar} ${dPlate}). –ü—Ä–∏–Ω—è–ª –≤–∞—à –∑–∞–∫–∞–∑: ${order.from} -> ${order.to}. –í—ã–µ–∑–∂–∞—é!`;
                
                // If passenger phone provided, link to them. If not, link to dispatcher (fallback)
                const phone = order.phone ? order.phone.replace(/\D/g,'') : PHONE_NUMBER; 
                const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
                
                // 3. UPDATE DB (Async operation that usually kills the popup token)
                const orderRef = doc(db, 'artifacts', appId, 'public', 'data', ORDERS_COLLECTION, order.id);
                // Use setDoc with merge to be absolutely safe against strange doc states
                await setDoc(orderRef, updatePayload, { merge: true });
                
                // 4. Redirect the pre-opened window
                if (waWindow) {
                    waWindow.location.href = url;
                } else {
                    // Fallback for desktop or strange browsers
                    window.location.href = url;
                }
                
                // Success visual (optional as item will disappear)
                if(btnElement) btnElement.innerText = '‚úÖ';
                
            } catch (e) {
                console.error("Accept Error", e);
                if (waWindow) waWindow.close(); // Close the loading window if error
                alert('–û–®–ò–ë–ö–ê –ü–†–ò–ù–Ø–¢–ò–Ø: ' + e.message + '\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
                // Revert button state if failed
                if(btnElement) {
                    btnElement.innerText = originalText;
                    btnElement.disabled = false;
                }
            }
        }

        async function checkDriverStatus() {
            if(!userId) return;
            // Strict Path Check
            const driverRef = doc(db, 'artifacts', appId, 'public', 'data', DRIVERS_COLLECTION, userId);
            try {
                const docSnap = await getDoc(driverRef);
                if (docSnap.exists()) setDriverUI(true); else setDriverUI(false);
            } catch(e) { console.warn("Driver check error", e); }
        }

        function subscribeToDrivers() {
            const container = document.getElementById('activeDriversList');
            const section = document.getElementById('activeDriversSection');
            // Strict Path Check
            const q = collection(db, 'artifacts', appId, 'public', 'data', DRIVERS_COLLECTION);
            
            onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                const drivers = [];
                snapshot.forEach((doc) => drivers.push(doc.data()));
                
                if (drivers.length > 0) {
                    section.classList.remove('hidden');
                    drivers.forEach(driver => {
                        const card = document.createElement('div');
                        card.className = 'driver-card';
                        card.innerHTML = `<div class="status-dot"></div><div><div class="font-bold text-xs leading-tight text-gray-800 dark:text-white">${driver.car}</div><div class="text-[10px] text-gray-500 font-mono bg-gray-100 dark:bg-gray-700 px-1 rounded inline-block mt-0.5">${driver.plate}</div></div>`;
                        container.appendChild(card);
                    });
                } else {
                    section.classList.add('hidden');
                }
            }, (error) => {
                console.warn("Driver list permission error", error);
                // Optionally show UI error if critical
            });
        }

        // --- OSRM & LOGIC ---
        function debounce(func, timeout = 1000){
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        async function getCoordinates(query) {
            if (query.includes('[–ì–ï–û]') || query.includes('[–ö–û–û–†–î–ò–ù–ê–¢–´]')) {
                const parts = query.match(/([\d\.]+),\s*([\d\.]+)/);
                if (parts && parts.length === 3) return { lat: parseFloat(parts[1]), lon: parseFloat(parts[2]) };
            }
            try {
                const searchQuery = `${query}, –ë–µ–ª–æ—É—Å–æ–≤–∫–∞, –í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`;
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
            } catch (e) { console.warn("Geocoding failed:", e); }
            return null;
        }

        async function getRouteDistance(coord1, coord2) {
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${coord1.lon},${coord1.lat};${coord2.lon},${coord2.lat}?overview=false`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 'Ok' && data.routes.length > 0) return data.routes[0].distance;
            } catch (e) { console.warn("Routing failed:", e); }
            return null;
        }

        async function calculateTaxiPriceOSRM() {
            const fromInput = document.getElementById('taxiFrom').value.trim();
            const toInput = document.getElementById('taxiTo').value.trim();
            const priceEl = document.getElementById('taxiPriceEstimate');
            if (fromInput.length < 3 || toInput.length < 3) return;
            priceEl.innerHTML = '<i class="fas fa-spinner animate-spin"></i> –°—á–∏—Ç–∞–µ–º...';
            const coordFrom = await getCoordinates(fromInput);
            const coordTo = await getCoordinates(toInput);
            if (coordFrom && coordTo) {
                const distMeters = await getRouteDistance(coordFrom, coordTo);
                if (distMeters !== null) {
                    const distKm = (distMeters / 1000).toFixed(1);
                    let price = 700;
                    if (distKm > 2) price += (distKm - 2) * 120;
                    price = Math.ceil(price / 10) * 10;
                    priceEl.innerText = `~${distKm} –∫–º ‚Ä¢ ${price} ‚Ç∏`;
                    return;
                }
            }
            priceEl.innerText = '–æ—Ç 700‚Äì900 —Ç–≥';
        }
        const debouncedOSRM = debounce(calculateTaxiPriceOSRM, 1500);

        // --- ADDRESS HISTORY ---
        async function loadAddresses() {
            try { return JSON.parse(localStorage.getItem(LOCAL_STORAGE_HISTORY_KEY) || '[]'); } catch (e) { return []; }
        }
        async function syncAddressHistory() {
            if (!db || !userId) return;
            try {
                const docRef = doc(db, "artifacts", appId, "users", userId, "data", "settings");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().addressHistory) {
                    localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(docSnap.data().addressHistory));
                }
            } catch (e) {}
        }
        async function saveAddress(address) {
             if (!address || address.length < 3) return;
             let history = await loadAddresses();
             history = history.filter(item => item.toLowerCase() !== address.toLowerCase());
             history.unshift(address);
             history = history.slice(0, 10);
             localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(history));
             if (db && userId) {
                 const docRef = doc(db, "artifacts", appId, "users", userId, "data", "settings");
                 setDoc(docRef, { addressHistory: history }, { merge: true }).catch(e => console.log(e));
             }
             await setAddressHistory();
        }

        async function populateDatalist(id) {
            const history = await loadAddresses();
            const el = document.getElementById(id);
            if (!el) return;
            el.innerHTML = ''; 
            history.forEach(a => { const o = document.createElement('option'); o.value = a; el.appendChild(o); });
        }
        
        async function renderHistoryChips() {
             const history = await loadAddresses();
             const c = document.getElementById('taxiHistoryChips');
             if (!c) return;
             c.innerHTML = '';
             const recent = history.slice(0, 5);
             if (recent.length === 0) { c.style.display = 'none'; return; }
             c.style.display = 'flex';
             recent.forEach(addr => {
                 const b = document.createElement('button');
                 b.className = 'history-chip btn-active';
                 b.innerHTML = `<i class="fas fa-history mr-1"></i>${addr.substring(0, 15)}`;
                 b.onclick = () => { document.getElementById('taxiFrom').value = addr; updateTaxiPrice(); };
                 c.appendChild(b);
             });
        }
        window.setAddressHistory = async function() { await populateDatalist('fromHistory'); await populateDatalist('toHistory'); await renderHistoryChips(); }

        window.renderOrderHistory = function() {
             const container = document.getElementById('fullHistoryContainer');
             const orders = JSON.parse(localStorage.getItem(FULL_HISTORY_KEY) || '[]');
             if(orders.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-10">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>'; return; }
             container.innerHTML = orders.map(order => `
                 <div class="p-3 border-b flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" onclick="window.repeatOrder('${order.from}', '${order.to}')">
                     <div class="flex-grow">
                        <div class="text-xs text-gray-500">${order.date}</div>
                        <div class="text-sm font-semibold">${order.from} -> ${order.to}</div>
                     </div>
                     <div class="text-right text-sm font-bold text-blue-600">${order.price}</div>
                 </div>`).join('');
        }
        
        window.repeatOrder = function(from, to) {
            document.getElementById('taxiFrom').value = from;
            document.getElementById('taxiTo').value = to;
            updateTaxiPrice();
            window.closeModal('historyModal');
            window.openModal('taxiModal');
        };

        // --- CLIENT TRACKING LOGIC ---
        window.closeTrackingModal = function() {
            window.closeModal('clientTrackingModal');
            if (window.clientOrderUnsubscribe) {
                window.clientOrderUnsubscribe(); // Stop listening
                window.clientOrderUnsubscribe = null;
            }
        };

        function trackOrder(orderId) {
            const modal = document.getElementById('clientTrackingModal');
            const searchUI = document.getElementById('trackingSearching');
            const foundUI = document.getElementById('trackingFound');
            
            // Reset UI
            searchUI.classList.remove('hidden');
            foundUI.classList.add('hidden');
            window.openModal('clientTrackingModal');

            // Listen to document
            const orderRef = doc(db, 'artifacts', appId, 'public', 'data', ORDERS_COLLECTION, orderId);
            window.clientOrderUnsubscribe = onSnapshot(orderRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // Deleted?
                    window.closeTrackingModal();
                    return;
                }
                
                const data = docSnap.data();
                if (data.status === 'accepted') {
                    // Show driver info
                    searchUI.classList.add('hidden');
                    foundUI.classList.remove('hidden');
                    document.getElementById('trackingDriverName').innerText = data.driverName || '–í–æ–¥–∏—Ç–µ–ª—å';
                    document.getElementById('trackingDriverCar').innerText = data.driverCar || '–ê–≤—Ç–æ';
                    document.getElementById('trackingDriverPlate').innerText = data.driverPlate || '–ù–æ–º–µ—Ä';
                }
            });
        }

        // --- GLOBAL UI ---
        window.openModal = function(id) { document.getElementById(id).classList.add('active'); }
        window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); }
        window.toggleAccordion = function(id) { const el = document.getElementById(id); el.classList.toggle('hidden'); }
        window.toggleTheme = function() { document.body.classList.toggle('dark'); }
        window.getCurrentLocation = function(t) {
             if (!navigator.geolocation) { alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
             navigator.geolocation.getCurrentPosition(p => {
                 const v = `[–ö–û–û–†–î–ò–ù–ê–¢–´] ${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`;
                 if(t === 'main') { document.getElementById('locationResult').classList.remove('hidden'); document.getElementById('locationAddress').innerText = v; }
                 else if(t === 'taxi') { document.getElementById('taxiFrom').value = v; updateTaxiPrice(); }
                 else if(t === 'auction') { document.getElementById('auctionFrom').value = v; }
             });
        }
        
        // --- PRICE UPDATE LOGIC (Restored Intercity) ---
        window.updateTaxiPrice = function() {
            const priceEl = document.getElementById('taxiPriceEstimate');
            const toInput = document.getElementById('taxiTo');
            const destination = toInput ? toInput.value.trim().toLowerCase() : '';
            
            // Check Intercity First
            const cleanDestination = destination.replace(/^(–≥\.|–≥–æ—Ä–æ–¥\s+|–ø\.|–ø–æ—Å\.|–ø–æ—Å–µ–ª–æ–∫\s+|—Å\.|—Å–µ–ª–æ\s+)/i, '').trim();
            for (const location in INTERCITY_PRICES) {
                if (cleanDestination.startsWith(location)) {
                    priceEl.textContent = INTERCITY_PRICES[location];
                    return; 
                }
            }
            // Fallback to OSRM
            debouncedOSRM();
        }
        
        window.addWish = function(text) {
            const wishEl = document.getElementById('taxiWishes');
            let currentText = wishEl.value.trim();
            if (!currentText) wishEl.value = text;
            else if (!currentText.includes(text)) wishEl.value = currentText + ', ' + text;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
             initFirebaseAndAuth();
             if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
             const pi = document.getElementById('passengerPhone');
             if (pi) IMask(pi, { mask: '+{7} (000) 000-00-00' });
             
             // --- RESTORED EVENT LISTENERS FOR MODALS ---
             
             // 1. Close buttons (X)
             document.querySelectorAll('.close-btn').forEach(btn => {
                 btn.addEventListener('click', () => {
                     const modalId = btn.getAttribute('data-modal');
                     if(modalId) window.closeModal(modalId);
                 });
             });

             // 2. Service buttons (Taxi, Delivery, etc.)
             document.querySelectorAll('[data-service]').forEach(btn => {
                 btn.addEventListener('click', () => {
                     const service = btn.getAttribute('data-service');
                     if(service) window.openModal(service + 'Modal');
                 });
             });

             // 3. Click outside to close
             document.querySelectorAll('.modal-overlay').forEach(overlay => {
                 overlay.addEventListener('click', (e) => {
                     if (e.target === overlay) {
                         window.closeModal(overlay.id);
                     }
                 });
             });
        });

        // --- HELPERS ---
        window.shareApp = function() {
            if (navigator.share) {
                navigator.share({
                    title: '–¢–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª',
                    text: '–£–¥–æ–±–Ω—ã–π –∑–∞–∫–∞–∑ —Ç–∞–∫—Å–∏ –≤ –ë–µ–ª–æ—É—Å–æ–≤–∫–µ!',
                    url: window.location.href
                }).catch(console.error);
            } else {
                alert('–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π: ' + window.location.href);
            }
        }
        
        window.swapTaxiAddresses = function() { const f = document.getElementById('taxiFrom'); const t = document.getElementById('taxiTo'); const v = f.value; f.value = t.value; t.value = v; updateTaxiPrice(); }
        window.addStop = function(id) { const c = document.getElementById(id); const i = document.createElement('input'); i.className = 'form-input-control mt-2'; i.placeholder='–î–æ–ø. –∞–¥—Ä–µ—Å'; c.appendChild(i); }
        window.togglePreorder = function() { document.getElementById('preorderContent').classList.toggle('hidden'); }
        window.openServicesMenu = function() { window.openModal('servicesMenuModal'); }
        window.installApp = function() { document.getElementById('pwaModal').classList.remove('hidden'); }
        window.showPartnerModal = function() { document.getElementById('partnerModal').classList.remove('hidden'); }
        window.dismissAnnouncement = function() { document.getElementById('announcementBar').classList.add('hidden'); }
        
        // --- RESTORED FORM SUBMISSION LOGIC ---
        document.querySelectorAll('form').forEach(f => {
            f.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formId = f.id;
                let msg = '';
                let orderData = null;
                
                // Save Addresses
                const inputs = f.querySelectorAll('input[type="text"]');
                inputs.forEach(i => saveAddress(i.value));

                if (formId === 'taxiForm') {
                    const from = document.getElementById('taxiFrom').value;
                    const to = document.getElementById('taxiTo').value;
                    const phone = document.getElementById('passengerPhone').value;
                    const wishes = document.getElementById('taxiWishes').value;
                    const date = document.getElementById('taxiDateTime').value;
                    const price = document.getElementById('taxiPriceEstimate').innerText;
                    
                    msg = `üöï –ù–û–í–´–ô –ó–ê–ö–ê–ó: –¢–ê–ö–°–ò\n\n–û—Ç–∫—É–¥–∞: ${from}\n–ö—É–¥–∞: ${to}`;
                    if(date) msg = `‚è∞ –ü–†–ï–î–ó–ê–ö–ê–ó –Ω–∞ ${date.replace('T', ' ')}\n` + msg;
                    if(phone) msg += `\nüìû –¢–µ–ª: ${phone}`;
                    if(wishes) msg += `\nüìù –ü–æ–∂–µ–ª–∞–Ω–∏—è: ${wishes}`;
                    msg += `\nüí∞ –¶–µ–Ω–∞: ${price}`;
                    
                    orderData = {
                        type: 'taxi', typeLabel: '–¢–∞–∫—Å–∏', from, to, price, wishes, phone,
                        timestamp: Date.now(),
                        status: 'pending' // Default status
                    };
                    
                    // Save history
                    const now = new Date();
                    const order = { id: Date.now(), date: now.toLocaleDateString(), time: now.toLocaleTimeString(), from, to, price };
                    let orders = JSON.parse(localStorage.getItem(FULL_HISTORY_KEY) || '[]');
                    orders.unshift(order);
                    localStorage.setItem(FULL_HISTORY_KEY, JSON.stringify(orders));
                } 
                else if (formId === 'auctionForm') {
                    const from = document.getElementById('auctionFrom').value;
                    const to = document.getElementById('auctionTo').value;
                    const price = document.getElementById('auctionPrice').value;
                    msg = `üî® –ê–£–ö–¶–ò–û–ù (–ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ü–µ–Ω—É)\n\n–û—Ç–∫—É–¥–∞: ${from}\n–ö—É–¥–∞: ${to}\nüí∞ –ü—Ä–µ–¥–ª–∞–≥–∞—é: ${price} KZT`;
                    orderData = { type: 'auction', typeLabel: '–ê—É–∫—Ü–∏–æ–Ω', from, to, price: price + ' —Ç–≥', timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'deliveryForm') {
                    const what = document.getElementById('delWhat').value;
                    const from = document.getElementById('delFrom').value;
                    const to = document.getElementById('delTo').value;
                    msg = `üì¶ –ó–ê–ö–ê–ó –î–û–°–¢–ê–í–ö–ò\n\n–ß—Ç–æ: ${what}\n–û—Ç–∫—É–¥–∞: ${from}\n–ö—É–¥–∞: ${to}`;
                    orderData = { type: 'delivery', typeLabel: '–î–æ—Å—Ç–∞–≤–∫–∞', from, to, price: '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è', wishes: what, timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'cargoForm') {
                    const what = document.getElementById('cargoWhat').value;
                    const from = document.getElementById('cargoFrom').value;
                    const to = document.getElementById('cargoTo').value;
                    msg = `üöö –ó–ê–ö–ê–ó –ì–†–£–ó–û–ü–ï–†–ï–í–û–ó–ö–ò\n\n–ß—Ç–æ: ${what}\n–û—Ç–∫—É–¥–∞: ${from}\n–ö—É–¥–∞: ${to}`;
                    orderData = { type: 'cargo', typeLabel: '–ì—Ä—É–∑', from, to, price: '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è', wishes: what, timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'soberDriverForm') {
                    const loc = document.getElementById('soberFrom').value;
                    const to = document.getElementById('soberTo').value;
                    msg = `üç∑ –¢–†–ï–ó–í–´–ô –í–û–î–ò–¢–ï–õ–¨\n\n–ì–¥–µ –º–∞—à–∏–Ω–∞: ${loc}\n–ö—É–¥–∞ –µ—Ö–∞—Ç—å: ${to}`;
                    orderData = { type: 'sober', typeLabel: '–¢—Ä–µ–∑–≤—ã–π', from: loc, to: to, price: '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è', timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'assistanceForm') {
                    const what = document.getElementById('assistWhat').value;
                    const loc = document.getElementById('assistLoc').value;
                    msg = `üÜò –ü–û–ú–û–©–¨ –ù–ê –î–û–†–û–ì–ï\n\n–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å: ${what}\n–ì–¥–µ: ${loc}`;
                     orderData = { type: 'assistance', typeLabel: '–ü–æ–º–æ—â—å', from: loc, to: '–ù–∞ –º–µ—Å—Ç–µ', price: '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è', wishes: what, timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'driverForm') {
                    return; 
                }

                if (msg) {
                    // MOBILE FIX: Open window IMMEDIATELY to secure a "user gesture" token
                    // This prevents popup blockers on iOS/Android from killing the WhatsApp redirect later
                    const waWindow = window.open('', '_blank');
                    if (waWindow) {
                        waWindow.document.write(`
                            <html>
                            <body style="font-family:sans-serif;text-align:center;padding-top:50px;">
                                <h1>–û–±—Ä–∞–±–æ—Ç–∫–∞...</h1>
                                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ.</p>
                                <p>–°–æ–µ–¥–∏–Ω—è–µ–º —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö...</p>
                            </body>
                            </html>
                        `);
                    }

                    // 1. Save to DB for drivers
                    let docRefId = null;
                    if(orderData && db) {
                        try {
                           const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', ORDERS_COLLECTION), orderData);
                           docRefId = docRef.id;
                        } catch(e) { console.error("DB Save Error", e); }
                    }
                    
                    // 2. Prepare URL
                    const url = `https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(msg)}`;
                    
                    // 3. Redirect the pre-opened window (or open new if failed, though likely blocked)
                    if (waWindow) {
                        waWindow.location.href = url;
                    } else {
                        // Fallback for weird cases
                        window.location.href = url;
                    }
                    
                    window.closeModal(f.closest('.modal-overlay').id);
                    f.reset();
                    
                    // 3. START TRACKING IF DB SAVE WAS SUCCESSFUL
                    if (docRefId) {
                        trackOrder(docRefId);
                    }
                }
            });
        });

    </script>
</body>
</html>
