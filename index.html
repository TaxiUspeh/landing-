<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Такси Успех — Белоусовка</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Предзагрузка критических стилей -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        #map { height: 350px; border-radius: 1.5rem; z-index: 1; cursor: crosshair; }
        
        .order-card { transition: all 0.3s ease; }
        .order-card:active { transform: scale(0.98); }
        
        .status-pending { color: #f59e0b; }
        .status-accepted { color: #10b981; }
        .status-in_progress { color: #3b82f6; }
        .status-completed { color: #64748b; }
        
        .hidden { display: none !important; }
        
        /* Легкая анимация загрузки */
        .loader-ring {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(59, 130, 246, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .gps-indicator {
            width: 12px;
            height: 12px;
            background-color: #3b82f6;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.5); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0); }
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen pb-10">

<div class="max-w-md mx-auto px-4 pt-6">
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-black italic uppercase tracking-tighter text-blue-600 dark:text-blue-400 leading-none">Успех</h1>
            <p class="text-[10px] font-bold uppercase opacity-50 tracking-widest mt-1">Белоусовка • Такси</p>
        </div>
        <button onclick="location.reload()" class="p-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700">
            <i data-lucide="rotate-cw" class="w-5 h-5"></i>
        </button>
    </header>

    <div id="loadingOverlay" class="flex flex-col items-center justify-center py-32 italic font-bold text-slate-400">
        <div class="loader-ring mb-4"></div>
        <p class="animate-pulse">Загрузка системы...</p>
    </div>

    <!-- Сообщение об ошибке GPS / Подсказка о ручном вводе -->
    <div id="gpsErrorMsg" class="hidden mb-4 p-4 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-2xl text-[11px] font-bold border border-blue-200 dark:border-blue-800">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-4 h-4 mt-0.5 shrink-0"></i>
            <div>
                <p id="gpsStatusText">GPS заблокирован или недоступен.</p>
                <p class="mt-1 opacity-80" id="manualInstruction">Нажмите на карту, чтобы указать своё местоположение вручную.</p>
            </div>
        </div>
    </div>

    <!-- Выбор роли -->
    <div id="roleSelect" class="hidden space-y-4 animate-in fade-in duration-500">
        <button onclick="setRole('client')" class="w-full p-6 bg-blue-600 text-white rounded-[2rem] shadow-xl shadow-blue-500/20 flex items-center justify-between group active:scale-95 transition-all">
            <span class="text-xl font-black italic uppercase">Заказать такси</span>
            <div class="bg-white/20 p-3 rounded-2xl"><i data-lucide="user-plus" class="w-6 h-6"></i></div>
        </button>
        <button onclick="showDriverAuth()" class="w-full p-6 bg-slate-900 text-white rounded-[2rem] shadow-xl flex items-center justify-between border border-slate-800 active:scale-95 transition-all">
            <span class="text-xl font-black italic uppercase">Работать</span>
            <div class="bg-orange-500 p-3 rounded-2xl text-white"><i data-lucide="steering-wheel" class="w-6 h-6"></i></div>
        </button>
    </div>

    <!-- Вход водителя -->
    <div id="driverAuth" class="hidden animate-in fade-in zoom-in duration-300">
        <div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] shadow-2xl border dark:border-slate-800">
            <h3 class="text-xl font-black italic uppercase mb-6 text-orange-600">Вход водителя</h3>
            <p class="text-[10px] font-bold uppercase opacity-50 mb-4 tracking-widest">Введите ваш рабочий номер</p>
            <input id="driverPhone" type="tel" placeholder="+7 700 000 0000" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border-2 border-transparent focus:border-orange-500 rounded-2xl outline-none font-bold text-lg mb-4 transition-all">
            <button onclick="loginDriver()" class="w-full py-5 bg-orange-500 text-white rounded-2xl font-black uppercase italic shadow-lg shadow-orange-500/20 active:scale-95 transition-all">Начать смену</button>
            <button onclick="location.reload()" class="w-full mt-4 text-xs font-bold text-slate-400 uppercase underline">Назад</button>
        </div>
    </div>

    <!-- Интерфейс КЛИЕНТА -->
    <div id="client" class="hidden space-y-6">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] shadow-xl border dark:border-slate-800">
            <h3 class="font-black text-lg mb-4 uppercase italic text-blue-600">Куда едем?</h3>
            <input id="from" placeholder="Откуда (адрес)" class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl outline-none font-bold mb-3 border-2 border-transparent focus:border-blue-500 transition-all shadow-inner">
            <input id="to" placeholder="Куда (адрес)" class="w-full p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl outline-none font-bold mb-4 border-2 border-transparent focus:border-blue-500 transition-all shadow-inner">
            <button onclick="sendOrder()" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-black uppercase italic shadow-xl active:scale-95 transition-all">Вызвать машину</button>
        </div>

        <div id="map" class="shadow-2xl border-4 border-white dark:border-slate-800"></div>

        <div class="space-y-4">
            <h4 class="font-black text-slate-400 uppercase text-xs tracking-widest px-2">Активные заказы</h4>
            <div id="clientOrders" class="space-y-3"></div>
        </div>
    </div>

    <!-- Интерфейс ВОДИТЕЛЯ -->
    <div id="driver" class="hidden space-y-6">
        <div class="bg-indigo-600 p-6 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
            <div class="relative z-10">
                <h3 class="text-2xl font-black italic uppercase tracking-tighter">На линии</h3>
                <p id="driverStatusLabel" class="text-[10px] font-bold opacity-70 uppercase tracking-widest">Ожидание заказов...</p>
            </div>
            <i data-lucide="car" class="absolute right-[-10px] top-[-10px] opacity-10 w-32 h-32"></i>
        </div>

        <div class="space-y-4">
            <h4 class="font-black text-slate-400 uppercase text-xs tracking-widest px-2">Свободные заказы</h4>
            <div id="freeOrders" class="space-y-3"></div>
        </div>

        <div class="space-y-4">
            <h4 class="font-black text-blue-500 uppercase text-xs tracking-widest px-2">Заказы в работе</h4>
            <div id="activeOrders" class="space-y-3"></div>
        </div>
    </div>
</div>

<!-- Скрипты загружаются в конце для ускорения отрисовки (defer) -->
<script src="https://cdn.tailwindcss.com" defer></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" defer></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
<script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js" defer></script>

<script>
// Глобальные переменные и функции
let db, auth, map, carMarker, isAuthReady = false, currentRole = null;
const DEFAULT_COORDS = [50.395, 82.593]; 
const SOUNDS = {
    NEW_ORDER: 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3',
    ACCEPTED: 'https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3',
    ARRIVED: 'https://assets.mixkit.co/active_storage/sfx/1353/1353-preview.mp3'
};

// Ждем полной загрузки скриптов
window.onload = function() {
    initApp();
};

function initApp() {
    const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'taxi-uspeh-live';
    const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    db = firebase.firestore();
    auth = firebase.auth();

    // Инициализация иконок Lucide
    if (typeof lucide !== 'undefined') lucide.createIcons();

    const initAuth = async () => {
        try {
            if (customToken) {
                await auth.signInWithCustomToken(customToken);
            } else {
                await auth.signInAnonymously();
            }
        } catch (err) {
            console.error("Auth failed:", err);
        }
    };

    auth.onAuthStateChanged((user) => {
        if (user) {
            isAuthReady = true;
            document.getElementById("loadingOverlay").classList.add("hidden");
            document.getElementById("roleSelect").classList.remove("hidden");
        }
    });

    initAuth();
}

function initMap() {
    if (map || typeof L === 'undefined') return;
    map = L.map('map').setView(DEFAULT_COORDS, 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);
    
    const taxiIcon = L.divIcon({
        html: `<div class="bg-yellow-400 p-2 rounded-full border-2 border-slate-900 shadow-lg text-slate-900">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
               </div>`,
        className: '',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });
    
    carMarker = L.marker(DEFAULT_COORDS, {icon: taxiIcon});

    map.on('click', (e) => {
        if (currentRole === 'driver') {
            updateDriverLocation(e.latlng.lat, e.latlng.lng);
        }
    });
}

const getOrdersCol = () => db.collection('artifacts').doc(typeof window.__app_id !== 'undefined' ? window.__app_id : 'taxi-uspeh-live').collection('public').doc('data').collection('orders');
const getDriversCol = () => db.collection('artifacts').doc(typeof window.__app_id !== 'undefined' ? window.__app_id : 'taxi-uspeh-live').collection('public').doc('data').collection('drivers');

async function setRole(r) {
    if (!isAuthReady) return;
    currentRole = r;
    document.getElementById("roleSelect").classList.add("hidden");
    
    if (r === "client") {
        document.getElementById("client").classList.remove("hidden");
        document.getElementById("map").classList.remove("hidden");
        initMap();
        listenClientOrders();
    }
}

function showDriverAuth() {
    document.getElementById("roleSelect").classList.add("hidden");
    document.getElementById("driverAuth").classList.remove("hidden");
}

async function loginDriver() {
    if (!isAuthReady) return;
    currentRole = 'driver';
    const phone = document.getElementById("driverPhone").value;
    if (!phone) return;

    document.getElementById("driverAuth").classList.add("hidden");
    document.getElementById("driver").classList.remove("hidden");
    
    const driverMapContainer = document.createElement('div');
    driverMapContainer.id = "map";
    driverMapContainer.className = "shadow-2xl border-4 border-white dark:border-slate-800 mt-6";
    document.getElementById("driver").insertBefore(driverMapContainer, document.querySelector("#freeOrders").parentNode);
    
    initMap();
    listenFreeOrders();
    listenDriverOrders();
    watchDriverLocation();
}

async function updateDriverLocation(lat, lng) {
    if (!auth.currentUser) return;
    try {
        await getDriversCol().doc(auth.currentUser.uid).set({
            lat: lat,
            lng: lng,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        if (currentRole === 'driver' && map) {
            if (!map.hasLayer(carMarker)) carMarker.addTo(map);
            carMarker.setLatLng([lat, lng]);
        }
    } catch (err) {
        console.error("Location update failed:", err);
    }
}

function watchDriverLocation() {
    if (!navigator.geolocation) {
        showGpsError("GPS не поддерживается.");
        return;
    }

    navigator.geolocation.watchPosition(
        (pos) => {
            document.getElementById("gpsErrorMsg").classList.add("hidden");
            updateDriverLocation(pos.coords.latitude, pos.coords.longitude);
        }, 
        (err) => {
            showGpsError("Проблема с доступом к GPS.");
        }, 
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
    );
}

function showGpsError(text) {
    const el = document.getElementById("gpsErrorMsg");
    if (el) {
        el.classList.remove("hidden");
        document.getElementById("gpsStatusText").innerText = text;
    }
}

function trackDriverOnMap(dId) {
    if (!map) return;
    getDriversCol().doc(dId).onSnapshot(doc => {
        if (doc.exists) {
            const loc = doc.data();
            const pos = [loc.lat, loc.lng];
            if (!map.hasLayer(carMarker)) carMarker.addTo(map);
            carMarker.setLatLng(pos);
            map.panTo(pos);
        }
    });
}

async function sendOrder() {
    if (!auth.currentUser) return;
    const fromVal = document.getElementById("from").value;
    const toVal = document.getElementById("to").value;
    if (!fromVal || !toVal) return;

    await getOrdersCol().add({
        from: fromVal,
        to: toVal,
        price: 800,
        status: "pending",
        clientId: auth.currentUser.uid,
        driverId: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    document.getElementById("from").value = "";
    document.getElementById("to").value = "";
    playSound(SOUNDS.NEW_ORDER);
}

function listenClientOrders() {
    if (!auth.currentUser) return;
    getOrdersCol()
        .where("clientId", "==", auth.currentUser.uid)
        .onSnapshot(snap => {
            const box = document.getElementById("clientOrders");
            if (!box) return;
            box.innerHTML = "";
            const sorted = snap.docs.sort((a,b) => (b.data().createdAt?.seconds || 0) - (a.data().createdAt?.seconds || 0));
            sorted.forEach(doc => {
                const o = doc.data();
                const card = document.createElement('div');
                card.className = "bg-white dark:bg-slate-900 p-5 rounded-3xl shadow-sm border dark:border-slate-800";
                card.innerHTML = `<div class="flex justify-between items-start">
                    <p class="font-bold text-sm italic">${o.from} → ${o.to}</p>
                    <span class="font-black text-blue-600">${o.price} ₸</span>
                </div>
                <p class="text-[10px] font-black uppercase mt-2 status-${o.status}">${translateStatus(o.status)}</p>`;
                box.appendChild(card);
                if (o.status === "in_progress" && o.driverId) trackDriverOnMap(o.driverId);
            });
        });
}

function listenFreeOrders() {
    getOrdersCol().where("status", "==", "pending").onSnapshot(snap => {
        const box = document.getElementById("freeOrders");
        if (!box) return;
        box.innerHTML = "";
        snap.forEach(doc => {
            const o = doc.data();
            const card = document.createElement('div');
            card.className = "bg-white dark:bg-slate-900 p-5 rounded-3xl shadow-sm border dark:border-slate-800";
            card.innerHTML = `<div class="flex justify-between items-center mb-4">
                <p class="font-bold italic">${o.from} → ${o.to}</p>
                <span class="font-black text-xl text-emerald-600">${o.price} ₸</span>
            </div>
            <button onclick="acceptOrder('${doc.id}')" class="w-full py-3 bg-slate-900 text-white rounded-xl font-black uppercase text-[10px]">Принять</button>`;
            box.appendChild(card);
        });
        if (snap.size > 0) playSound(SOUNDS.NEW_ORDER);
    });
}

function listenDriverOrders() {
    if (!auth.currentUser) return;
    getOrdersCol().where("driverId", "==", auth.currentUser.uid).onSnapshot(snap => {
        const box = document.getElementById("activeOrders");
        if (!box) return;
        box.innerHTML = "";
        snap.forEach(doc => {
            const o = doc.data();
            if (o.status === "completed") return;
            const card = document.createElement('div');
            card.className = "bg-slate-900 text-white p-5 rounded-3xl border border-slate-800";
            card.innerHTML = `<p class="font-bold mb-4 italic">${o.from} → ${o.to}</p>
            <div class="grid grid-cols-2 gap-2">
                ${o.status === 'accepted' ? `<button onclick="updateOrderStatus('${doc.id}', 'in_progress')" class="py-3 bg-blue-600 rounded-xl font-black text-[9px]">Начать</button>` : `<button onclick="updateOrderStatus('${doc.id}', 'completed')" class="py-3 bg-emerald-500 rounded-xl font-black text-[9px]">Завершить</button>`}
                <button onclick="updateOrderStatus('${doc.id}', 'pending', true)" class="py-3 bg-white/10 rounded-xl font-black text-[9px]">Сбросить</button>
            </div>`;
            box.appendChild(card);
        });
    });
}

async function acceptOrder(id) {
    if (!auth.currentUser) return;
    await getOrdersCol().doc(id).update({
        status: "accepted",
        driverId: auth.currentUser.uid,
        acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    playSound(SOUNDS.ACCEPTED);
}

async function updateOrderStatus(id, status, reset = false) {
    const data = { status };
    if (reset) data.driverId = null;
    await getOrdersCol().doc(id).update(data);
}

function playSound(url) { new Audio(url).play().catch(() => {}); }
function translateStatus(s) { return {'pending': 'Поиск', 'accepted': 'Принят', 'in_progress': 'В пути', 'completed': 'Завершен'}[s] || s; }

</script>
</body>
</html>
