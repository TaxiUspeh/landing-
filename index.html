<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–¢–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª ‚Äî –ë–µ–ª–æ—É—Å–æ–≤–∫–∞</title>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NMCTD2Q8R2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('config', 'G-NMCTD2Q8R2');
    </script>

    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–¢–∞–∫—Å–∏ –£—Å–ø–µ—Ö">
    <meta name="theme-color" content="#1d4ed8" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/512/taxi.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/512/taxi.png">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/imask"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        html, body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        @supports (-webkit-touch-callout: none) {
            .header-bg { padding-top: env(safe-area-inset-top); }
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #1f2937;
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                              url('https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            padding-bottom: 90px;
            color: #1f2937; 
        }
        
        .header-bg { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.95) 0%, rgba(29, 78, 216, 0.95) 100%); 
            backdrop-filter: blur(10px);
        }

        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .btn-active:active { transform: scale(0.97); }

        .service-card, .main-card, .auction-cta, .stroy-dom-cta, .faq-item { 
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .service-card:hover { transform: scale(1.03); }
        .auction-cta { background-color: #fff; border: 2px solid #f59e0b; }
        
        /* Animations */
        @keyframes blink-custom {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); filter: brightness(1); }
            50% { transform: scale(1.03); box-shadow: 0 0 20px rgba(59, 130, 246, 0.9); filter: brightness(1.2); }
        }
        .blink-btn { animation: blink-custom 1.5s infinite ease-in-out; }
        
        #locationBtn {
            padding: 10px 12px; font-size: 1rem; background-color: #e5e7eb; color: #374151; font-weight: 600;
            border-radius: 8px; border: none; width: 100%;
        }

        .compact-util-btn {
            padding: 12px 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: 600; line-height: 1.2; border: none;
        }
        .quick-order-btn {
            padding-top: 12px; padding-bottom: 12px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; font-size: 0.875rem; font-weight: 700; border: none;
        }
        
        .text-shadow-md { text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(4px); 
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; 
            overflow-y: auto; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); transform: scale(0.95);
        }
        
        .form-input-control {
             padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;
             font-size: 16px; background-color: white; box-sizing: border-box;
        }
        
        .input-with-plus-btn { display: flex; align-items: center; gap: 8px; }
        .input-with-plus-btn .form-input-control { flex-grow: 1; min-width: 0; }
        
        .geo-btn, .add-stop-btn, .remove-stop-btn {
            flex-shrink: 0; width: 44px; height: 44px; color: white; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer;
        }
        .geo-btn { background-color: #f59e0b; }
        .add-stop-btn { background-color: #10b981; }
        .remove-stop-btn { background-color: #ef4444; }
        
        .wish-tag { transition: all 0.2s ease; user-select: none; }
        .wish-tag:active { transform: scale(0.95); }
        
        .history-chips-container {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; padding-top: 4px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .history-chips-container::-webkit-scrollbar { width: 0; height: 0; display: none; }
        
        .history-chip {
            white-space: nowrap; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; cursor: pointer;
            display: flex; align-items: center;
        }
        
        /* Drivers List */
        .driver-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 140px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .driver-card .status-dot {
            width: 8px; height: 8px; background-color: #10b981; border-radius: 50%;
            animation: pulse-green 2s infinite;
        }

        /* Driver Order Card */
        .driver-order-card {
            background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px;
            margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;
        }
        .driver-order-card.priority { border-color: #f59e0b; background: #fffbeb; }
        .driver-order-type {
            font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 2px 6px;
            border-radius: 4px; background: #3b82f6; color: white; display: inline-block; margin-bottom: 4px;
        }
        
        /* Dark Mode */
        .dark { background-color: #111827; color: #f3f4f6; }
        .dark .header-bg { background: linear-gradient(135deg, rgba(76, 29, 149, 0.95) 0%, rgba(16, 185, 129, 0.95) 100%); }
        .dark .main-card, .dark .service-card, .dark .auction-cta, 
        .dark .modal, .dark #faq-accordion > div, .dark .faq-item-content {
            background-color: #1f2937 !important; color: #e5e7eb !important; 
        }
        .dark .text-gray-900, .dark .text-gray-800, .dark .text-gray-700 { color: #d1d5db !important; }
        .dark .text-gray-600 { color: #9ca3af !important; }
        .dark .text-gray-500 { color: #6b7280 !important; }
        .dark .text-blue-900 { color: #93c5fd !important; }
        .dark .border-t, .dark .border, .dark .border-b { border-color: #374151 !important; }
        .dark .main-card { border-color: #059669 !important; }
        .dark .form-input-control { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        .dark .geo-btn { background-color: #b45309; }
        .dark #locationBtn { background-color: #374151; color: #f3f4f6; border: 1px solid #4b5563; }
        .dark .driver-card { background: rgba(31, 41, 55, 0.9); border-color: #34d399; color: white; }
        .dark .bg-red-100 { background-color: #7f1d1d !important; border-color: #991b1b !important; }
        .dark .text-red-700, .dark .text-red-600 { color: #fca5a5 !important; }
        .dark .bg-blue-50 { background-color: #1e3a8a !important; border-color: #1e40af !important; }
        .dark .text-blue-700 { color: #bfdbfe !important; }
        .dark .driver-order-card { background: #374151; border-color: #4b5563; }
        .dark .driver-order-card.priority { background: #451a03; border-color: #b45309; }

        /* Split Button */
        .split-btn { display: flex; width: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .split-btn-part {
            flex: 1; padding: 0.75rem 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.125rem; text-align: center; line-height: 1.3; cursor: pointer; border: none;
        }
        .split-btn-taxi { background-color: #10b981; color: white; border-right: 1px solid rgba(255, 255, 255, 0.3); }
        .split-btn-food { background-color: #ef4444; color: white; }
        .dark .split-btn-taxi { background-color: #047857; border-right: 1px solid rgba(255, 255, 255, 0.1); }
        .dark .split-btn-food { background-color: #b91c1c; }

        /* Bottom Bar */
        .bottom-bar-glass {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(229, 231, 235, 0.5);
        }
        .dark .bottom-bar-glass {
            background-color: rgba(17, 24, 39, 0.9);
            border-top: 1px solid rgba(55, 65, 81, 0.5);
        }

        /* Demand Banner */
        .demand-banner {
            background: linear-gradient(90deg, #f59e0b 0%, #ef4444 100%);
            background-size: 200% auto;
            animation: demand-pulse 2s infinite alternate;
        }
        @keyframes demand-pulse {
            from { filter: brightness(1); }
            to { filter: brightness(1.1); }
        }
    </style>
</head>

<body class="text-gray-900 min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="header-bg text-white py-4 rounded-b-lg shadow-lg sticky top-0 z-50">
        <div class="absolute top-2 right-2">
            <button id="themeToggle" onclick="toggleTheme()" class="text-white p-2 rounded-full bg-black bg-opacity-10 hover:bg-opacity-30 transition-all focus:outline-none z-50 btn-active">
                <i id="themeIcon" class="fas fa-moon text-lg"></i>
            </button>
        </div>
        <div class="max-w-md mx-auto px-4 text-center">
            <div class="flex items-center justify-center gap-2 mb-1">
                <i class="fas fa-taxi text-2xl text-yellow-300"></i>
                <h1 class="text-2xl font-extrabold tracking-tight">–¢–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª</h1>
            </div>
            <p class="text-white text-sm opacity-90">–í–∞—à –∫–æ–º—Ñ–æ—Ä—Ç –≤ –ø–æ—Å—ë–ª–∫–µ –ë–µ–ª–æ—É—Å–æ–≤–∫–∞.</p>
        </div>
    </header>

    <!-- Demand Banner -->
    <div id="announcementBar" class="demand-banner text-white p-3 shadow-lg lg:hidden">
        <div class="max-w-3xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i class="fas fa-exclamation-circle animate-pulse text-xl text-yellow-100"></i>
                <p id="announcementText" class="text-sm font-bold tracking-wide">
                    ‚ö†Ô∏è –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Å–ø—Ä–æ—Å! –û–∂–∏–¥–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã 15-20 –º–∏–Ω.
                </p>
            </div>
            <button onclick="dismissAnnouncement()" class="text-sm opacity-80 hover:opacity-100 transition btn-active">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- MAIN -->
    <main class="max-w-3xl mx-auto px-4 py-8 flex-grow">
        
        <!-- ACTIVE DRIVERS BLOCK -->
        <div id="activeDriversSection" class="mb-4 hidden">
             <div class="flex items-center gap-2 mb-2 px-1">
                 <span class="relative flex h-3 w-3">
                   <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                   <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                 </span>
                 <h3 class="text-white font-bold text-shadow-md text-sm uppercase tracking-wide">–°–µ–π—á–∞—Å –Ω–∞ –ª–∏–Ω–∏–∏:</h3>
             </div>
             <div id="activeDriversList" class="flex overflow-x-auto gap-3 pb-2 scrollbar-hide">
                 <div class="text-white text-sm italic opacity-80">–ü–æ–∏—Å–∫ –º–∞—à–∏–Ω...</div>
             </div>
        </div>

        <!-- MAIN CARD -->
        <div class="max-w-md mx-auto p-4 bg-white rounded-xl shadow-xl border-t-4 border-green-500 mb-6 main-card">
            
            <button data-service="taxi"
                class="service-btn btn-hover btn-active bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold transition-all shadow-lg flex items-center justify-center space-x-2 w-full py-3 text-lg mb-3 blink-btn">
                <i class="fas fa-car-side text-lg"></i><span>–ó–∞–∫–∞–∑–∞—Ç—å Taxi</span>
            </button>
            
            <div class="split-btn mb-3">
                <button onclick="openServicesMenu('whatsapp')"
                    class="btn-hover btn-active split-btn-part split-btn-taxi">
                    <span>–ú–µ–Ω—é —É—Å–ª—É–≥</span>
                </button>
                <a href="https://taxiuspeh.github.io/landing-/SHASHDVOR.html" target="_blank"
                    class="btn-hover btn-active split-btn-part split-btn-food">
                    <span>–ó–∞–∫–∞–∑ –ï–¥—ã</span>
                </a>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="shareApp()" 
                    class="btn-hover btn-active bg-green-500 hover:bg-green-600 text-white rounded-xl transition-all shadow-md quick-order-btn">
                    <i class="fas fa-share-alt mb-0.5"></i><span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                </button>
                <button onclick="openServicesMenu('telegram')"
                    class="btn-hover btn-active bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition-all shadow-md quick-order-btn">
                    <i class="fab fa-telegram-plane mb-0.5"></i><span>Telegram</span>
                </button>
                <button data-service="auction"
                    class="service-btn btn-hover btn-active bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl transition-all shadow-md quick-order-btn">
                    <i class="fas fa-gavel mb-0.5"></i><span>–ê—É–∫—Ü–∏–æ–Ω</span>
                </button>
            </div>
            
            <button type="button" onclick="getCurrentLocation('main')" id="locationBtn"
                class="w-full text-gray-700 font-semibold transition flex items-center justify-center space-x-3 shadow-inner btn-active">
                <i class="fas fa-location-arrow"></i>
                <span id="locationBtnText">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span>
            </button>
            <p id="locationResult" class="text-xs text-center text-gray-500 mt-2 hidden">
                <a id="locationAddress" href="#" target="_blank" class="coord-link"></a>
            </p>
            
            <div class="mt-4 pt-3 border-t border-gray-100 flex justify-center space-x-6 text-gray-600">
                <div class="flex items-center space-x-1">
                    <i class="fas fa-money-bill-wave text-xl text-green-500"></i>
                    <span class="font-semibold text-xs">–ù–∞–ª–∏—á–Ω—ã–µ</span>
                </div>
                <div class="flex items-center space-x-1">
                    <i class="fas fa-exchange-alt text-xl text-blue-500"></i>
                    <span class="font-semibold text-xs">–ü–µ—Ä–µ–≤–æ–¥ (Kaspi)</span>
                </div>
            </div>
        </div>
        
        <!-- SERVICES -->
        <h3 class="text-2xl font-bold text-center mb-6 text-white text-shadow-md border-t pt-8 mt-8 border-gray-400 border-opacity-30">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –£—Å–ª—É–≥–∏ (–§–æ—Ä–º–∞)</h3>
        
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 max-w-md mx-auto mb-8">
            <button data-service="delivery"
                class="service-btn btn-active service-card bg-white p-3 rounded-xl shadow-md flex flex-col items-center justify-center text-blue-900 font-semibold border-b-4 border-green-500">
                <i class="fas fa-box-open text-2xl mb-1 text-green-600"></i><span class="text-sm">–î–æ—Å—Ç–∞–≤–∫–∞</span>
            </button>
            <button data-service="cargo"
                class="service-btn btn-active service-card bg-white p-3 rounded-xl shadow-md flex flex-col items-center justify-center text-blue-900 font-semibold border-b-4 border-yellow-500">
                <i class="fas fa-truck-loading text-2xl mb-1 text-yellow-600"></i><span class="text-sm">–ì—Ä—É–∑–æ–≤–æ–π</span>
            </button>
            <button data-service="soberDriver"
                class="service-btn btn-active service-card bg-white p-3 rounded-xl shadow-md flex flex-col items-center justify-center text-blue-900 font-semibold border-b-4 border-red-500">
                <i class="fas fa-cocktail text-2xl mb-1 text-red-600"></i><span class="text-sm">–¢—Ä–µ–∑–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</span>
            </button>
            <button data-service="assistance"
                class="service-btn btn-active service-card bg-white p-3 rounded-xl shadow-md flex flex-col items-center justify-center text-blue-900 font-semibold border-b-4 border-indigo-500">
                <i class="fas fa-life-ring text-2xl mb-1 text-indigo-600"></i><span class="text-sm">–ü–æ–º–æ—â—å</span>
            </button>
        </div>

        <!-- QUICK ACTIONS -->
        <h3 class="text-xl font-bold text-center mb-4 text-white text-shadow-md border-t pt-4 border-gray-400 border-opacity-30">–ë—ã—Å—Ç—Ä—ã–µ –î–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 max-w-md mx-auto mb-8">
            <a href="https://yandex.ru/maps/org/160238038805/reviews?reviews%5BpublicId%5D=5x4vc4keeamn0f7hgeucxf0phm&utm_source=my_review&si=ah766vzxe68ndmxjc6krw802vm" target="_blank"
                class="btn-hover btn-active bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl shadow-lg transition-all compact-util-btn">
                <i class="fas fa-star text-xl mb-1"></i><span>–û—Ü–µ–Ω–∫–∞</span>
            </a>
            <a href="https://wa.me/77770649648?text=–ü—Ä–æ—à—É%20–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å%20–º–Ω–µ%20–∫–∞–∫%20–º–æ–∂–Ω–æ%20—Å–∫–æ—Ä–µ–µ!" target="_blank"
                class="btn-hover btn-active bg-orange-500 hover:bg-orange-600 text-white rounded-xl shadow-lg transition-all compact-util-btn">
                <i class="fas fa-headset text-xl mb-1"></i><span>–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</span>
            </a>
            <button onclick="showPartnerModal()" 
                class="btn-hover btn-active bg-pink-600 hover:bg-pink-700 text-white rounded-xl shadow-lg transition-all compact-util-btn">
                <i class="fas fa-handshake text-xl mb-1"></i><span>–ü–∞—Ä—Ç–Ω–µ—Ä—ã</span>
            </button>
            <button onclick="installApp()" 
                class="btn-hover btn-active bg-gray-700 hover:bg-gray-800 text-white rounded-xl shadow-lg transition-all compact-util-btn">
                <i class="fas fa-mobile-alt text-xl mb-1"></i><span>–ù–∞ —ç–∫—Ä–∞–Ω</span>
            </button>
        </div>

        <!-- PARTNER BLOCK -->
        <div class="mt-8 border-t pt-6 border-gray-400 border-opacity-30">
            <h3 class="text-xl font-bold text-center mb-4 text-white text-shadow-md">–ù–∞—à–∏–º –ü–∞—Ä—Ç–Ω–µ—Ä–∞–º: –¢–µ—Ö–û—Å–º–æ—Ç—Ä</h3>
            <div class="auction-cta p-5 rounded-2xl flex flex-col sm:flex-row items-center justify-between text-blue-900 font-extrabold transition-all duration-300 border-indigo-500 border-2">
                <div class="flex flex-col items-center sm:items-start text-center sm:text-left mb-3 sm:mb-0">
                    <i class="fas fa-wrench text-3xl mb-1 text-red-600"></i>
                    <span class="text-xl block leading-tight font-black text-red-600">–¢–ï–•–û–°–ú–û–¢–† –í –ë–ï–õ–û–£–°–û–í–ö–ï!</span>
                    <span class="text-sm text-gray-700 block mt-1">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¢–û: <span class="font-bold">—É–ª. –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è, 37</span></span>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                    <a href="https://wa.me/77771383856?text=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!%20–•–æ—á—É%20–∑–∞–ø–∏—Å–∞—Ç—å—Å—è%20–Ω–∞%20–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π%20–û—Å–º–æ—Ç—Ä%20–ø–æ%20–∞–¥—Ä–µ—Å—É%20–ú–æ–ª–æ–¥–µ–∂–Ω–∞—è%2037." target="_blank"
                       class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-md text-sm whitespace-nowrap transition-all flex items-center justify-center btn-active">
                        <i class="fab fa-whatsapp mr-2"></i> WhatsApp
                    </a>
                    <a href="https://yandex.kz/navi/-/CLGK5Sli" target="_blank"
                       class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-md text-sm whitespace-nowrap transition-all flex items-center justify-center btn-active">
                        <i class="fas fa-map-marked-alt mr-2"></i> –ù–∞–≤–∏–≥–∞—Ç–æ—Ä
                    </a>
                    <a href="tel:+77771383856"
                       class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl shadow-md text-sm whitespace-nowrap transition-all flex items-center justify-center btn-active">
                        <i class="fas fa-phone-alt mr-2"></i> –ó–≤–æ–Ω–æ–∫
                    </a>
                </div>
            </div>
        </div>

        <!-- FAQ and PRICES (Simplified) -->
        <div class="mt-10 border-t pt-6 max-w-lg mx-auto border-gray-400 border-opacity-30">
            <h3 class="text-2xl font-bold text-center text-white text-shadow-md mb-6">–í–æ–ø—Ä–æ—Å—ã –∏ –¶–µ–Ω—ã</h3>
            <div id="faq-accordion" class="space-y-4">
                 <div class="bg-white rounded-xl shadow-md overflow-hidden faq-item">
                    <button class="w-full text-left p-4 flex justify-between items-center text-lg font-semibold text-gray-800 focus:outline-none" onclick="toggleAccordion('faq-1')">
                        <span>üí∞ –ö–∞–∫–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏?</span>
                        <i id="icon-faq-1" class="fas fa-chevron-down transform transition-transform duration-300"></i>
                    </button>
                    <div id="faq-1" class="hidden p-4 pt-0 text-gray-600 border-t border-gray-100 faq-item-content">
                        <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏ –ø–æ –ë–µ–ª–æ—É—Å–æ–≤–∫–µ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **700 —Ç–µ–Ω–≥–µ**.</p>
                    </div>
                </div>
                <!-- More FAQ items... -->
            </div>
        </div>
        
        <!-- DRIVER ENTRY -->
        <div class="mt-6 border-t pt-6 text-center border-gray-400 border-opacity-30">
            <h3 class="text-xl font-bold text-white text-shadow-md mb-4">–î–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π</h3>
            <button onclick="window.openModal('driverAuthModal')"
               class="inline-block bg-pink-600 hover:bg-pink-700 text-white px-8 py-3 rounded-xl text-lg font-semibold shadow-lg transition-all btn-active">
                <i class="fas fa-user-shield mr-2"></i> –ö–∞–±–∏–Ω–µ—Ç –í–æ–¥–∏—Ç–µ–ª—è
            </button>
            <p class="text-sm text-gray-300 mt-2 text-shadow-md">
                –í—Ö–æ–¥ –Ω–∞ –ª–∏–Ω–∏—é –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º.
            </p>
        </div>
        
    </main>

    <!-- BOTTOM SECTION -->
    <section class="bg-blue-700 py-6 text-center mt-10 shadow-inner">
        <h3 class="text-xl font-bold text-white mb-3">üó∫ –û—Ç–∫—Ä–æ–π—Ç–µ –Ø–Ω–¥–µ–∫—Å.–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</h3>
        <a href="https://yandex.kz/navi" target="_blank"
            class="inline-block bg-yellow-400 hover:bg-yellow-500 text-blue-900 px-8 py-3 rounded-xl text-lg font-semibold shadow-lg transition-all btn-active">
            <i class="fas fa-location-arrow mr-2"></i> –û—Ç–∫—Ä—ã—Ç—å –ù–∞–≤–∏–≥–∞—Ç–æ—Ä
        </a>
    </section>

    <!-- FOOTER -->
    <footer class="bg-gray-900 text-white text-center py-6 mt-10 shadow-inner">
        <p class="text-sm px-4"><span class="font-bold">¬© 2025 ¬´–£—Å–ø–µ—Ö –¢–∞–∫—Å–∏¬ª</span>.</p>
    </footer>

    <!-- 12. CLIENT TRACKING MODAL (NEW) -->
    <div id="clientTrackingModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6 text-center">
                <div class="flex justify-end">
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" onclick="window.closeTrackingModal()">√ó</button>
                </div>
                
                <div id="trackingStatusContainer" class="py-4">
                    <!-- SEARCHING STATE -->
                    <div id="trackingSearching">
                        <div class="relative w-20 h-20 mx-auto mb-4">
                            <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
                            <div class="absolute inset-0 border-4 border-yellow-500 rounded-full border-t-transparent animate-spin"></div>
                            <i class="fas fa-search absolute inset-0 flex items-center justify-center text-gray-400 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª—è...</h3>
                        <p class="text-sm text-gray-500">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ. –í–æ–¥–∏—Ç–µ–ª–∏ —É–∂–µ –≤–∏–¥—è—Ç –≤–∞—à –∑–∞–∫–∞–∑.</p>
                    </div>

                    <!-- FOUND STATE -->
                    <div id="trackingFound" class="hidden">
                        <div class="w-20 h-20 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center text-green-600 animate-bounce">
                            <i class="fas fa-check text-4xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω!</h3>
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mt-4 mb-4 text-left">
                            <div class="text-xs text-gray-500 uppercase font-bold mb-1">–ö –≤–∞–º –µ–¥–µ—Ç:</div>
                            <div id="trackingDriverName" class="text-lg font-black text-gray-900">–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span id="trackingDriverCar" class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Toyota Camry</span>
                                <span id="trackingDriverPlate" class="bg-gray-200 text-gray-700 text-xs font-mono font-bold px-2 py-1 rounded">123 ABC</span>
                            </div>
                        </div>
                        <button id="trackingCallBtn" onclick="window.closeTrackingModal()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md btn-active">
                            <i class="fas fa-check-circle mr-2"></i> –ü–æ–Ω—è—Ç–Ω–æ, –∂–¥—É!
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. DRIVER MODAL -->
    <div id="driverAuthModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 id="driverModalTitle" class="text-xl font-bold text-gray-800">üöñ –ö–∞–±–∏–Ω–µ—Ç –í–æ–¥–∏—Ç–µ–ª—è</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="driverAuthModal">√ó</button>
                </div>
                
                <!-- LOGIN FORM -->
                <form id="driverForm" class="space-y-4">
                    <div id="driverInputs">
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700 mb-1">–í–∞—à–µ –ò–º—è</label>
                            <input id="driverName" type="text" class="form-input-control" placeholder="–ò–≤–∞–Ω" required>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700 mb-1">–ú–∞—Ä–∫–∞ –ê–≤—Ç–æ–º–æ–±–∏–ª—è</label>
                            <input id="driverCar" type="text" class="form-input-control" placeholder="Toyota Camry" required>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium text-gray-700 mb-1">–ì–æ—Å. –ù–æ–º–µ—Ä (–¶–∏—Ñ—Ä—ã)</label>
                            <input id="driverPlate" type="text" class="form-input-control" placeholder="123" required>
                        </div>
                    </div>
                    
                    <div id="driverStatusDisplay" class="hidden p-3 rounded-lg text-center font-bold mb-2"></div>

                    <div class="grid grid-cols-1 gap-3">
                        <button type="button" id="goOnlineBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md btn-active">
                            <i class="fas fa-power-off mr-2"></i> –í–´–ô–¢–ò –ù–ê –õ–ò–ù–ò–Æ
                        </button>
                    </div>

                    <div id="driverFooterLinks" class="mt-4 pt-4 border-t text-center">
                        <p class="text-sm text-gray-500 mb-2">–ù—É–∂–µ–Ω —á–∞—Ç –∑–∞–∫–∞–∑–æ–≤?</p>
                        <a href="https://chat.whatsapp.com/Ke2bt9sD8VfCFmZ1LeEcqe" target="_blank" class="text-blue-600 underline text-sm font-semibold">–ü–µ—Ä–µ–π—Ç–∏ –≤ WhatsApp –≥—Ä—É–ø–ø—É</a>
                    </div>
                </form>

                <!-- ORDERS LIST (HIDDEN BY DEFAULT) -->
                <div id="driverOrdersContainer" class="hidden space-y-4">
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg mb-2">
                        <div class="text-sm font-bold text-gray-600">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                        <button type="button" id="goOfflineBtn" class="text-xs bg-red-100 text-red-700 px-3 py-1 rounded-full font-bold border border-red-200 hover:bg-red-200 transition">
                            <i class="fas fa-ban mr-1"></i> –£–π—Ç–∏ —Å –ª–∏–Ω–∏–∏
                        </button>
                    </div>
                    <div id="ordersList" class="space-y-3 max-h-[60vh] overflow-y-auto pb-4">
                        <div class="text-center text-gray-400 py-6">
                            <i class="fas fa-spinner animate-spin text-2xl mb-2"></i><br>
                            –ñ–¥–µ–º –∑–∞–∫–∞–∑—ã...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 2. TAXI MODAL -->
    <div id="taxiModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üöï –ó–∞–∫–∞–∑–∞—Ç—å –¢–∞–∫—Å–∏</h3>
                    <div class="flex gap-2">
                        <button onclick="window.openModal('historyModal'); window.renderOrderHistory();" class="text-gray-400 hover:text-blue-600 text-2xl" title="–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è"><i class="fas fa-list-alt"></i></button>
                        <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="taxiModal">√ó</button>
                    </div>
                </div>
                <form id="taxiForm" class="space-y-4">
                    <div id="addressInputsTaxi">
                        <div class="flex flex-col">
                            <label for="taxiFrom" class="text-sm font-medium text-gray-700 mb-1">–û—Ç–∫—É–¥–∞ (–∞–¥—Ä–µ—Å) *</label>
                            <div class="input-with-plus-btn">
                                <input id="taxiFrom" name="from" type="text" list="fromHistory" autocomplete="off" class="form-input-control" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º" required oninput="updateTaxiPrice()">
                                <datalist id="fromHistory"></datalist>
                                <button type="button" onclick="getCurrentLocation('taxi')" class="geo-btn btn-active"><i id="taxiGeoIcon" class="fas fa-compass"></i></button>
                            </div>
                            <div id="taxiHistoryChips" class="history-chips-container mt-2"></div>
                        </div>
                        <div class="relative flex justify-center -my-3 z-10">
                             <button type="button" onclick="swapTaxiAddresses()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-full p-2 shadow-md border border-white transition transform hover:rotate-180 focus:outline-none btn-active">
                                <i class="fas fa-exchange-alt rotate-90"></i>
                             </button>
                        </div>
                        <div class="flex flex-col">
                            <label for="taxiTo" class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞ (–∞–¥—Ä–µ—Å) *</label>
                            <div class="input-with-plus-btn">
                                <input id="taxiTo" name="to" type="text" list="toHistory" autocomplete="off" class="form-input-control" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º" required oninput="updateTaxiPrice()">
                                <datalist id="toHistory"></datalist>
                                <button type="button" onclick="addStop('additionalStops', 'taxi')" class="add-stop-btn btn-active"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="additionalStops" class="mt-2 space-y-2" oninput="updateTaxiPrice()"></div>
                        </div>
                    </div>
                    
                    <div class="border border-blue-200 rounded-lg overflow-hidden">
                        <button type="button" onclick="togglePreorder()" class="w-full p-3 bg-blue-50 flex justify-between items-center text-left focus:outline-none btn-active">
                            <span class="text-sm font-bold text-blue-700 flex items-center"><i class="fas fa-calendar-alt mr-2"></i> –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</span>
                            <i id="preorderIcon" class="fas fa-chevron-down text-blue-500 transition-transform duration-300"></i>
                        </button>
                        <div id="preorderContent" class="hidden p-3 bg-white border-t border-blue-100 space-y-3">
                            <div class="flex flex-col">
                                <label class="text-xs font-medium text-gray-600 mb-1">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                                <input id="taxiDateTime" name="dateTime" type="datetime-local" class="form-input-control">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-medium text-gray-600 mb-1">–ü–æ–∂–µ–ª–∞–Ω–∏—è</label>
                                <textarea id="taxiWishes" name="wishes" rows="2" class="form-input-control"></textarea>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <button type="button" onclick="addWish('–î–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border">üë∂ –î–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ</button>
                                    <button type="button" onclick="addWish('–ü—É—Å—Ç–æ–π –±–∞–≥–∞–∂–Ω–∏–∫')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border">üß≥ –ü—É—Å—Ç–æ–π –±–∞–≥–∞–∂–Ω–∏–∫</button>
                                    <button type="button" onclick="addWish('–° –∂–∏–≤–æ—Ç–Ω—ã–º')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border">üêï –° –∂–∏–≤–æ—Ç–Ω—ã–º</button>
                                    <button type="button" onclick="addWish('–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border">‚ùÑÔ∏è –ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col">
                        <label for="passengerPhone" class="text-sm font-medium text-gray-700 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–≤—è–∑–∏)</label>
                        <input id="passengerPhone" name="passengerPhone" type="tel" class="form-input-control" placeholder="+7 (___) ___-__-__" required>
                    </div>

                    <div id="taxiStatus" class="status-message p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>

                    <div class="pt-4 border-t mt-6 flex justify-between items-center">
                        <div>
                            <div class="price-note">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞:</div>
                            <div id="taxiPriceEstimate" class="price-estimate">–æ—Ç 700‚Äì900 —Ç–≥</div>
                        </div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 btn-active">–ó–∞–∫–∞–∑–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 3. AUCTION MODAL -->
    <div id="auctionModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üî® –ê—É–∫—Ü–∏–æ–Ω</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="auctionModal">√ó</button>
                </div>
                <form id="auctionForm" class="space-y-4">
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">–û—Ç–∫—É–¥–∞</label>
                        <div class="input-with-plus-btn">
                            <input id="auctionFrom" name="from" type="text" class="form-input-control" required>
                            <button type="button" onclick="getCurrentLocation('auction')" class="geo-btn btn-active"><i id="auctionGeoIcon" class="fas fa-compass"></i></button>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞</label>
                        <input id="auctionTo" name="to" type="text" class="form-input-control" required>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">–í–∞—à–∞ —Ü–µ–Ω–∞ (—Ç–≥)</label>
                        <input id="auctionPrice" name="price" type="number" min="500" class="form-input-control" required>
                    </div>
                    <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 4. SERVICES MENU MODAL (–ú–ï–ù–Æ –£–°–õ–£–ì) -->
    <div id="servicesMenuModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üì± –ú–µ–Ω—é –£—Å–ª—É–≥</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="servicesMenuModal">√ó</button>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="window.closeModal('servicesMenuModal'); window.openModal('taxiModal');" class="p-4 bg-blue-50 rounded-xl flex items-center space-x-4 hover:bg-blue-100 transition w-full text-left">
                         <div class="bg-blue-500 text-white p-3 rounded-full"><i class="fas fa-taxi"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–¢–∞–∫—Å–∏ (–ü–∞—Å—Å–∞–∂–∏—Ä—Å–∫–æ–µ)</div>
                             <div class="text-xs text-gray-600">–ü–æ –≥–æ—Ä–æ–¥—É –∏ –º–µ–∂–≥–æ—Ä–æ–¥</div>
                         </div>
                    </button>
                    <button onclick="window.closeModal('servicesMenuModal'); window.openModal('deliveryModal');" class="p-4 bg-green-50 rounded-xl flex items-center space-x-4 hover:bg-green-100 transition w-full text-left">
                         <div class="bg-green-500 text-white p-3 rounded-full"><i class="fas fa-box-open"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–î–æ—Å—Ç–∞–≤–∫–∞</div>
                             <div class="text-xs text-gray-600">–ü—Ä–æ–¥—É–∫—Ç—ã, –ø–æ—Å—ã–ª–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
                         </div>
                    </button>
                    <button onclick="window.closeModal('servicesMenuModal'); window.openModal('cargoModal');" class="p-4 bg-yellow-50 rounded-xl flex items-center space-x-4 hover:bg-yellow-100 transition w-full text-left">
                         <div class="bg-yellow-500 text-white p-3 rounded-full"><i class="fas fa-truck"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–ì—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏</div>
                             <div class="text-xs text-gray-600">–ì–∞–∑–µ–ª—å, –ø–µ—Ä–µ–µ–∑–¥—ã</div>
                         </div>
                    </button>
                    <button onclick="window.closeModal('servicesMenuModal'); window.openModal('soberDriverModal');" class="p-4 bg-red-50 rounded-xl flex items-center space-x-4 hover:bg-red-100 transition w-full text-left">
                         <div class="bg-red-500 text-white p-3 rounded-full"><i class="fas fa-cocktail"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–¢—Ä–µ–∑–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</div>
                             <div class="text-xs text-gray-600">–ü–µ—Ä–µ–≥–æ–Ω –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ</div>
                         </div>
                    </button>
                    <button onclick="window.closeModal('servicesMenuModal'); window.openModal('assistanceModal');" class="p-4 bg-indigo-50 rounded-xl flex items-center space-x-4 hover:bg-indigo-100 transition w-full text-left">
                         <div class="bg-indigo-500 text-white p-3 rounded-full"><i class="fas fa-life-ring"></i></div>
                         <div>
                             <div class="font-bold text-gray-800">–ü–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–µ</div>
                             <div class="text-xs text-gray-600">–ü—Ä–∏–∫—É—Ä–∏—Ç—å, –±—É–∫—Å–∏—Ä, –∑–∞–º–µ–Ω–∞ –∫–æ–ª–µ—Å–∞</div>
                         </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. DELIVERY MODAL -->
    <div id="deliveryModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="deliveryModal">√ó</button>
                </div>
                <form id="deliveryForm" class="space-y-4">
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ß—Ç–æ –∫—É–ø–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å?</label>
                         <input id="delWhat" type="text" class="form-input-control" placeholder="–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å—ã–ª–∫–∏" required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–û—Ç–∫—É–¥–∞ (–ú–∞–≥–∞–∑–∏–Ω/–ê–¥—Ä–µ—Å)</label>
                         <input id="delFrom" type="text" class="form-input-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å" required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞ –≤–µ–∑—Ç–∏</label>
                         <input id="delTo" type="text" class="form-input-control" placeholder="–í–∞—à –∞–¥—Ä–µ—Å" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–ó–∞–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 6. CARGO MODAL -->
    <div id="cargoModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üöö –ì—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="cargoModal">√ó</button>
                </div>
                <form id="cargoForm" class="space-y-4">
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ß—Ç–æ –≤–µ–∑–µ–º?</label>
                         <input id="cargoWhat" type="text" class="form-input-control" placeholder="–ú–µ–±–µ–ª—å, —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø–µ—Ä–µ–µ–∑–¥..." required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–û—Ç–∫—É–¥–∞</label>
                         <input id="cargoFrom" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å –∑–∞–≥—Ä—É–∑–∫–∏" required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞</label>
                         <input id="cargoTo" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å –≤—ã–≥—Ä—É–∑–∫–∏" required>
                    </div>
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–ó–∞–∫–∞–∑–∞—Ç—å –ì–∞–∑–µ–ª—å</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 7. SOBER DRIVER MODAL -->
    <div id="soberDriverModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üç∑ –¢—Ä–µ–∑–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="soberDriverModal">√ó</button>
                </div>
                <form id="soberDriverForm" class="space-y-4">
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ì–¥–µ –º–∞—à–∏–Ω–∞?</label>
                         <input id="soberFrom" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å, –≥–¥–µ —Å—Ç–æ–∏—Ç –≤–∞—à–µ –∞–≤—Ç–æ" required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞ –µ–¥–µ–º?</label>
                         <input id="soberTo" type="text" class="form-input-control" placeholder="–ö–æ–Ω–µ—á–Ω—ã–π –∞–¥—Ä–µ—Å" required>
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–í—ã–∑–≤–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 8. ASSISTANCE MODAL -->
    <div id="assistanceModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üÜò –ü–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–µ</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="assistanceModal">√ó</button>
                </div>
                <form id="assistanceForm" class="space-y-4">
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?</label>
                         <input id="assistWhat" type="text" class="form-input-control" placeholder="–°–µ–ª –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä, –ø—Ä–æ–±–∏–ª –∫–æ–ª–µ—Å–æ..." required>
                    </div>
                    <div class="flex flex-col">
                         <label class="text-sm font-medium text-gray-700 mb-1">–ì–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?</label>
                         <input id="assistLoc" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">–í—ã–∑–≤–∞—Ç—å –ø–æ–º–æ—â—å</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 9. PARTNER MODAL -->
    <div id="partnerModal" class="modal-overlay" aria-hidden="true" role="dialog">
         <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">ü§ù –°—Ç–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="partnerModal">√ó</button>
                </div>
                <div class="text-center space-y-4">
                    <p class="text-gray-600">–•–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∞–º–∏ –∏–ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Ä–µ–∫–ª–∞–º—É?</p>
                    <a href="https://wa.me/77770649648?text=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!%20–•–æ—á—É%20—Å—Ç–∞—Ç—å%20–ø–∞—Ä—Ç–Ω–µ—Ä–æ–º." target="_blank" class="block w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 transition">
                        –ù–∞–ø–∏—Å–∞—Ç—å –≤ WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. PWA INSTALL MODAL -->
    <div id="pwaModal" class="modal-overlay" aria-hidden="true" role="dialog">
         <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="pwaModal">√ó</button>
                </div>
                <div class="space-y-4 text-sm text-gray-600">
                    <p>–ß—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ iPhone:</p>
                    <ol class="list-decimal list-inside space-y-1 ml-2">
                        <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"</strong> <i class="fas fa-share-square"></i> –≤–Ω–∏–∑—É –±—Ä–∞—É–∑–µ—Ä–∞ Safari.</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>"–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª"</strong>.</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–î–æ–±–∞–≤–∏—Ç—å"</strong>.</li>
                    </ol>
                    <p class="mt-4">–ù–∞ Android:</p>
                    <ol class="list-decimal list-inside space-y-1 ml-2">
                        <li>–ù–∞–∂–º–∏—Ç–µ —Ç—Ä–∏ —Ç–æ—á–∫–∏ –≤ —É–≥–ª—É –±—Ä–∞—É–∑–µ—Ä–∞ Chrome.</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>"–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"</strong>.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- 11. HISTORY MODAL -->
    <div id="historyModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üïí –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="historyModal">√ó</button>
                </div>
                <div id="fullHistoryContainer" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- JS MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, updateDoc, addDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBAL VARS
        let app, db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const DRIVERS_COLLECTION = 'active_drivers';
        const ORDERS_COLLECTION = 'orders';
        const LOCAL_STORAGE_HISTORY_KEY = 'taxi_address_history_v1';
        const FULL_HISTORY_KEY = 'taxi_full_orders_history';
        const PHONE_NUMBER = '77770649648';

        // INTERCITY PRICES
        const INTERCITY_PRICES = {
            "—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫": "–æ—Ç 4800‚Äì6210 —Ç–≥", "–≥–ª—É–±–æ–∫–æ–µ": "–æ—Ç 4200 —Ç–≥", "—Ä–∏–¥–¥–µ—Ä": "–æ—Ç 25300 —Ç–≥",
            "—à–µ–º–æ–Ω–∞–∏—Ö–∞": "–æ—Ç 20700 —Ç–≥", "–∞–ª—Ç–∞–π": "–æ—Ç 45540 —Ç–≥", "—É—Å—Ç—å-—Ç–∞–ª–æ–≤–∫–∞": "–æ—Ç 19780 —Ç–≥", 
            "—Å–µ–∫–∏—Å–æ–≤–∫–∞": "–æ—Ç 6440 —Ç–≥", "–Ω–æ–≤–∞—è –±—É—Ö—Ç–∞—Ä–º–∞": "–æ—Ç 24150 —Ç–≥"
        };
        
        let driverLogicInitialized = false;
        
        // --- GLOBAL ORDER MAP for Robust Button Handling ---
        window.activeOrdersMap = new Map();

        // --- AUTH & INIT ---
        async function initFirebaseAndAuth() {
            if(!firebaseConfig) return;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        syncAddressHistory();
                        initDriverLogic();
                        checkDriverStatus();
                        subscribeToDrivers();
                    } else {
                        // Retry logic or prompt could go here, but anonymous login should handle it
                        console.warn("User not authenticated yet");
                    }
                    setAddressHistory();
                });
            } catch (e) {
                console.error("Auth failed:", e);
            }
        }

        // --- DRIVER LOGIC ---
        function initDriverLogic() {
            if (driverLogicInitialized) return;
            
            const btnOnline = document.getElementById('goOnlineBtn');
            const btnOffline = document.getElementById('goOfflineBtn');

            // FIX: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Å–æ–±—ã—Ç–∏–π
            if (!btnOnline || !btnOffline) {
                return;
            }

            driverLogicInitialized = true;
            
            const ordersContainer = document.getElementById('driverOrdersContainer');
            const form = document.getElementById('driverForm');
            const modalTitle = document.getElementById('driverModalTitle');
            
            const savedDriver = JSON.parse(localStorage.getItem('taxi_driver_data') || '{}');
            if(savedDriver.name) document.getElementById('driverName').value = savedDriver.name;
            if(savedDriver.car) document.getElementById('driverCar').value = savedDriver.car;
            if(savedDriver.plate) document.getElementById('driverPlate').value = savedDriver.plate;

            btnOnline.addEventListener('click', async () => {
                const name = document.getElementById('driverName').value.trim();
                const car = document.getElementById('driverCar').value.trim();
                const plate = document.getElementById('driverPlate').value.trim();
                if(!name || !car || !plate) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!'); return; }
                if(!userId) { alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'); return; }
                
                // Show loading
                const originalText = btnOnline.innerHTML;
                btnOnline.innerHTML = '<i class="fas fa-spinner animate-spin"></i> –í–•–û–î...';
                btnOnline.disabled = true;
                
                try {
                    localStorage.setItem('taxi_driver_data', JSON.stringify({name, car, plate}));
                    // Strict Path: /artifacts/{appId}/public/data/{collectionName}
                    const driverRef = doc(db, 'artifacts', appId, 'public', 'data', DRIVERS_COLLECTION, userId);
                    await setDoc(driverRef, { name, car, plate, status: 'online', timestamp: Date.now() });
                    setDriverUI(true);
                } catch (error) {
                    console.error("Online Error:", error);
                    alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –ª–∏–Ω–∏—é: ' + error.message);
                } finally {
                    btnOnline.innerHTML = originalText;
                    btnOnline.disabled = false;
                }
            });

            btnOffline.addEventListener('click', async () => {
                if(!userId) return;
                try {
                    const driverRef = doc(db, 'artifacts', appId, 'public', 'data', DRIVERS_COLLECTION, userId);
                    await deleteDoc(driverRef);
                    setDriverUI(false);
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —É—Ö–æ–¥–∞ —Å –ª–∏–Ω–∏–∏: ' + error.message);
                }
            });
        }

        function setDriverUI(isOnline) {
            const form = document.getElementById('driverForm');
            const ordersContainer = document.getElementById('driverOrdersContainer');
            const modalTitle = document.getElementById('driverModalTitle');
            
            // FIX: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            if (!form || !ordersContainer || !modalTitle) return;

            if (isOnline) {
                form.classList.add('hidden');
                ordersContainer.classList.remove('hidden');
                modalTitle.innerHTML = 'üöñ –õ–µ–Ω—Ç–∞ –ó–∞–∫–∞–∑–æ–≤';
                subscribeToOrders();
            } else {
                form.classList.remove('hidden');
                ordersContainer.classList.add('hidden');
                modalTitle.innerHTML = 'üöñ –ö–∞–±–∏–Ω–µ—Ç –í–æ–¥–∏—Ç–µ–ª—è';
            }
        }
        
        // --- ORDER LISTENER ---
        let ordersUnsubscribe = null;
        
        function subscribeToOrders() {
            if(ordersUnsubscribe) ordersUnsubscribe(); // Clear previous
            const listEl = document.getElementById('ordersList');
            const q = collection(db, 'artifacts', appId, 'public', 'data', ORDERS_COLLECTION);
            
            ordersUnsubscribe = onSnapshot(q, (snapshot) => {
                const orders = [];
                window.activeOrdersMap.clear(); // Clear old orders from memory
                
                snapshot.forEach(d => {
                    const data = { id: d.id, ...d.data() };
                    orders.push(data);
                    window.activeOrdersMap.set(data.id, data);
                });
                
                // Sort by new, FILTER OUT accepted orders
                const pendingOrders = orders
                    .filter(o => o.status !== 'accepted')
                    .sort((a,b) => b.timestamp - a.timestamp);
                
                if (pendingOrders.length === 0) {
                    listEl.innerHTML = '<div class="text-center text-gray-400 py-6"><i class="fas fa-search text-2xl mb-2"></i><br>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
                    return;
                }
                
                listEl.innerHTML = '';
                pendingOrders.forEach(order => {
                    const el = document.createElement('div');
                    el.className = 'driver-order-card';
                    const isUrgent = order.type === 'taxi'; 
                    if (isUrgent) el.classList.add('priority');
                    
                    // IMPORTANT: Using onclick in HTML string is cleaner for dynamic lists than addEventListener inside loops
                    // which can cause binding issues upon re-renders.
                    // FIX: Pass 'this' to get exact button reference
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="driver-order-type">${order.typeLabel || '–ó–∞–∫–∞–∑'}</span>
                            <span class="text-xs text-gray-500 font-mono">${new Date(order.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="mb-2">
                            <div class="flex items-center text-gray-700 font-bold text-sm mb-1">
                                <i class="fas fa-map-marker-alt text-green-500 w-5"></i> ${order.from}
                            </div>
                            <div class="flex items-center text-gray-700 font-bold text-sm">
                                <i class="fas fa-flag-checkered text-red-500 w-5"></i> ${order.to}
                            </div>
                        </div>
                        <div class="flex justify-between items-center border-t pt-2 mt-2">
                            <div class="text-sm font-bold text-blue-600">${order.price || '–ü–æ —Ç–∞–∫—Å–æ–º–µ—Ç—Ä—É'}</div>
                            <button onclick="event.stopPropagation(); window.acceptOrderWrapper('${order.id}', this)" class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold uppercase shadow-sm hover:bg-green-700 active:scale-95 transition accept-btn">
                                –ü—Ä–∏–Ω—è—Ç—å
                            </button>
                        </div>
                        ${order.wishes ? `<div class="text-xs text-gray-500 mt-1 italic">"${order.wishes}"</div>` : ''}
                    `;
                    listEl.appendChild(el);
                });
            });
        }
        
        // --- GLOBAL WRAPPER FOR ACCEPT BUTTON ---
        window.acceptOrderWrapper = function(orderId, btnElement) {
            // FIX: Use passed element instead of activeElement which is flaky on mobile
            const order = window.activeOrdersMap.get(orderId);
            
            if(!order) {
                alert('–û—à–∏–±–∫–∞: –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–º—è—Ç–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫.');
                return;
            }
            
            acceptOrder(order, btnElement);
        }

        async function acceptOrder(order, btnElement) {
            // Check for double click
            if(btnElement && btnElement.disabled) return;
            
            if(!confirm('–ü—Ä–∏–Ω—è—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) return;
            
            // MOBILE FIX: Open window IMMEDIATELY to secure a "user gesture" token
            // This prevents popup blockers on iOS/Android from killing the WhatsApp redirect later
            const waWindow = window.open('', '_blank');
            if (waWindow) {
                waWindow.document.write(`
                    <html>
                    <body style="font-family:sans-serif;text-align:center;padding-top:50px;">
                        <h1>–û–±—Ä–∞–±–æ—Ç–∫–∞...</h1>
                        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ.</p>
                        <p>–°–æ–µ–¥–∏–Ω—è–µ–º —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö...</p>
                    </body>
                    </html>
                `);
            }

            // Show loading state on button
            const originalText = btnElement ? btnElement.innerText : '–ü—Ä–∏–Ω—è—Ç—å';
            if(btnElement) {
                btnElement.innerText = '‚è≥';
                btnElement.disabled = true;
            }

            try {
                // 1. Validation & Data Prep
                let currentUserId = userId;
                if (!currentUserId && auth.currentUser) {
                    currentUserId = auth.currentUser.uid;
                }
                
                if (!currentUserId) {
                    throw new Error("–°–∏—Å—Ç–µ–º–∞ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                }
                
                // Robustly get driver data with fallbacks for EVERYTHING to prevent DB errors
                let driverData = {};
                try {
                    driverData = JSON.parse(localStorage.getItem('taxi_driver_data') || '{}');
                } catch(e) { console.warn("Localstorage error", e); }
                
                // CRITICAL: Ensure no undefined values are passed to Firestore
                const dName = driverData.name ? String(driverData.name) : '–í–æ–¥–∏—Ç–µ–ª—å';
                const dCar = driverData.car ? String(driverData.car) : '–ú–∞—à–∏–Ω–∞';
                const dPlate = driverData.plate ? String(driverData.plate) : '---';
                
                const updatePayload = {
                    status: 'accepted',
                    driverName: dName,
                    driverCar: dCar,
                    driverPlate: dPlate,
                    driverId: String(currentUserId)
                };

                // 2. Prepare WhatsApp URL
                const msg = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–æ–¥–∏—Ç–µ–ª—å —Ç–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª (${dName}, ${dCar} ${dPlate}). –ü—Ä–∏–Ω—è–ª –≤–∞—à –∑–∞–∫–∞–∑: ${order.from} -> ${order.to}. –í—ã–µ–∑–∂–∞—é!`;
                
                // If passenger phone provided, link to them. If not, link to dispatcher (fallback)
                const phone = order.phone ? order.phone.replace(/\D/g,'') : PHONE_NUMBER; 
                const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
                
                // 3. UPDATE DB (Async operation that usually kills the popup token)
                const orderRef = doc(db, 'artifacts', appId, 'public', 'data', ORDERS_COLLECTION, order.id);
                // Use setDoc with merge to be absolutely safe against strange doc states
                await setDoc(orderRef, updatePayload, { merge: true });
                
                // 4. Redirect the pre-opened window
                if (waWindow) {
                    waWindow.location.href = url;
                } else {
                    // Fallback for desktop or strange browsers
                    window.location.href = url;
                }
                
                // Success visual (optional as item will disappear)
                if(btnElement) btnElement.innerText = '‚úÖ';
                
            } catch (e) {
                console.error("Accept Error", e);
                if (waWindow) waWindow.close(); // Close the loading window if error
                alert('–û–®–ò–ë–ö–ê –ü–†–ò–ù–Ø–¢–ò–Ø: ' + e.message + '\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
                // Revert button state if failed
                if(btnElement) {
                    btnElement.innerText = originalText;
                    btnElement.disabled = false;
                }
            }
        }

        async function checkDriverStatus() {
            if(!userId) return;
            // Strict Path Check
            const driverRef = doc(db, 'artifacts', appId, 'public', 'data', DRIVERS_COLLECTION, userId);
            try {
                const docSnap = await getDoc(driverRef);
                if (docSnap.exists()) setDriverUI(true); else setDriverUI(false);
            } catch(e) { console.warn("Driver check error", e); }
        }

        function subscribeToDrivers() {
            const container = document.getElementById('activeDriversList');
            const section = document.getElementById('activeDriversSection');
            // Strict Path Check
            const q = collection(db, 'artifacts', appId, 'public', 'data', DRIVERS_COLLECTION);
            
            onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                const drivers = [];
                snapshot.forEach((doc) => drivers.push(doc.data()));
                
                if (drivers.length > 0) {
                    section.classList.remove('hidden');
                    drivers.forEach(driver => {
                        const card = document.createElement('div');
                        card.className = 'driver-card';
                        card.innerHTML = `<div class="status-dot"></div><div><div class="font-bold text-xs leading-tight text-gray-800 dark:text-white">${driver.car}</div><div class="text-[10px] text-gray-500 font-mono bg-gray-100 dark:bg-gray-700 px-1 rounded inline-block mt-0.5">${driver.plate}</div></div>`;
                        container.appendChild(card);
                    });
                } else {
                    section.classList.add('hidden');
                }
            }, (error) => {
                console.warn("Driver list permission error", error);
                // Optionally show UI error if critical
            });
        }

        // --- OSRM & LOGIC ---
        function debounce(func, timeout = 1000){
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        async function getCoordinates(query) {
            if (query.includes('[–ì–ï–û]') || query.includes('[–ö–û–û–†–î–ò–ù–ê–¢–´]')) {
                const parts = query.match(/([\d\.]+),\s*([\d\.]+)/);
                if (parts && parts.length === 3) return { lat: parseFloat(parts[1]), lon: parseFloat(parts[2]) };
            }
            try {
                const searchQuery = `${query}, –ë–µ–ª–æ—É—Å–æ–≤–∫–∞, –í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`;
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
            } catch (e) { console.warn("Geocoding failed:", e); }
            return null;
        }

        async function getRouteDistance(coord1, coord2) {
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${coord1.lon},${coord1.lat};${coord2.lon},${coord2.lat}?overview=false`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 'Ok' && data.routes.length > 0) return data.routes[0].distance;
            } catch (e) { console.warn("Routing failed:", e); }
            return null;
        }

        async function calculateTaxiPriceOSRM() {
            const fromInput = document.getElementById('taxiFrom').value.trim();
            const toInput = document.getElementById('taxiTo').value.trim();
            const priceEl = document.getElementById('taxiPriceEstimate');
            if (fromInput.length < 3 || toInput.length < 3) return;
            priceEl.innerHTML = '<i class="fas fa-spinner animate-spin"></i> –°—á–∏—Ç–∞–µ–º...';
            const coordFrom = await getCoordinates(fromInput);
            const coordTo = await getCoordinates(toInput);
            if (coordFrom && coordTo) {
                const distMeters = await getRouteDistance(coordFrom, coordTo);
                if (distMeters !== null) {
                    const distKm = (distMeters / 1000).toFixed(1);
                    let price = 700;
                    if (distKm > 2) price += (distKm - 2) * 120;
                    price = Math.ceil(price / 10) * 10;
                    priceEl.innerText = `~${distKm} –∫–º ‚Ä¢ ${price} ‚Ç∏`;
                    return;
                }
            }
            priceEl.innerText = '–æ—Ç 700‚Äì900 —Ç–≥';
        }
        const debouncedOSRM = debounce(calculateTaxiPriceOSRM, 1500);

        // --- ADDRESS HISTORY ---
        async function loadAddresses() {
            try { return JSON.parse(localStorage.getItem(LOCAL_STORAGE_HISTORY_KEY) || '[]'); } catch (e) { return []; }
        }
        async function syncAddressHistory() {
            if (!db || !userId) return;
            try {
                const docRef = doc(db, "artifacts", appId, "users", userId, "data", "settings");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().addressHistory) {
                    localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(docSnap.data().addressHistory));
                }
            } catch (e) {}
        }
        async function saveAddress(address) {
             if (!address || address.length < 3) return;
             let history = await loadAddresses();
             history = history.filter(item => item.toLowerCase() !== address.toLowerCase());
             history.unshift(address);
             history = history.slice(0, 10);
             localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(history));
             if (db && userId) {
                 const docRef = doc(db, "artifacts", appId, "users", userId, "data", "settings");
                 setDoc(docRef, { addressHistory: history }, { merge: true }).catch(e => console.log(e));
             }
             await setAddressHistory();
        }

        async function populateDatalist(id) {
            const history = await loadAddresses();
            const el = document.getElementById(id);
            if (!el) return;
            el.innerHTML = ''; 
            history.forEach(a => { const o = document.createElement('option'); o.value = a; el.appendChild(o); });
        }
        
        async function renderHistoryChips() {
             const history = await loadAddresses();
             const c = document.getElementById('taxiHistoryChips');
             if (!c) return;
             c.innerHTML = '';
             const recent = history.slice(0, 5);
             if (recent.length === 0) { c.style.display = 'none'; return; }
             c.style.display = 'flex';
             recent.forEach(addr => {
                 const b = document.createElement('button');
                 b.className = 'history-chip btn-active';
                 b.innerHTML = `<i class="fas fa-history mr-1"></i>${addr.substring(0, 15)}`;
                 b.onclick = () => { document.getElementById('taxiFrom').value = addr; updateTaxiPrice(); };
                 c.appendChild(b);
             });
        }
        window.setAddressHistory = async function() { await populateDatalist('fromHistory'); await populateDatalist('toHistory'); await renderHistoryChips(); }

        window.renderOrderHistory = function() {
             const container = document.getElementById('fullHistoryContainer');
             const orders = JSON.parse(localStorage.getItem(FULL_HISTORY_KEY) || '[]');
             if(orders.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-10">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>'; return; }
             container.innerHTML = orders.map(order => `
                 <div class="p-3 border-b flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" onclick="window.repeatOrder('${order.from}', '${order.to}')">
                     <div class="flex-grow">
                        <div class="text-xs text-gray-500">${order.date}</div>
                        <div class="text-sm font-semibold">${order.from} -> ${order.to}</div>
                     </div>
                     <div class="text-right text-sm font-bold text-blue-600">${order.price}</div>
                 </div>`).join('');
        }
        
        window.repeatOrder = function(from, to) {
            document.getElementById('taxiFrom').value = from;
            document.getElementById('taxiTo').value = to;
            updateTaxiPrice();
            window.closeModal('historyModal');
            window.openModal('taxiModal');
        };

        // --- CLIENT TRACKING LOGIC ---
        window.closeTrackingModal = function() {
            window.closeModal('clientTrackingModal');
            if (window.clientOrderUnsubscribe) {
                window.clientOrderUnsubscribe(); // Stop listening
                window.clientOrderUnsubscribe = null;
            }
        };

        function trackOrder(orderId) {
            const modal = document.getElementById('clientTrackingModal');
            const searchUI = document.getElementById('trackingSearching');
            const foundUI = document.getElementById('trackingFound');
            
            // Reset UI
            searchUI.classList.remove('hidden');
            foundUI.classList.add('hidden');
            window.openModal('clientTrackingModal');

            // Listen to document
            const orderRef = doc(db, 'artifacts', appId, 'public', 'data', ORDERS_COLLECTION, orderId);
            window.clientOrderUnsubscribe = onSnapshot(orderRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // Deleted?
                    window.closeTrackingModal();
                    return;
                }
                
                const data = docSnap.data();
                if (data.status === 'accepted') {
                    // Show driver info
                    searchUI.classList.add('hidden');
                    foundUI.classList.remove('hidden');
                    document.getElementById('trackingDriverName').innerText = data.driverName || '–í–æ–¥–∏—Ç–µ–ª—å';
                    document.getElementById('trackingDriverCar').innerText = data.driverCar || '–ê–≤—Ç–æ';
                    document.getElementById('trackingDriverPlate').innerText = data.driverPlate || '–ù–æ–º–µ—Ä';
                }
            });
        }

        // --- GLOBAL UI ---
        window.openModal = function(id) { document.getElementById(id).classList.add('active'); }
        window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); }
        window.toggleAccordion = function(id) { const el = document.getElementById(id); el.classList.toggle('hidden'); }
        window.toggleTheme = function() { document.body.classList.toggle('dark'); }
        window.getCurrentLocation = function(t) {
             if (!navigator.geolocation) { alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
             navigator.geolocation.getCurrentPosition(p => {
                 const v = `[–ö–û–û–†–î–ò–ù–ê–¢–´] ${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`;
                 if(t === 'main') { document.getElementById('locationResult').classList.remove('hidden'); document.getElementById('locationAddress').innerText = v; }
                 else if(t === 'taxi') { document.getElementById('taxiFrom').value = v; updateTaxiPrice(); }
                 else if(t === 'auction') { document.getElementById('auctionFrom').value = v; }
             });
        }
        
        // --- PRICE UPDATE LOGIC (Restored Intercity) ---
        window.updateTaxiPrice = function() {
            const priceEl = document.getElementById('taxiPriceEstimate');
            const toInput = document.getElementById('taxiTo');
            const destination = toInput ? toInput.value.trim().toLowerCase() : '';
            
            // Check Intercity First
            const cleanDestination = destination.replace(/^(–≥\.|–≥–æ—Ä–æ–¥\s+|–ø\.|–ø–æ—Å\.|–ø–æ—Å–µ–ª–æ–∫\s+|—Å\.|—Å–µ–ª–æ\s+)/i, '').trim();
            for (const location in INTERCITY_PRICES) {
                if (cleanDestination.startsWith(location)) {
                    priceEl.textContent = INTERCITY_PRICES[location];
                    return; 
                }
            }
            // Fallback to OSRM
            debouncedOSRM();
        }
        
        window.addWish = function(text) {
            const wishEl = document.getElementById('taxiWishes');
            let currentText = wishEl.value.trim();
            if (!currentText) wishEl.value = text;
            else if (!currentText.includes(text)) wishEl.value = currentText + ', ' + text;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
             initFirebaseAndAuth();
             if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
             const pi = document.getElementById('passengerPhone');
             if (pi) IMask(pi, { mask: '+{7} (000) 000-00-00' });
             
             // --- RESTORED EVENT LISTENERS FOR MODALS ---
             
             // 1. Close buttons (X)
             document.querySelectorAll('.close-btn').forEach(btn => {
                 btn.addEventListener('click', () => {
                     const modalId = btn.getAttribute('data-modal');
                     if(modalId) window.closeModal(modalId);
                 });
             });

             // 2. Service buttons (Taxi, Delivery, etc.)
             document.querySelectorAll('[data-service]').forEach(btn => {
                 btn.addEventListener('click', () => {
                     const service = btn.getAttribute('data-service');
                     if(service) window.openModal(service + 'Modal');
                 });
             });

             // 3. Click outside to close
             document.querySelectorAll('.modal-overlay').forEach(overlay => {
                 overlay.addEventListener('click', (e) => {
                     if (e.target === overlay) {
                         window.closeModal(overlay.id);
                     }
                 });
             });
        });

        // --- HELPERS ---
        window.shareApp = function() {
            if (navigator.share) {
                navigator.share({
                    title: '–¢–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª',
                    text: '–£–¥–æ–±–Ω—ã–π –∑–∞–∫–∞–∑ —Ç–∞–∫—Å–∏ –≤ –ë–µ–ª–æ—É—Å–æ–≤–∫–µ!',
                    url: window.location.href
                }).catch(console.error);
            } else {
                alert('–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π: ' + window.location.href);
            }
        }
        
        window.swapTaxiAddresses = function() { const f = document.getElementById('taxiFrom'); const t = document.getElementById('taxiTo'); const v = f.value; f.value = t.value; t.value = v; updateTaxiPrice(); }
        window.addStop = function(id) { const c = document.getElementById(id); const i = document.createElement('input'); i.className = 'form-input-control mt-2'; i.placeholder='–î–æ–ø. –∞–¥—Ä–µ—Å'; c.appendChild(i); }
        window.togglePreorder = function() { document.getElementById('preorderContent').classList.toggle('hidden'); }
        window.openServicesMenu = function() { window.openModal('servicesMenuModal'); }
        window.installApp = function() { document.getElementById('pwaModal').classList.remove('hidden'); }
        window.showPartnerModal = function() { document.getElementById('partnerModal').classList.remove('hidden'); }
        window.dismissAnnouncement = function() { document.getElementById('announcementBar').classList.add('hidden'); }
        
        // --- RESTORED FORM SUBMISSION LOGIC ---
        document.querySelectorAll('form').forEach(f => {
            f.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formId = f.id;
                let msg = '';
                let orderData = null;
                
                // Save Addresses
                const inputs = f.querySelectorAll('input[type="text"]');
                inputs.forEach(i => saveAddress(i.value));

                if (formId === 'taxiForm') {
                    const from = document.getElementById('taxiFrom').value;
                    const to = document.getElementById('taxiTo').value;
                    const phone = document.getElementById('passengerPhone').value;
                    const wishes = document.getElementById('taxiWishes').value;
                    const date = document.getElementById('taxiDateTime').value;
                    const price = document.getElementById('taxiPriceEstimate').innerText;
                    
                    msg = `üöï –ù–û–í–´–ô –ó–ê–ö–ê–ó: –¢–ê–ö–°–ò\n\n–û—Ç–∫—É–¥–∞: ${from}\n–ö—É–¥–∞: ${to}`;
                    if(date) msg = `‚è∞ –ü–†–ï–î–ó–ê–ö–ê–ó –Ω–∞ ${date.replace('T', ' ')}\n` + msg;
                    if(phone) msg += `\nüìû –¢–µ–ª: ${phone}`;
                    if(wishes) msg += `\nüìù –ü–æ–∂–µ–ª–∞–Ω–∏—è: ${wishes}`;
                    msg += `\nüí∞ –¶–µ–Ω–∞: ${price}`;
                    
                    orderData = {
                        type: 'taxi', typeLabel: '–¢–∞–∫—Å–∏', from, to, price, wishes, phone,
                        timestamp: Date.now(),
                        status: 'pending' // Default status
                    };
                    
                    // Save history
                    const now = new Date();
                    const order = { id: Date.now(), date: now.toLocaleDateString(), time: now.toLocaleTimeString(), from, to, price };
                    let orders = JSON.parse(localStorage.getItem(FULL_HISTORY_KEY) || '[]');
                    orders.unshift(order);
                    localStorage.setItem(FULL_HISTORY_KEY, JSON.stringify(orders));
                } 
                else if (formId === 'auctionForm') {
                    const from = document.getElementById('auctionFrom').value;
                    const to = document.getElementById('auctionTo').value;
                    const price = document.getElementById('auctionPrice').value;
                    msg = `üî® –ê–£–ö–¶–ò–û–ù (–ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ü–µ–Ω—É)\n\n–û—Ç–∫—É–¥–∞: ${from}\n–ö—É–¥–∞: ${to}\nüí∞ –ü—Ä–µ–¥–ª–∞–≥–∞—é: ${price} KZT`;
                    orderData = { type: 'auction', typeLabel: '–ê—É–∫—Ü–∏–æ–Ω', from, to, price: price + ' —Ç–≥', timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'deliveryForm') {
                    const what = document.getElementById('delWhat').value;
                    const from = document.getElementById('delFrom').value;
                    const to = document.getElementById('delTo').value;
                    msg = `üì¶ –ó–ê–ö–ê–ó –î–û–°–¢–ê–í–ö–ò\n\n–ß—Ç–æ: ${what}\n–û—Ç–∫—É–¥–∞: ${from}\n–ö—É–¥–∞: ${to}`;
                    orderData = { type: 'delivery', typeLabel: '–î–æ—Å—Ç–∞–≤–∫–∞', from, to, price: '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è', wishes: what, timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'cargoForm') {
                    const what = document.getElementById('cargoWhat').value;
                    const from = document.getElementById('cargoFrom').value;
                    const to = document.getElementById('cargoTo').value;
                    msg = `üöö –ó–ê–ö–ê–ó –ì–†–£–ó–û–ü–ï–†–ï–í–û–ó–ö–ò\n\n–ß—Ç–æ: ${what}\n–û—Ç–∫—É–¥–∞: ${from}\n–ö—É–¥–∞: ${to}`;
                    orderData = { type: 'cargo', typeLabel: '–ì—Ä—É–∑', from, to, price: '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è', wishes: what, timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'soberDriverForm') {
                    const loc = document.getElementById('soberFrom').value;
                    const to = document.getElementById('soberTo').value;
                    msg = `üç∑ –¢–†–ï–ó–í–´–ô –í–û–î–ò–¢–ï–õ–¨\n\n–ì–¥–µ –º–∞—à–∏–Ω–∞: ${loc}\n–ö—É–¥–∞ –µ—Ö–∞—Ç—å: ${to}`;
                    orderData = { type: 'sober', typeLabel: '–¢—Ä–µ–∑–≤—ã–π', from: loc, to: to, price: '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è', timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'assistanceForm') {
                    const what = document.getElementById('assistWhat').value;
                    const loc = document.getElementById('assistLoc').value;
                    msg = `üÜò –ü–û–ú–û–©–¨ –ù–ê –î–û–†–û–ì–ï\n\n–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å: ${what}\n–ì–¥–µ: ${loc}`;
                     orderData = { type: 'assistance', typeLabel: '–ü–æ–º–æ—â—å', from: loc, to: '–ù–∞ –º–µ—Å—Ç–µ', price: '–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è', wishes: what, timestamp: Date.now(), status: 'pending' };
                }
                else if (formId === 'driverForm') {
                    return; 
                }

                if (msg) {
                    // MOBILE FIX: Open window IMMEDIATELY to secure a "user gesture" token
                    // This prevents popup blockers on iOS/Android from killing the WhatsApp redirect later
                    const waWindow = window.open('', '_blank');
                    if (waWindow) {
                        waWindow.document.write(`
                            <html>
                            <body style="font-family:sans-serif;text-align:center;padding-top:50px;">
                                <h1>–û–±—Ä–∞–±–æ—Ç–∫–∞...</h1>
                                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ.</p>
                                <p>–°–æ–µ–¥–∏–Ω—è–µ–º —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö...</p>
                            </body>
                            </html>
                        `);
                    }

                    // 1. Save to DB for drivers
                    let docRefId = null;
                    if(orderData && db) {
                        try {
                           const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', ORDERS_COLLECTION), orderData);
                           docRefId = docRef.id;
                        } catch(e) { console.error("DB Save Error", e); }
                    }
                    
                    // 2. Prepare URL
                    const url = `https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(msg)}`;
                    
                    // 3. Redirect the pre-opened window (or open new if failed, though likely blocked)
                    if (waWindow) {
                        waWindow.location.href = url;
                    } else {
                        // Fallback for weird cases
                        window.location.href = url;
                    }
                    
                    window.closeModal(f.closest('.modal-overlay').id);
                    f.reset();
                    
                    // 3. START TRACKING IF DB SAVE WAS SUCCESSFUL
                    if (docRefId) {
                        trackOrder(docRefId);
                    }
                }
            });
        });

    </script>
</body>
</html>
