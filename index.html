<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–¢–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª ‚Äî –ë–µ–ª–æ—É—Å–æ–≤–∫–∞</title>

    <!-- Google Analytics (–ö–û–î –ê–ö–¢–ò–í–ò–†–û–í–ê–ù: G-NMCTD2Q8R2) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NMCTD2Q8R2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-NMCTD2Q8R2');
    </script>

    <!-- PWA Settings start -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–¢–∞–∫—Å–∏ –£—Å–ø–µ—Ö">
    <meta name="theme-color" content="#1d4ed8" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/512/taxi.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/512/taxi.png">
    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%D0%A2%D0%B0%D0%BA%D1%81%D0%B8%20%D0%A3%D1%81%D0%BF%D0%B5%D1%85%22%2C%22short_name%22%3A%22%D0%A3%D1%81%D0%BF%D0%B5%D1%85%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%231d4ed8%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fimg.icons8.com%2Fcolor%2F512%2Ftaxi.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">

    <!-- Tailwind CSS & Font Awesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        html, body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        @supports (-webkit-touch-callout: none) { .header-bg { padding-top: env(safe-area-inset-top); } }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #1f2937;
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                              url('https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?q=80&w=1920&auto=format&fit=crop');
            background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat;
            padding-bottom: 90px; transition: color 0.3s; color: #1f2937; 
        }
        
        .header-bg { background: linear-gradient(135deg, rgba(245, 158, 11, 0.95) 0%, rgba(29, 78, 216, 0.95) 100%); backdrop-filter: blur(10px); transition: background 0.3s; }
        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .btn-active:active { transform: scale(0.97); }
        .service-card, .main-card, .auction-cta, .faq-item { transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s, border-color 0.3s, color 0.3s; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .service-card:hover { transform: scale(1.03); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .auction-cta { background-color: #fff; border: 2px solid #f59e0b; }
        
        @keyframes checkmark { 0% { stroke-dashoffset: 100px; } 100% { stroke-dashoffset: 0; } }
        @keyframes checkmark-circle { 0% { stroke-dashoffset: 480px; } 100% { stroke-dashoffset: 960px; } }
        .success-checkmark { width: 80px; height: 80px; margin: 0 auto; }
        .success-checkmark circle { fill: none; stroke-width: 4; stroke-miterlimit: 10; stroke: #10b981; stroke-dasharray: 480px; stroke-dashoffset: 480px; animation: checkmark-circle 0.6s ease-in-out backwards; }
        .success-checkmark path { fill: none; stroke-width: 4; stroke-linecap: round; stroke-linejoin: round; stroke: #10b981; stroke-dasharray: 100px; stroke-dashoffset: 100px; animation: checkmark 0.4s ease-in-out 0.3s backwards; }
        @keyframes blink-custom { 0%, 100% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); filter: brightness(1); } 50% { transform: scale(1.03); box-shadow: 0 0 20px rgba(59, 130, 246, 0.9); filter: brightness(1.2); } }
        .blink-btn { animation: blink-custom 1.5s infinite ease-in-out; }
        
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .status-dot.green { background-color: #10b981; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        .status-dot.yellow { background-color: #f59e0b; box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
        .status-dot.red { background-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes pulse-yellow { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        @keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        #locationBtn { padding: 10px 12px; font-size: 1rem; background-color: #e5e7eb; color: #374151; font-weight: 600; border-radius: 8px; transition: background-color 0.2s, color 0.2s; border: none; }
        #locationBtn:hover { background-color: #d1d5db; }
        .compact-util-btn { padding: 12px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; line-height: 1.2; border: none; }
        .quick-order-btn { padding-top: 12px; padding-bottom: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 700; border: none; }
        .text-shadow-md { text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; backdrop-filter: blur(4px); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform 0.3s ease, background-color 0.3s; }
        
        .form-input-control { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; box-sizing: border-box; font-size: 16px; background-color: white; }
        .form-input-control:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); outline: none; }
        .input-with-plus-btn { display: flex; align-items: center; gap: 8px; }
        .input-with-plus-btn .form-input-control { flex-grow: 1; min-width: 0; }
        .geo-btn, .add-stop-btn, .remove-stop-btn { flex-shrink: 0; width: 44px; height: 44px; color: white; border-radius: 8px; transition: background-color 0.2s, transform 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; }
        .geo-btn { background-color: #f59e0b; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.5); }
        .add-stop-btn { background-color: #10b981; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.5); }
        .remove-stop-btn { background-color: #ef4444; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.5); }
        .wish-tag { transition: all 0.2s ease; user-select: none; }
        .wish-tag:active { transform: scale(0.95); }
        
        /* History Chips */
        .history-chips-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; padding-top: 4px; scrollbar-width: none; -ms-overflow-style: none; }
        .history-chips-container::-webkit-scrollbar { width: 0; height: 0; display: none; }
        .history-chip { white-space: nowrap; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; box-shadow: none; }
        .history-chip:hover { background-color: #e5e7eb; }
        .history-chip:active { transform: scale(0.95); background-color: #d1d5db; }
        .history-chip i { margin-right: 4px; color: #9ca3af; }

        /* Dark Mode */
        .dark { background-color: #111827; color: #f3f4f6; }
        .dark .header-bg { background: linear-gradient(135deg, rgba(76, 29, 149, 0.95) 0%, rgba(16, 185, 129, 0.95) 100%); }
        .dark .main-card, .dark .service-card, .dark .auction-cta, .dark .modal, .dark #faq-accordion > div, .dark .faq-item-content { background-color: #1f2937 !important; color: #e5e7eb !important; }
        .dark .text-gray-900, .dark .text-gray-800, .dark .text-gray-700 { color: #d1d5db !important; }
        .dark .text-gray-600 { color: #9ca3af !important; }
        .dark .text-gray-500 { color: #6b7280 !important; }
        .dark .text-blue-900 { color: #93c5fd !important; }
        .dark .border-t, .dark .border, .dark .border-b { border-color: #374151 !important; }
        .dark .main-card { border-color: #059669 !important; }
        .dark .form-input-control { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        .dark .form-input-control:focus { border-color: #60a5fa; }
        .dark .geo-btn { background-color: #b45309; }
        .dark #locationBtn { background-color: #374151; color: #f3f4f6; border: 1px solid #4b5563; }
        .dark #locationBtn:hover { background-color: #4b5563; }
        .dark .bg-red-100 { background-color: #7f1d1d !important; border-color: #991b1b !important; }
        .dark .text-red-700, .dark .text-red-600 { color: #fca5a5 !important; }
        .dark .bg-blue-50 { background-color: #1e3a8a !important; border-color: #1e40af !important; }
        .dark .border-blue-100, .dark .border-blue-200 { border-color: #1e40af !important; }
        .dark .text-blue-700 { color: #bfdbfe !important; }
        .dark .history-chip { background-color: #374151; color: #d1d5db; border-color: #4b5563; }
        .dark .history-chip i { color: #6b7280; }
        .dark .history-chip:hover { background-color: #4b5563; }

        /* Split Button */
        .split-btn { display: flex; width: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .split-btn-part { flex: 1; padding: 0.75rem 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; font-size: 1.125rem; transition: background-color 0.2s, transform 0.2s; text-align: center; line-height: 1.3; cursor: pointer; border: none; }
        .split-btn-part:hover { transform: scale(1.02); }
        .split-btn-taxi { background-color: #10b981; color: white; border-right: 1px solid rgba(255, 255, 255, 0.3); }
        .split-btn-food { background-color: #ef4444; color: white; }
        .dark .split-btn-taxi { background-color: #047857; border-right: 1px solid rgba(255, 255, 255, 0.1); }
        .dark .split-btn-food { background-color: #b91c1c; }
        
        /* Bottom Bar */
        .bottom-bar-glass { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(229, 231, 235, 0.5); }
        .dark .bottom-bar-glass { background-color: rgba(17, 24, 39, 0.9); border-top: 1px solid rgba(55, 65, 81, 0.5); }
        
        /* Weather */
        .weather-widget { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; z-index: 50; }
        .weather-widget:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .weather-widget .temp { font-size: 0.7rem; font-weight: 800; color: white; line-height: 1; margin-top: 2px; }
        .weather-widget .icon { font-size: 1rem; color: #fbbf24; margin-bottom: -2px; }
        .weather-widget.cold .icon { color: #60a5fa; }
        .weather-widget.snow .icon { color: white; }
    </style>
</head>
<body class="text-gray-900 min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="header-bg text-white py-4 rounded-b-lg shadow-lg sticky top-0 z-50">
        <div class="absolute top-2 left-2">
            <div id="weatherWidget" class="weather-widget hidden btn-active" onclick="window.fetchRealWeather()">
                <div class="flex flex-col items-center">
                    <i id="weatherIcon" class="fas fa-cloud-sun icon"></i>
                    <span id="weatherTemp" class="temp">--¬∞</span>
                </div>
            </div>
        </div>
        <div class="absolute top-2 right-2">
            <button id="themeToggle" onclick="toggleTheme()" class="text-white p-2 rounded-full bg-black bg-opacity-10 hover:bg-opacity-30 transition-all focus:outline-none z-50 btn-active">
                <i id="themeIcon" class="fas fa-moon text-lg"></i>
            </button>
        </div>
        <div class="max-w-md mx-auto px-4 text-center">
            <div class="flex items-center justify-center gap-2 mb-1">
                <i class="fas fa-taxi text-2xl text-yellow-300"></i>
                <h1 class="text-2xl font-extrabold tracking-tight">–¢–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª</h1>
            </div>
            <p class="text-white text-sm opacity-90">–í–∞—à –∫–æ–º—Ñ–æ—Ä—Ç –≤ –ø–æ—Å—ë–ª–∫–µ –ë–µ–ª–æ—É—Å–æ–≤–∫–∞.</p>
        </div>
    </header>
    
    <!-- MAIN -->
    <main class="max-w-3xl mx-auto px-4 py-8 flex-grow">
        
        <!-- MAIN BLOCK -->
        <div class="max-w-md mx-auto p-4 bg-white rounded-xl shadow-xl border-t-4 border-green-500 mb-6 main-card">
            <div id="lineStatus" class="mb-3 p-3 rounded-lg text-center text-sm font-bold border hidden shadow-sm transition-all duration-500"></div>
            
            <button data-service="taxi" class="service-btn btn-hover btn-active bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold transition-all shadow-lg flex items-center justify-center space-x-2 w-full py-3 text-lg mb-3 blink-btn">
                <i class="fas fa-car-side text-lg"></i><span>–ó–∞–∫–∞–∑–∞—Ç—å Taxi</span>
            </button>
            
            <div class="split-btn mb-3">
                <button onclick="openServicesMenu('whatsapp')" class="btn-hover btn-active split-btn-part split-btn-taxi"><span>–ú–µ–Ω—é —É—Å–ª—É–≥</span></button>
                <a href="https://taxiuspeh.github.io/landing-/SHASHDVOR.html" target="_blank" class="btn-hover btn-active split-btn-part split-btn-food"><span>–ó–∞–∫–∞–∑ –ï–¥—ã</span></a>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="shareApp()" class="btn-hover btn-active bg-green-500 hover:bg-green-600 text-white rounded-xl transition-all shadow-md quick-order-btn"><i class="fas fa-share-alt mb-0.5"></i><span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span></button>
                <button onclick="openServicesMenu('telegram')" class="btn-hover btn-active bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition-all shadow-md quick-order-btn"><i class="fab fa-telegram-plane mb-0.5"></i><span>Telegram</span></button>
                <button data-service="auction" class="service-btn btn-hover btn-active bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl transition-all shadow-md quick-order-btn"><i class="fas fa-gavel mb-0.5"></i><span>–ê—É–∫—Ü–∏–æ–Ω</span></button>
            </div>
            
            <button type="button" onclick="getCurrentLocation('main')" id="locationBtn" class="w-full text-gray-700 font-semibold transition flex items-center justify-center space-x-3 shadow-inner btn-active">
                <i class="fas fa-location-arrow"></i><span id="locationBtnText">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span>
            </button>
            <p id="locationResult" class="text-xs text-center text-gray-500 mt-2 hidden">
                <a id="locationAddress" href="#" target="_blank" class="coord-link"></a>
            </p>
            
            <div class="mt-4 pt-3 border-t border-gray-100 flex justify-center space-x-6 text-gray-600">
                <div class="flex items-center space-x-1"><i class="fas fa-money-bill-wave text-xl text-green-500"></i><span class="font-semibold text-xs">–ù–∞–ª–∏—á–Ω—ã–µ</span></div>
                <div class="flex items-center space-x-1"><i class="fas fa-exchange-alt text-xl text-blue-500"></i><span class="font-semibold text-xs">–ü–µ—Ä–µ–≤–æ–¥ (Kaspi)</span></div>
            </div>
        </div>
        
        <!-- SERVICES BLOCK -->
        <h3 class="text-2xl font-bold text-center mb-6 text-white text-shadow-md border-t pt-8 mt-8 border-gray-400 border-opacity-30">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –£—Å–ª—É–≥–∏</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 max-w-md mx-auto mb-8">
            <button id="deliveryBtn" data-service="delivery" class="service-btn btn-active service-card bg-white p-3 rounded-xl shadow-md flex flex-col items-center justify-center text-blue-900 font-semibold border-b-4 border-green-500 relative overflow-hidden transition-all duration-300">
                <div id="deliveryStatusBadge" class="absolute top-2 right-2 w-3 h-3 rounded-full bg-gray-300"></div>
                <i id="deliveryIcon" class="fas fa-box-open text-2xl mb-1 text-green-600 transition-colors"></i><span class="text-sm">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                <span id="deliverySubtext" class="text-[9px] text-gray-500 font-normal mt-1 leading-tight min-h-[1.5em] block"></span>
            </button>
            <button data-service="cargo" class="service-btn btn-active service-card bg-white p-3 rounded-xl shadow-md flex flex-col items-center justify-center text-blue-900 font-semibold border-b-4 border-yellow-500">
                <i class="fas fa-truck-loading text-2xl mb-1 text-yellow-600"></i><span class="text-sm">–ì—Ä—É–∑–æ–≤–æ–π</span>
            </button>
            <button data-service="soberDriver" class="service-btn btn-active service-card bg-white p-3 rounded-xl shadow-md flex flex-col items-center justify-center text-blue-900 font-semibold border-b-4 border-red-500">
                <i class="fas fa-cocktail text-2xl mb-1 text-red-600"></i><span class="text-sm">–¢—Ä–µ–∑–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</span>
            </button>
            <button data-service="assistance" class="service-btn btn-active service-card bg-white p-3 rounded-xl shadow-md flex flex-col items-center justify-center text-blue-900 font-semibold border-b-4 border-indigo-500">
                <i class="fas fa-life-ring text-2xl mb-1 text-indigo-600"></i><span class="text-sm">–ü–æ–º–æ—â—å</span>
            </button>
        </div>
        
        <!-- QUICK ACTIONS BLOCK -->
        <h3 class="text-xl font-bold text-center mb-4 text-white text-shadow-md border-t pt-4 border-gray-400 border-opacity-30">–ë—ã—Å—Ç—Ä—ã–µ –î–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 max-w-md mx-auto mb-8">
            <a href="https://yandex.ru/maps/org/160238038805/reviews?reviews%5BpublicId%5D=5x4vc4keeamn0f7hgeucxf0phm&utm_source=my_review&si=ah766vzxe68ndmxjc6krw802vm" target="_blank" class="btn-hover btn-active bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl shadow-lg transition-all compact-util-btn"><i class="fas fa-star text-xl mb-1"></i><span>–û—Ü–µ–Ω–∫–∞</span></a>
            <a href="https://wa.me/77770649648?text=–ü—Ä–æ—à—É%20–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å%20–º–Ω–µ%20–∫–∞–∫%20–º–æ–∂–Ω–æ%20—Å–∫–æ—Ä–µ–µ!" target="_blank" class="btn-hover btn-active bg-orange-500 hover:bg-orange-600 text-white rounded-xl shadow-lg transition-all compact-util-btn"><i class="fas fa-headset text-xl mb-1"></i><span>–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</span></a>
            <button onclick="showPartnerModal()" class="btn-hover btn-active bg-pink-600 hover:bg-pink-700 text-white rounded-xl shadow-lg transition-all compact-util-btn"><i class="fas fa-handshake text-xl mb-1"></i><span>–ü–∞—Ä—Ç–Ω–µ—Ä—ã</span></button>
            <button onclick="installApp()" class="btn-hover btn-active bg-gray-700 hover:bg-gray-800 text-white rounded-xl shadow-lg transition-all compact-util-btn"><i class="fas fa-mobile-alt text-xl mb-1"></i><span>–ù–∞ —ç–∫—Ä–∞–Ω</span></button>
        </div>
        
        <!-- PARTNER INFO -->
        <div class="mt-8 border-t pt-6 border-gray-400 border-opacity-30">
             <h3 class="text-xl font-bold text-center mb-4 text-white text-shadow-md">–ù–∞—à–∏–º –ü–∞—Ä—Ç–Ω–µ—Ä–∞–º: –¢–µ—Ö–û—Å–º–æ—Ç—Ä</h3>
             <div class="auction-cta p-5 rounded-2xl flex flex-col sm:flex-row items-center justify-between text-blue-900 font-extrabold transition-all duration-300 border-indigo-500 border-2">
                <div class="flex flex-col items-center sm:items-start text-center sm:text-left mb-3 sm:mb-0">
                    <i class="fas fa-wrench text-3xl mb-1 text-red-600"></i>
                    <span class="text-xl block leading-tight font-black text-red-600">–¢–ï–•–û–°–ú–û–¢–† –í –ë–ï–õ–û–£–°–û–í–ö–ï!</span>
                    <span class="text-sm text-gray-700 block mt-1">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¢–û: <span class="font-bold">—É–ª. –ú–æ–ª–æ–¥–µ–∂–Ω–∞—è, 37</span></span>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                    <a href="https://wa.me/77771383856?text=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!%20–•–æ—á—É%20–∑–∞–ø–∏—Å–∞—Ç—å—Å—è%20–Ω–∞%20–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π%20–û—Å–º–æ—Ç—Ä" target="_blank" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-md text-sm whitespace-nowrap transition-all flex items-center justify-center btn-active"><i class="fab fa-whatsapp mr-2"></i> WhatsApp</a>
                    <a href="https://yandex.kz/navi/-/CLGK5Sli" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-md text-sm whitespace-nowrap transition-all flex items-center justify-center btn-active"><i class="fas fa-map-marked-alt mr-2"></i> –ù–∞–≤–∏–≥–∞—Ç–æ—Ä</a>
                    <a href="tel:+77771383856" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl shadow-md text-sm whitespace-nowrap transition-all flex items-center justify-center btn-active"><i class="fas fa-phone-alt mr-2"></i> –ó–≤–æ–Ω–æ–∫</a>
                </div>
            </div>
        </div>

        <!-- FAQ BLOCK WITH FULL PRICES -->
        <div class="mt-10 border-t pt-6 max-w-lg mx-auto border-gray-400 border-opacity-30">
            <h3 class="text-2xl font-bold text-center text-white text-shadow-md mb-6">–í–æ–ø—Ä–æ—Å—ã –∏ –¶–µ–Ω—ã</h3>
            <div id="faq-accordion" class="space-y-4">
                <div class="bg-white rounded-xl shadow-md overflow-hidden faq-item">
                    <button class="w-full text-left p-4 flex justify-between items-center text-lg font-semibold text-gray-800 focus:outline-none" onclick="toggleAccordion('faq-1')">
                        <span>üí∞ –ö–∞–∫–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏?</span><i id="icon-faq-1" class="fas fa-chevron-down transform transition-transform duration-300"></i>
                    </button>
                    <div id="faq-1" class="hidden p-4 pt-0 text-gray-600 border-t border-gray-100 faq-item-content">
                        <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏ –ø–æ –ë–µ–ª–æ—É—Å–æ–≤–∫–µ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **700 —Ç–µ–Ω–≥–µ**. –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ —Ç–µ–∫—É—â–µ–π –¥–æ—Ä–æ–∂–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.</p>
                    </div>
                </div>
                 <div class="bg-white rounded-xl shadow-md overflow-hidden faq-item">
                    <button class="w-full text-left p-4 flex justify-between items-center text-lg font-semibold text-gray-800 focus:outline-none" onclick="toggleAccordion('faq-4')">
                        <span>üì¶ –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —É—Å–ª—É–≥–∞ –î–æ—Å—Ç–∞–≤–∫–∏?</span><i id="icon-faq-4" class="fas fa-chevron-down transform transition-transform duration-300"></i>
                    </button>
                    <div id="faq-4" class="hidden p-4 pt-0 text-gray-600 border-t border-gray-100 faq-item-content">
                        <p>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è **–æ—Ç 1200 KZT**.</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md overflow-hidden faq-item">
                    <button class="w-full text-left p-4 flex justify-between items-center text-lg font-semibold text-gray-800 focus:outline-none" onclick="toggleAccordion('faq-2')">
                        <span>‚è∞ –ö–∞–∫–æ–π —É –≤–∞—Å –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã?</span><i id="icon-faq-2" class="fas fa-chevron-down transform transition-transform duration-300"></i>
                    </button>
                    <div id="faq-2" class="hidden p-4 pt-0 text-gray-600 border-t border-gray-100 faq-item-content">
                        <p>**–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ (24/7)**, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ —É–µ—Ö–∞—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –¥–Ω—è –∏ –Ω–æ—á–∏.</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md overflow-hidden faq-item">
                    <button class="w-full text-left p-4 flex justify-between items-center text-lg font-semibold text-gray-800 focus:outline-none" onclick="toggleAccordion('faq-3')">
                        <span>üìç –ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –ú–µ–∂–≥–æ—Ä–æ–¥ –∏ –ø—Ä–∏–≥–æ—Ä–æ–¥</span><i id="icon-faq-3" class="fas fa-chevron-down transform transition-transform duration-300"></i>
                    </button>
                    <div id="faq-3" class="hidden p-4 pt-0 text-gray-600 border-t border-gray-100 faq-item-content">
                         <p class="font-bold text-red-600 mb-2">‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¶–µ–Ω—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ!</p>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li>**–ë–∞–∑–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ:** **230 ‚Ç∏** –∑–∞ 1 –∫–º.</li>
                            <li>–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫: **4800‚Äî6210 ‚Ç∏**</li>
                            <li>–ê—ç—Ä–æ–ø–æ—Ä—Ç: **5500 ‚Ç∏**</li>
                            <li>–ó–∞—â–∏—Ç–∞: **4800 ‚Ç∏**</li>
                            <li>–ì–ª—É–±–æ–∫–æ–µ: **4200 ‚Ç∏**</li>
                            <li>–ù–æ–≤–∞—è –ë—É—Ö—Ç–∞—Ä–º–∞: **24150 ‚Ç∏**</li>
                            <li>–†–∏–¥–¥–µ—Ä: **25300 ‚Ç∏**</li>
                            <li>–®–µ–º–æ–Ω–∞–∏—Ö–∞: **20700 ‚Ç∏**</li>
                            <li>–ê–ª—Ç–∞–π (–ó—ã—Ä—è–Ω–æ–≤—Å–∫): **45540 ‚Ç∏**</li>
                            <li>–£—Å—Ç—å-–¢–∞–ª–æ–≤–∫–∞: **19780 ‚Ç∏**</li>
                            <li>–°–µ–∫–∏—Å–æ–≤–∫–∞: **6440 ‚Ç∏**</li>
                            <li>–ë–µ–ª–æ–∫–∞–º–µ–Ω–∫–∞: **3500 ‚Ç∏**</li>
                            <li>–ú–∏—Ö–∞–π–ª–æ–≤–∫–∞: **4000 ‚Ç∏**</li>
                            <li>–ü—Ä–æ–≥—Ä–µ—Å—Å: **2990‚Äî3500 ‚Ç∏**</li>
                            <li>–ß–µ—Ä–Ω–æ–≥–æ—Ä–∫–∞: **2100‚Äî3000 ‚Ç∏**</li>
                            <li>–ö—Ä–∞—Å–Ω—ã–π –ü–∞—Ä—Ç–∏–∑–∞–Ω: **1800‚Äî2500 ‚Ç∏**</li>
                            <li>–ü–ª–∞–Ω–∏–¥–æ–≤–∫–∞: **2100‚Äî2500 ‚Ç∏**</li>
                            <li>–¢–∞—Ä—Ö–∞–Ω–∫–∞: **11270‚Äî12200 ‚Ç∏**</li>
                            <li>–ü—Ä–µ–¥–≥–æ—Ä–Ω–æ–µ: **8500‚Äî10000 ‚Ç∏**</li>
                            <li>–ø–æ—Å—ë–ª–æ–∫ –ê–ª—Ç–∞–π—Å–∫–∏–π: **6000‚Äî8000 ‚Ç∏**</li>
                            <li>–ó–µ–≤–∞–∫–∏–Ω–æ: **15000 ‚Ç∏**</li>
                            <li>–û–ø—ã—Ç–Ω–æ–µ –ø–æ–ª–µ: **4800 ‚Ç∏**</li>
                            <li>–ü–µ—Ä–≤–æ–º–∞–π—Å–∫–∏–π: **12000 ‚Ç∏**</li>
                            <li>–í–µ—Ä—Ö–Ω–µ–±–µ—Ä—ë–∑–æ–≤—Å–∫–∏–π: **8500 ‚Ç∏**</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ADVERTISING BLOCK -->
        <div class="mt-10 border-t pt-6 border-gray-400 border-opacity-30">
            <h3 class="text-xl font-bold text-white text-shadow-md mb-6 text-center">üì¢ –†–µ–∫–ª–∞–º–∞ –¥–ª—è –í–∞—à–µ–≥–æ –ë–∏–∑–Ω–µ—Å–∞</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="https://wa.me/77770649648?text=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!%20–•–æ—á—É%20—Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å%20—Ä–µ–∫–ª–∞–º—É..." target="_blank" class="partner-card service-card bg-white p-4 rounded-xl shadow-lg border-pink-500 flex flex-col items-center text-center">
                    <i class="fas fa-store text-4xl text-pink-500 mb-2"></i><p class="text-lg font-bold text-gray-800">–ú–∞–≥–∞–∑–∏–Ω</p><p class="text-sm text-gray-600">–ü—Ä–∏–≤–ª–µ–∫–∞–π—Ç–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π.</p>
                </a>
                <a href="https://wa.me/77770649648?text=–ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç%20—Ä–µ–∫–ª–∞–º–∞%20–º–æ–∏—Ö%20—É—Å–ª—É–≥..." target="_blank" class="partner-card service-card bg-white p-4 rounded-xl shadow-lg border-red-500 flex flex-col items-center text-center">
                    <i class="fas fa-tools text-4xl text-red-500 mb-2"></i><p class="text-lg font-bold text-gray-800">–£—Å–ª—É–≥–∏</p><p class="text-sm text-gray-600">–ù–∞–π–¥–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>
                </a>
                <a href="https://wa.me/77770649648?text=–•–æ—á—É%20–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å%20–º–µ—Å—Ç–æ..." target="_blank" class="partner-card service-card bg-white p-4 rounded-xl shadow-lg border-yellow-600 flex flex-col items-center text-center">
                    <i class="fas fa-bullhorn text-4xl text-yellow-600 mb-2"></i><p class="text-lg font-bold text-gray-800">–ê–∫—Ü–∏—è</p><p class="text-sm text-gray-600">–°—Ä–æ—á–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏.</p>
                </a>
            </div>
        </div>
        
        <!-- DRIVERS BLOCK -->
        <div class="mt-10 border-t pt-6 text-center border-gray-400 border-opacity-30">
            <h3 class="text-2xl font-bold text-white text-shadow-md mb-4">–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –í–æ–¥–∏—Ç–µ–ª–µ–π!</h3>
            <a href="https://wa.me/77770649648?text=–•–æ—á—É%20—Å—Ç–∞—Ç—å%20–≤–æ–¥–∏—Ç–µ–ª–µ–º..." target="_blank" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl text-xl font-semibold shadow-lg transition-all btn-hover btn-active"><i class="fas fa-car-side mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ó–∞—è–≤–∫—É</a>
        </div>
         <div class="mt-6 border-t pt-6 text-center border-gray-400 border-opacity-30">
            <h3 class="text-xl font-bold text-white text-shadow-md mb-4">–î–ª—è –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</h3>
            <a href="https://chat.whatsapp.com/Ke2bt9sD8VfCFmZ1LeEcqe" target="_blank" class="inline-block bg-pink-600 hover:bg-pink-700 text-white px-8 py-3 rounded-xl text-lg font-semibold shadow-lg transition-all btn-active"><i class="fas fa-user-shield mr-2"></i> –í—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º –í–æ–¥–∏—Ç–µ–ª—è</a>
        </div>
        
    </main>
    
    <section class="bg-blue-700 py-6 text-center mt-10 shadow-inner">
        <h3 class="text-xl font-bold text-white mb-3">üó∫ –û—Ç–∫—Ä–æ–π—Ç–µ –Ø–Ω–¥–µ–∫—Å.–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</h3>
        <a href="https://yandex.kz/navi" target="_blank" class="inline-block bg-yellow-400 hover:bg-yellow-500 text-blue-900 px-8 py-3 rounded-xl text-lg font-semibold shadow-lg transition-all btn-active"><i class="fas fa-location-arrow mr-2"></i> –û—Ç–∫—Ä—ã—Ç—å –ù–∞–≤–∏–≥–∞—Ç–æ—Ä</a>
    </section>
    
    <div class="fixed bottom-0 left-0 right-0 bottom-bar-glass shadow-2xl z-40 sm:hidden">
        <div class="flex justify-around items-center h-16">
            <a href="https://wa.me/77770649648?text=–ó–∞–∫–∞–∑..." class="flex flex-col items-center text-green-600 hover:text-green-700 btn-active p-1 rounded-lg"><i class="fab fa-whatsapp text-2xl"></i><span class="text-xs mt-0.5">–ó–∞–∫–∞–∑</span></a>
            <a href="tel:+77770649648" class="flex flex-col items-center text-red-600 hover:text-red-700 btn-active p-1 rounded-lg"><i class="fas fa-phone-alt text-2xl"></i><span class="text-xs mt-0.5">–ó–≤–æ–Ω–æ–∫</span></a>
            <button onclick="installApp()" class="flex flex-col items-center text-yellow-600 hover:text-yellow-700 btn-active p-1 rounded-lg"><i class="fas fa-mobile-alt text-2xl"></i><span class="text-xs mt-0.5">–ù–∞ —ç–∫—Ä–∞–Ω</span></button>
            <a href="https://chat.whatsapp.com/Ke2bt9sD8VfCFmZ1LeEcqe" target="_blank" class="flex flex-col items-center text-pink-600 hover:text-pink-700 btn-active p-1 rounded-lg"><i class="fas fa-user-shield text-2xl"></i><span class="text-xs mt-0.5">–í–æ–¥–∏—Ç–µ–ª—å</span></a>
        </div>
    </div>
    
    <footer class="bg-gray-900 text-white text-center py-6 mt-10 shadow-inner">
        <p class="text-sm px-4">
            <span class="font-bold">¬© 2025 ¬´–£—Å–ø–µ—Ö –¢–∞–∫—Å–∏¬ª</span>. ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å.
        </p>
        <p class="text-sm mt-2">
            –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏:
            <a href="https://whatsapp.com/channel/0029VajWGmEI1rcfICmXlJ01" class="text-green-400 hover:text-green-300 underline">WhatsApp-–∫–∞–Ω–∞–ª</a>
        </p>
    </footer>

    <!-- MENUS & MODALS -->
    <div id="servicesMenuModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üìã –í—Å–µ —É—Å–ª—É–≥–∏</h3>
                    <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="servicesMenuModal">√ó</button>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="openServiceFromMenu('taxi')" class="p-4 bg-blue-50 hover:bg-blue-100 rounded-xl border border-blue-200 flex flex-col items-center text-center transition btn-active"><i class="fas fa-car-side text-2xl text-blue-600 mb-2"></i><span class="font-bold text-gray-800 text-sm">–¢–∞–∫—Å–∏</span></button>
                    <button onclick="openServiceFromMenu('auction')" class="p-4 bg-yellow-50 hover:bg-yellow-100 rounded-xl border border-yellow-200 flex flex-col items-center text-center transition btn-active"><i class="fas fa-gavel text-2xl text-yellow-600 mb-2"></i><span class="font-bold text-gray-800 text-sm">–ê—É–∫—Ü–∏–æ–Ω</span></button>
                    <button onclick="openServiceFromMenu('delivery')" class="p-4 bg-green-50 hover:bg-green-100 rounded-xl border border-green-200 flex flex-col items-center text-center transition btn-active"><i class="fas fa-box-open text-2xl text-green-600 mb-2"></i><span class="font-bold text-gray-800 text-sm">–î–æ—Å—Ç–∞–≤–∫–∞</span></button>
                    <button onclick="openServiceFromMenu('cargo')" class="p-4 bg-orange-50 hover:bg-orange-100 rounded-xl border border-orange-200 flex flex-col items-center text-center transition btn-active"><i class="fas fa-truck-loading text-2xl text-orange-600 mb-2"></i><span class="font-bold text-gray-800 text-sm">–ì—Ä—É–∑–æ–≤–æ–π</span></button>
                    <button onclick="openServiceFromMenu('soberDriver')" class="p-4 bg-red-50 hover:bg-red-100 rounded-xl border border-red-200 flex flex-col items-center text-center transition btn-active"><i class="fas fa-cocktail text-2xl text-red-600 mb-2"></i><span class="font-bold text-gray-800 text-sm">–¢—Ä–µ–∑–≤—ã–π</span></button>
                    <button onclick="openServiceFromMenu('assistance')" class="p-4 bg-indigo-50 hover:bg-indigo-100 rounded-xl border border-indigo-200 flex flex-col items-center text-center transition btn-active"><i class="fas fa-life-ring text-2xl text-indigo-600 mb-2"></i><span class="font-bold text-gray-800 text-sm">–ü–æ–º–æ—â—å</span></button>
                </div>
                <div id="servicesMenuFooter" class="border-t pt-4 text-center hidden">
                     <a href="https://t.me/TaxiUspehk" target="_blank" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow transition btn-active"><i class="fab fa-telegram-plane mr-2"></i> –ü–µ—Ä–µ–π—Ç–∏ –≤ Telegram</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TAXI MODAL -->
    <div id="taxiModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üöï –ó–∞–∫–∞–∑–∞—Ç—å –¢–∞–∫—Å–∏</h3>
                    <div class="flex gap-2">
                        <button onclick="window.openModal('historyModal'); window.renderOrderHistory();" class="text-gray-400 hover:text-blue-600 text-2xl" title="–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è"><i class="fas fa-list-alt"></i></button>
                        <button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="taxiModal">√ó</button>
                    </div>
                </div>
                <form id="taxiForm" class="space-y-4">
                    <div id="addressInputsTaxi">
                        <div class="flex flex-col">
                            <label for="taxiFrom" class="text-sm font-medium text-gray-700 mb-1">–û—Ç–∫—É–¥–∞ (–∞–¥—Ä–µ—Å) *</label>
                            <div class="input-with-plus-btn">
                                <input id="taxiFrom" name="from" type="text" list="fromHistory" autocomplete="off" class="form-input-control" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" required oninput="updateTaxiPrice()">
                                <datalist id="fromHistory"></datalist>
                                <button type="button" onclick="getCurrentLocation('taxi')" class="geo-btn btn-active" title="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"><i id="taxiGeoIcon" class="fas fa-compass"></i></button>
                            </div>
                            <div id="taxiHistoryChips" class="history-chips-container mt-2"></div>
                        </div>
                        <div class="relative flex justify-center -my-3 z-10">
                             <button type="button" onclick="swapTaxiAddresses()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-full p-2 shadow-md border border-white transition transform hover:rotate-180 focus:outline-none btn-active" title="–ü–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏"><i class="fas fa-exchange-alt rotate-90"></i></button>
                        </div>
                        <div class="flex flex-col">
                            <label for="taxiTo" class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞ (–∞–¥—Ä–µ—Å) *</label>
                            <div class="input-with-plus-btn">
                                <input id="taxiTo" name="to" type="text" list="toHistory" autocomplete="off" class="form-input-control" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º/–æ–±—ä–µ–∫—Ç (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" required oninput="updateTaxiPrice()">
                                <datalist id="toHistory"></datalist>
                                <button type="button" onclick="addStop('additionalStops', 'taxi')" class="add-stop-btn btn-active" title="–î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="additionalStops" class="mt-2 space-y-2" oninput="updateTaxiPrice()"></div>
                        </div>
                    </div>
                    <div class="border border-blue-200 rounded-lg overflow-hidden">
                        <button type="button" onclick="togglePreorder()" class="w-full p-3 bg-blue-50 flex justify-between items-center text-left focus:outline-none btn-active">
                            <span class="text-sm font-bold text-blue-700 flex items-center"><i class="fas fa-calendar-alt mr-2"></i> –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å (–ü—Ä–µ–¥–∑–∞–∫–∞–∑)</span>
                            <i id="preorderIcon" class="fas fa-chevron-down text-blue-500 transition-transform duration-300"></i>
                        </button>
                        <div id="preorderContent" class="hidden p-3 bg-white border-t border-blue-100 space-y-3">
                            <div class="flex flex-col"><label for="taxiDateTime" class="text-xs font-medium text-gray-600 mb-1">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏</label><input id="taxiDateTime" name="dateTime" type="datetime-local" class="form-input-control"></div>
                            <div class="flex flex-col"><label for="taxiWishes" class="text-xs font-medium text-gray-600 mb-1">–ü–æ–∂–µ–ª–∞–Ω–∏—è</label><textarea id="taxiWishes" name="wishes" rows="2" class="form-input-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù—É–∂–Ω–æ –¥–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ..."></textarea>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <button type="button" onclick="addWish('–î–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border hover:bg-blue-100 hover:border-blue-300 transition">üë∂ –î–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ</button>
                                    <button type="button" onclick="addWish('–ü—É—Å—Ç–æ–π –±–∞–≥–∞–∂–Ω–∏–∫')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border hover:bg-blue-100 hover:border-blue-300 transition">üß≥ –ü—É—Å—Ç–æ–π –±–∞–≥–∞–∂–Ω–∏–∫</button>
                                    <button type="button" onclick="addWish('–° –∂–∏–≤–æ—Ç–Ω—ã–º')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border hover:bg-blue-100 hover:border-blue-300 transition">üêï –° –∂–∏–≤–æ—Ç–Ω—ã–º</button>
                                    <button type="button" onclick="addWish('–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border hover:bg-blue-100 hover:border-blue-300 transition">‚ùÑÔ∏è –ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä</button>
                                    <button type="button" onclick="addWish('–°–¥–∞—á–∞ —Å 5000/10000')" class="wish-tag px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full border hover:bg-blue-100 hover:border-blue-300 transition">üíµ –°–¥–∞—á–∞</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col"><label for="passengerPhone" class="text-sm font-medium text-gray-700 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏</label><input id="passengerPhone" name="passengerPhone" type="tel" pattern="[0-9+() -]*" class="form-input-control" placeholder="+7 (XXX) XXX-XX-XX"></div>
                    <div id="taxiStatus" class="status-message p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>
                    <div class="pt-4 border-t mt-6 flex justify-between items-center">
                        <div><div class="price-note">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</div><div id="taxiPriceEstimate" class="price-estimate">-- —Ç–≥</div><div class="price-note text-red-600 font-semibold">–í–Ω–∏–º–∞–Ω–∏–µ: —Ç–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</div></div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 btn-active">–ó–∞–∫–∞–∑–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- DELIVERY MODAL -->
    <div id="deliveryModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4"><h3 class="text-xl font-bold text-gray-800">üõçÔ∏è –î–æ—Å—Ç–∞–≤–∫–∞ –¢–æ–≤–∞—Ä–æ–≤</h3><button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="deliveryModal">√ó</button></div>
                <form id="deliveryForm" class="space-y-4">
                    <div class="flex flex-col"><label for="deliveryItems" class="text-sm font-medium text-gray-700 mb-1">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ *</label><textarea id="deliveryItems" name="items" rows="3" class="form-input-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ö–ª–µ–±, –ø–∏–≤–æ..." required></textarea></div>
                    <div class="flex flex-col"><label for="deliveryStore" class="text-sm font-medium text-gray-700 mb-1">–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –º–∞–≥–∞–∑–∏–Ω—É</label><input id="deliveryStore" name="store" type="text" class="form-input-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç" /></div>
                    <div class="flex flex-col"><label for="deliveryAddress" class="text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                        <div class="input-with-plus-btn"><input id="deliveryAddress" name="address" type="text" class="form-input-control" placeholder="–ê–¥—Ä–µ—Å" required /><button type="button" onclick="getCurrentLocation('delivery')" class="geo-btn btn-active"><i id="deliveryGeoIcon" class="fas fa-compass"></i></button></div>
                    </div>
                    <div id="deliveryStatus" class="status-message p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>
                    <div class="pt-4 border-t mt-6 flex justify-between items-center">
                        <div><div class="price-note">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</div><div id="deliveryPriceEstimate" class="price-estimate">-- —Ç–≥</div></div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 btn-active">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CARGO MODAL -->
    <div id="cargoModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4"><h3 class="text-xl font-bold text-gray-800">üöö –ì—Ä—É–∑–æ–≤—ã–µ –ü–µ—Ä–µ–≤–æ–∑–∫–∏</h3><button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="cargoModal">√ó</button></div>
                <form id="cargoForm" class="space-y-4">
                    <div class="flex flex-col"><label for="cargoFrom" class="text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å –ø–æ–≥—Ä—É–∑–∫–∏ *</label><div class="input-with-plus-btn"><input id="cargoFrom" name="from" type="text" class="form-input-control" required><button type="button" onclick="getCurrentLocation('cargo')" class="geo-btn btn-active"><i id="cargoGeoIcon" class="fas fa-compass"></i></button></div></div>
                    <div class="flex flex-col"><label for="cargoTo" class="text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å –≤—ã–≥—Ä—É–∑–∫–∏ *</label><input id="cargoTo" name="to" type="text" class="form-input-control" required></div>
                    <div class="flex flex-col"><label for="cargoDescription" class="text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞ *</label><textarea id="cargoDescription" name="description" rows="2" class="form-input-control" required></textarea></div>
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-3"><p class="text-sm font-bold text-blue-700 flex items-center"><i class="fas fa-calendar-alt mr-2"></i> –ü—Ä–µ–¥–∑–∞–∫–∞–∑</p><div class="flex flex-col"><label for="cargoDateTime" class="text-xs font-medium text-gray-600 mb-1">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label><input id="cargoDateTime" name="dateTime" type="datetime-local" class="form-input-control"></div></div>
                    <div class="flex flex-col"><label for="cargoMovers" class="text-sm font-medium text-gray-700 mb-1">–ì—Ä—É–∑—á–∏–∫–∏</label><div class="input-with-plus-btn"><select id="cargoMovers" name="movers" class="form-input-control" required onchange="updateCargoPrice()"><option value="0">–ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è</option><option value="1">1 —á–µ–ª–æ–≤–µ–∫</option><option value="2">2 —á–µ–ª–æ–≤–µ–∫–∞</option></select><span class="text-sm font-bold text-red-600">(+–¥–æ–ø–ª–∞—Ç–∞)</span></div></div>
                    <div id="cargoStatus" class="status-message p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>
                    <div class="pt-4 border-t mt-6 flex justify-between items-center">
                        <div><div class="price-note">–°—Ç–æ–∏–º–æ—Å—Ç—å (–∑–∞ 1 —á–∞—Å):</div><div id="cargoTotalPrice" class="price-estimate">-- —Ç–≥</div><div id="cargoPriceNote" class="price-note font-semibold"></div></div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 btn-active">–ó–∞–∫–∞–∑–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- SOBER DRIVER MODAL -->
    <div id="soberDriverModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4"><h3 class="text-xl font-bold text-gray-800">üîë –¢—Ä–µ–∑–≤—ã–π –í–æ–¥–∏—Ç–µ–ª—å</h3><button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="soberDriverModal">√ó</button></div>
                <form id="soberDriverForm" class="space-y-4">
                    <div class="flex flex-col"><label for="soberDriverFrom" class="text-sm font-medium text-gray-700 mb-1">–ì–¥–µ –∞–≤—Ç–æ *</label><div class="input-with-plus-btn"><input id="soberDriverFrom" name="from" type="text" class="form-input-control" required><button type="button" onclick="getCurrentLocation('soberDriver')" class="geo-btn btn-active"><i id="soberDriverGeoIcon" class="fas fa-compass"></i></button></div></div>
                    <div class="flex flex-col"><label for="soberDriverCarModel" class="text-sm font-medium text-gray-700 mb-1">–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ *</label><input id="soberDriverCarModel" name="carModel" type="text" class="form-input-control" required></div>
                    <div class="flex flex-col"><label for="soberDriverTo" class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞ –≤–µ–∑—Ç–∏ *</label><input id="soberDriverTo" name="to" type="text" class="form-input-control" required></div>
                    <div id="soberDriverStatus" class="status-message p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>
                    <div class="pt-4 border-t mt-6 flex justify-between items-center">
                        <div><div class="price-note">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</div><div class="price-estimate">–æ—Ç 3800 —Ç–≥</div></div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 btn-active">–í—ã–∑–≤–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ASSISTANCE MODAL -->
    <div id="assistanceModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4"><h3 class="text-xl font-bold text-gray-800">üôã –ü–æ–º–æ—â—å</h3><button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="assistanceModal">√ó</button></div>
                <form id="assistanceForm" class="space-y-4">
                    <div class="flex flex-col"><label for="assistanceType" class="text-sm font-medium text-gray-700 mb-1">–¢–∏–ø –ø–æ–º–æ—â–∏ *</label><select id="assistanceType" name="type" class="form-input-control" required><option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option><option value="–ü–æ–¥–∫–∞—á–∞—Ç—å –∫–æ–ª–µ—Å–æ">–ü–æ–¥–∫–∞—á–∞—Ç—å –∫–æ–ª–µ—Å–æ</option><option value="–ü—Ä–∏–∫—É—Ä–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å">–ü—Ä–∏–∫—É—Ä–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option><option value="–ü—Ä–æ—á–µ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ/–ø–æ–º–æ—â—å">–ü—Ä–æ—á–µ–µ</option></select></div>
                    <div id="carDetails" class="space-y-4 p-3 bg-teal-50 rounded-lg border border-dashed border-teal-300 hidden"><div class="flex flex-col"><label for="carModel" class="text-sm font-medium text-gray-700 mb-1">–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ</label><input id="carModel" name="carModel" type="text" class="form-input-control"></div><div class="flex flex-col"><label for="licencePlate" class="text-sm font-medium text-gray-700 mb-1">–ì–æ—Å. –Ω–æ–º–µ—Ä</label><input id="licencePlate" name="licencePlate" type="text" class="form-input-control"></div></div>
                    <div class="flex flex-col"><label for="assistanceTask" class="text-sm font-medium text-gray-700 mb-1">–î–µ—Ç–∞–ª–∏</label><textarea id="assistanceTask" name="task" rows="3" class="form-input-control"></textarea></div>
                    <div class="flex flex-col"><label for="assistanceAddress" class="text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å *</label><div class="input-with-plus-btn"><input id="assistanceAddress" name="address" type="text" class="form-input-control" required /><button type="button" onclick="getCurrentLocation('assistance')" class="geo-btn btn-active"><i id="assistanceGeoIcon" class="fas fa-compass"></i></button></div></div>
                    <div id="assistanceStatus" class="status-message p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>
                    <div class="pt-4 border-t mt-6 flex justify-between items-center">
                        <div><div class="price-note">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div><div class="price-estimate">–æ—Ç 1500 —Ç–≥</div></div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 btn-active">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- AUCTION MODAL -->
    <div id="auctionModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4"><h3 class="text-xl font-bold text-gray-800">üî® –ê—É–∫—Ü–∏–æ–Ω</h3><button class="close-btn text-2xl text-gray-500 hover:text-gray-700 btn-active" data-modal="auctionModal">√ó</button></div>
                <form id="auctionForm" class="space-y-4">
                    <div id="addressInputsAuction">
                        <div class="flex flex-col"><label for="auctionFrom" class="text-sm font-medium text-gray-700 mb-1">–û—Ç–∫—É–¥–∞</label><div class="input-with-plus-btn"><input id="auctionFrom" name="from" type="text" autocomplete="off" class="form-input-control" required><button type="button" onclick="getCurrentLocation('auction')" class="geo-btn btn-active"><i id="auctionGeoIcon" class="fas fa-compass"></i></button></div></div>
                        <div class="flex flex-col"><label for="auctionTo" class="text-sm font-medium text-gray-700 mb-1">–ö—É–¥–∞ *</label><div class="input-with-plus-btn"><input id="auctionTo" name="to" type="text" autocomplete="off" class="form-input-control" required><button type="button" onclick="addStop('additionalStopsAuction', 'auction')" class="add-stop-btn btn-active"><i class="fas fa-plus"></i></button></div><div id="additionalStopsAuction" class="mt-2 space-y-2"></div></div>
                    </div>
                    <div class="flex flex-col"><label for="auctionPrice" class="text-sm font-medium text-gray-700 mb-1">–í–∞—à–∞ —Ü–µ–Ω–∞</label><input id="auctionPrice" name="price" type="number" inputmode="numeric" pattern="[0-9]*" min="500" class="form-input-control" placeholder="–ú–∏–Ω. 500 KZT" required></div>
                    <div id="auctionStatus" class="status-message p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>
                    <div class="pt-4 border-t mt-6 flex justify-between items-center">
                        <div><div class="price-estimate text-yellow-600">–ù–∞—á–Ω–∏—Ç–µ –æ—Ç 500 —Ç–≥</div></div>
                        <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 btn-active">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- HISTORY MODAL -->
    <div id="historyModal" class="modal-overlay" aria-hidden="true">
        <div class="modal">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-black text-gray-800 dark:text-white uppercase tracking-tighter">üìú –ò–°–¢–û–†–ò–Ø –ó–ê–ö–ê–ó–û–í</h3><button onclick="window.closeModal('historyModal')" class="text-2xl text-gray-400 hover:text-gray-600 btn-active">&times;</button></div>
                <div id="fullHistoryContainer" class="space-y-4 max-h-[60vh] overflow-y-auto"><div class="text-center text-gray-400 py-10">–ü–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–µ–∑–¥–æ–∫</div></div>
            </div>
        </div>
    </div>

    <!-- PWA & PARTNER MODALS -->
    <div id="pwaModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden p-4"><div class="modal"><div class="p-6"><h3 class="text-2xl font-bold mb-4 text-gray-800">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!</h3><p class="mb-4 text-gray-700">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è...</p><button onclick="document.getElementById('pwaModal').classList.add('hidden')" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg btn-active">–ü–æ–Ω—è—Ç–Ω–æ</button></div></div></div>
    <div id="partnerModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden p-4"><div class="modal"><div class="p-6"><h3 class="text-2xl font-bold mb-4 text-pink-600 flex items-center justify-center">–ü–∞—Ä—Ç–Ω–µ—Ä—ã</h3><p class="mb-4 text-gray-800">–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∫–ª–∞–º–∞...</p><button onclick="document.getElementById('partnerModal').classList.add('hidden')" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg btn-active">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

    <!-- ========================================================= -->
    <!-- JAVASCRIPT LOGIC -->
    <!-- ========================================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIGURATION START =================================
        const CONFIG = {
            PHONE_NUMBER: '77770649648',
            TAXI: {
                BASE_PRICE: 700,      // –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (–¥–æ 2 –∫–º)
                BASE_DISTANCE_KM: 2,  // –í–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–º
                PRICE_PER_KM: 120,    // –¶–µ–Ω–∞ –∑–∞ –∫–º —Å–≤–µ—Ä—Ö –Ω–æ—Ä–º—ã
                MIN_PRICE_RANGE_OFFSET: 200, // –†–∞–∑–±—Ä–æ—Å "700-900"
                MANY_STOPS_MIN: 1500, // –ï—Å–ª–∏ > 2 –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                MANY_STOPS_MAX: 2000,
                MULTIPLIERS: {
                    NIGHT: 1.3,
                    HIGH_DEMAND: 1.2,
                    SCARCE_CARS: 1.3, // "–ú–∞–ª–æ –º–∞—à–∏–Ω"
                    SNOW: 1.5,
                    EXTREME_COLD: 1.6
                }
            },
            DELIVERY: {
                BASE_PRICE: 1200
            },
            CARGO: {
                HOURLY_RATE: 6000,
                MOVER_RATE: 3000
            },
            SOBER_DRIVER: {
                MIN_PRICE: 3800
            },
            ASSISTANCE: {
                MIN_PRICE: 1500
            },
            AUCTION: {
                MIN_PRICE: 500
            },
            POPULAR_PLACES: [
                "–¶–µ–Ω—Ç—Ä (–ü–ª–æ—â–∞–¥—å)",
                "–ë–æ–ª—å–Ω–∏—Ü–∞",
                "–ê–∫–∏–º–∞—Ç",
                "–®–∫–æ–ª–∞ ‚Ññ1",
                "–®–∫–æ–ª–∞ ‚Ññ2",
                "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç",
                "–î–µ—Ç—Å–∫–∏–π —Å–∞–¥"
            ]
        };
        // === CONFIGURATION END ===================================

        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        
        let orderDestination = 'whatsapp';
        let priceMultiplier = 1; 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        const LOCAL_STORAGE_HISTORY_KEY = 'taxi_address_history_v1';
        const FULL_HISTORY_KEY = 'taxi_full_orders_history';

        const INTERCITY_RATES = [
            { keys: ["—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫", "—É—Å—Ç—å–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫", "—É–∫–∞", "oskemen"], min: 4800, max: 6210 },
            { keys: ["–∞—ç—Ä–æ–ø–æ—Ä—Ç"], min: 5500, max: 5500 },
            { keys: ["–∑–∞—â–∏—Ç–∞"], min: 4800, max: 4800 },
            { keys: ["–≥–ª—É–±–æ–∫–æ–µ"], min: 4200, max: 4200 },
            { keys: ["–Ω–æ–≤–∞—è –±—É—Ö—Ç–∞—Ä–º–∞", "–±—É—Ö—Ç–∞—Ä–º–∞"], min: 24150, max: 24150 },
            { keys: ["—Ä–∏–¥–¥–µ—Ä", "–ª–µ–Ω–∏–Ω–æ–≥–æ—Ä—Å–∫"], min: 25300, max: 25300 },
            { keys: ["—à–µ–º–æ–Ω–∞–∏—Ö–∞"], min: 20700, max: 20700 },
            { keys: ["–∞–ª—Ç–∞–π", "–∑—ã—Ä—è–Ω–æ–≤—Å–∫"], min: 45540, max: 45540 },
            { keys: ["—É—Å—Ç—å-—Ç–∞–ª–æ–≤–∫–∞", "—É—Å—Ç—å—Ç–∞–ª–æ–≤–∫–∞", "—Ç–∞–ª–æ–≤–∫–∞"], min: 19780, max: 19780 },
            { keys: ["—Å–µ–∫–∏—Å–æ–≤–∫–∞"], min: 6440, max: 6440 },
            { keys: ["–±–µ–ª–æ–∫–∞–º–µ–Ω–∫–∞"], min: 3500, max: 3500 },
            { keys: ["–º–∏—Ö–∞–π–ª–æ–≤–∫–∞"], min: 4000, max: 4000 },
            { keys: ["–ø—Ä–æ–≥—Ä–µ—Å—Å"], min: 2990, max: 3500 },
            { keys: ["—á–µ—Ä–Ω–æ–≥–æ—Ä–∫–∞"], min: 2100, max: 3000 },
            { keys: ["–∫—Ä–∞—Å–Ω—ã–π –ø–∞—Ä—Ç–∏–∑–∞–Ω", "–ø–∞—Ä—Ç–∏–∑–∞–Ω"], min: 1800, max: 2500 },
            { keys: ["–ø–ª–∞–Ω–∏–¥–æ–≤–∫–∞"], min: 2100, max: 2500 },
            { keys: ["—Ç–∞—Ä—Ö–∞–Ω–∫–∞"], min: 11270, max: 12200 },
            { keys: ["–ø—Ä–µ–¥–≥–æ—Ä–Ω–æ–µ"], min: 8500, max: 10000 },
            { keys: ["–∞–ª—Ç–∞–π—Å–∫–∏–π", "–ø–æ—Å–µ–ª–æ–∫ –∞–ª—Ç–∞–π—Å–∫–∏–π", "–ø. –∞–ª—Ç–∞–π—Å–∫–∏–π"], min: 6000, max: 8000 },
            { keys: ["–∑–µ–≤–∞–∫–∏–Ω–æ"], min: 15000, max: 15000 },
            { keys: ["–æ–ø—ã—Ç–Ω–æ–µ –ø–æ–ª–µ", "–æ–ø—ã—Ç–Ω–æ–µ"], min: 4800, max: 4800 },
            { keys: ["–ø–µ—Ä–≤–æ–º–∞–π—Å–∫–∏–π"], min: 12000, max: 12000 },
            { keys: ["–≤–µ—Ä—Ö–Ω–µ–±–µ—Ä–µ–∑–æ–≤—Å–∫–∏–π", "–≤–µ—Ä—Ö–Ω–µ–±–µ—Ä—ë–∑–æ–≤—Å–∫–∏–π"], min: 8500, max: 8500 }
        ];

        function levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        function findIntercityRate(input) {
            const cleanInput = input.trim().toLowerCase();
            if (cleanInput.length < 3) return null;
            for (const rate of INTERCITY_RATES) {
                for (const key of rate.keys) {
                    if (cleanInput.includes(key)) return rate;
                    if (key.length > 4) {
                        const dist = levenshtein(cleanInput, key);
                        if (dist <= 2) return rate;
                    }
                }
            }
            return null;
        }

        function checkShopStatus() {
            const btn = document.getElementById('deliveryBtn');
            const badge = document.getElementById('deliveryStatusBadge');
            const icon = document.getElementById('deliveryIcon');
            const subtext = document.getElementById('deliverySubtext');
            if (!btn) return;
            const now = new Date();
            const hour = now.getHours();
            if (hour >= 8 && hour < 22) {
                btn.classList.remove('opacity-60', 'grayscale');
                badge.className = 'absolute top-2 right-2 w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] animate-pulse';
                subtext.innerHTML = '<span class="text-green-600 font-bold">–û—Ç–∫—Ä—ã—Ç–æ</span>';
                icon.className = 'fas fa-box-open text-2xl mb-1 text-green-600 transition-colors';
            } else if (hour === 22) {
                btn.classList.remove('opacity-60', 'grayscale');
                badge.className = 'absolute top-2 right-2 w-3 h-3 rounded-full bg-yellow-400 shadow-[0_0_8px_rgba(250,204,21,0.6)] animate-pulse';
                subtext.innerHTML = '<span class="text-yellow-600 font-bold">–°–∫–æ—Ä–æ –∑–∞–∫—Ä—ã—Ç–∏–µ</span>';
                icon.className = 'fas fa-clock text-2xl mb-1 text-yellow-500 transition-colors';
            } else {
                btn.classList.add('opacity-60'); 
                badge.className = 'absolute top-2 right-2 w-3 h-3 rounded-full bg-red-500';
                icon.className = 'fas fa-lock text-2xl mb-1 text-gray-500 transition-colors';
                let target = new Date();
                if (hour >= 23) target.setDate(target.getDate() + 1);
                target.setHours(8, 0, 0, 0);
                const diffMs = target - now;
                if (diffMs > 0) {
                    const diffHrs = Math.floor(diffMs / 3600000);
                    const diffMins = Math.floor((diffMs % 3600000) / 60000);
                    subtext.innerHTML = `<span class="text-red-500 font-bold">–û—Ç–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑<br>${diffHrs} —á. ${diffMins} –º–∏–Ω.</span>`;
                } else {
                    subtext.innerHTML = '<span class="text-red-500 font-bold">–ó–∞–∫—Ä—ã—Ç–æ</span>';
                }
            }
        }

        let currentWeather = null;
        let weatherLastFetch = 0;
        window.fetchRealWeather = async function() {
            const now = Date.now();
            if (currentWeather && (now - weatherLastFetch < 1000 * 60 * 15)) return currentWeather;
            try {
                const url = 'https://api.open-meteo.com/v1/forecast?latitude=50.13&longitude=82.55&current_weather=true';
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.current_weather) {
                    currentWeather = data.current_weather;
                    weatherLastFetch = now;
                    updateWeatherWidgetUI(currentWeather);
                    return currentWeather;
                }
            } catch (e) { console.warn("Weather fetch failed:", e); }
            return null;
        };

        function updateWeatherWidgetUI(weather) {
            const widget = document.getElementById('weatherWidget');
            const iconEl = document.getElementById('weatherIcon');
            const tempEl = document.getElementById('weatherTemp');
            if (!widget || !weather) return;
            const temp = Math.round(weather.temperature);
            const code = weather.weathercode;
            tempEl.textContent = `${temp}¬∞`;
            widget.classList.remove('hidden');
            let iconClass = 'fa-cloud-sun'; 
            widget.classList.remove('cold', 'snow');
            if (code === 0) iconClass = 'fa-sun';
            else if (code >= 1 && code <= 3) iconClass = 'fa-cloud-sun';
            else if (code >= 45 && code <= 48) iconClass = 'fa-smog';
            else if (code >= 51 && code <= 67) iconClass = 'fa-cloud-rain';
            else if (code >= 71 && code <= 77) { iconClass = 'fa-snowflake'; widget.classList.add('snow'); }
            else if (code >= 80 && code <= 82) iconClass = 'fa-cloud-showers-heavy';
            else if (code >= 85 && code <= 86) { iconClass = 'fa-snowflake'; widget.classList.add('snow'); }
            else if (code >= 95) iconClass = 'fa-bolt';
            if (temp < -20) widget.classList.add('cold');
            iconEl.className = `fas ${iconClass} icon`;
        }

        const SIM_KEY = 'taxi_sim_state_v2'; 
        window.checkLineStatus = async function() {
            checkShopStatus();
            const weather = await window.fetchRealWeather();
            const hour = new Date().getHours();
            const statusEl = document.getElementById('lineStatus');
            let message = '';
            let style = '';
            priceMultiplier = 1; 
            let isSevereWeather = false;

            if (weather) {
                const temp = weather.temperature;
                const code = weather.weathercode;
                if (temp <= -25) {
                    message = `<i class="fas fa-temperature-low animate-pulse mr-2"></i> <b>–°–ò–õ–¨–ù–´–ô –ú–û–†–û–ó (${temp}¬∞C)</b><br>–ú–∞—à–∏–Ω –º–∞–ª–æ. –ó–∞–ø—É—Å–∫ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω. –¶–µ–Ω–∞ —É–≤–µ–ª–∏—á–µ–Ω–∞.`;
                    style = 'bg-blue-100/50 border-blue-400 text-blue-900 backdrop-blur-md dark:bg-blue-900/40 dark:border-blue-500 dark:text-blue-100'; 
                    priceMultiplier = CONFIG.TAXI.MULTIPLIERS.EXTREME_COLD;
                    isSevereWeather = true;
                }
                else if (code === 73 || code === 75 || code === 85 || code === 86) {
                    message = `<i class="fas fa-snowflake fa-spin mr-2"></i> <b>–°–ù–ï–ì–û–ü–ê–î / –ú–ï–¢–ï–õ–¨</b><br>–î–æ—Ä–æ–≥–∏ –∑–∞–º–µ—Ç–µ–Ω—ã. –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Å–ø—Ä–æ—Å.`;
                    style = 'bg-slate-100/50 border-slate-400 text-slate-900 backdrop-blur-md dark:bg-slate-800/50 dark:border-slate-500 dark:text-slate-100'; 
                    priceMultiplier = CONFIG.TAXI.MULTIPLIERS.SNOW;
                    isSevereWeather = true;
                }
            }

            if (isSevereWeather) {
                 if(statusEl) {
                    statusEl.innerHTML = message;
                    statusEl.className = `mb-3 p-4 rounded-xl border shadow-lg backdrop-blur-md transition-all duration-500 text-center text-sm font-bold ${style}`;
                    statusEl.classList.remove('hidden');
                }
                window.updateTaxiPrice();
                window.updateDeliveryPrice();
                return; 
            }

            let stored = null;
            try { stored = JSON.parse(localStorage.getItem(SIM_KEY)); } catch(e){}
            let cars = 0;
            let targetMin = 0, targetMax = 0;
            if (hour >= 0 && hour < 6) { targetMin = 0; targetMax = 1; }
            else if ((hour >= 7 && hour < 10) || (hour >= 17 && hour < 20)) { targetMin = 4; targetMax = 6; }
            else { targetMin = 2; targetMax = 5; }

            const nowTime = Date.now();
            if (stored && (nowTime - stored.timestamp < 10 * 60 * 1000)) { 
                 const prevCars = stored.cars;
                 const change = Math.floor(Math.random() * 3) - 1; 
                 cars = prevCars + change;
                 if (cars < targetMin) cars = targetMin;
                 if (cars > targetMax) cars = targetMax;
            } else {
                 cars = Math.floor(Math.random() * (targetMax - targetMin + 1)) + targetMin;
            }

            localStorage.setItem(SIM_KEY, JSON.stringify({ cars, timestamp: nowTime }));
            let dotColor = 'green';
            
            if (hour >= 0 && hour < 6) {
                if (cars === 0) {
                     message = `<b>–ù–û–ß–¨: –ú–ê–®–ò–ù –ù–ï–¢</b><br><span class="font-normal text-xs opacity-90">–ü—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–∑–∞–∫–∞–∑—ã</span>`;
                     style = 'bg-slate-100/50 border-slate-400 text-slate-900 backdrop-blur-md dark:bg-slate-800/50 dark:border-slate-500 dark:text-slate-100'; 
                     priceMultiplier = CONFIG.TAXI.MULTIPLIERS.SNOW;
                     dotColor = 'red';
                } else {
                     message = `<b>–ù–ê –õ–ò–ù–ò–ò: 1 –ú–ê–®–ò–ù–ê</b><br><span class="font-normal text-xs opacity-90">–ù–æ—á–Ω–æ–π —Ç–∞—Ä–∏—Ñ. –¶–µ–Ω–∞ –≤—ã—à–µ.</span>`;
                     style = 'bg-indigo-100/50 border-indigo-400 text-indigo-900 backdrop-blur-md dark:bg-indigo-900/40 dark:border-indigo-500 dark:text-indigo-100';
                     priceMultiplier = CONFIG.TAXI.MULTIPLIERS.NIGHT;
                     dotColor = 'yellow';
                }
            }
            else if ((hour >= 7 && hour < 10) || (hour >= 17 && hour < 20)) {
                message = `<b>–í–´–°–û–ö–ò–ô –°–ü–†–û–° (${cars} –ê–í–¢–û)</b><br><span class="font-normal text-xs opacity-90">–û–∂–∏–¥–∞–Ω–∏–µ 15-20 –º–∏–Ω.</span>`;
                style = 'bg-red-100/50 border-red-400 text-red-900 backdrop-blur-md dark:bg-red-900/40 dark:border-red-500 dark:text-red-100'; 
                priceMultiplier = CONFIG.TAXI.MULTIPLIERS.HIGH_DEMAND;
                dotColor = 'red';
            }
            else {
                if (cars < 4) {
                    message = `<b>–ú–ê–õ–û –ú–ê–®–ò–ù (${cars} –ê–í–¢–û)</b><br><span class="font-normal text-xs opacity-90">–¶–µ–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–∞</span>`;
                    style = 'bg-orange-100/50 border-orange-400 text-orange-900 backdrop-blur-md dark:bg-orange-900/40 dark:border-orange-500 dark:text-orange-100';
                    priceMultiplier = CONFIG.TAXI.MULTIPLIERS.SCARCE_CARS;
                    dotColor = 'yellow';
                } else {
                    message = `<b>–°–í–û–ë–û–î–ù–´–• –ú–ê–®–ò–ù: ${cars}</b><br><span class="font-normal text-xs opacity-90">–ü–æ–¥–∞—á–∞ 5-10 –º–∏–Ω.</span>`;
                    style = 'bg-green-100/50 border-green-400 text-green-900 backdrop-blur-md dark:bg-green-900/40 dark:border-green-500 dark:text-green-100';
                    priceMultiplier = 1;
                    dotColor = 'green';
                }
            }

            if(statusEl) {
                const dotHtml = `<span class="status-dot ${dotColor}" style="animation: pulse-${dotColor} 2s infinite;"></span>`;
                statusEl.innerHTML = `<div class="flex items-center justify-center gap-3">${dotHtml} <div class="text-left leading-tight">${message}</div></div>`;
                statusEl.className = `mb-3 p-3 rounded-xl border shadow-lg backdrop-blur-md transition-all duration-500 text-center text-sm font-bold ${style}`;
                statusEl.classList.remove('hidden');
            }
            window.updateTaxiPrice();
            window.updateDeliveryPrice();
        };

        function debounce(func, timeout = 1000){
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        async function getCoordinates(query) {
            if (query.includes('[–ì–ï–û]') || query.includes('[–ö–û–û–†–î–ò–ù–ê–¢–´]')) {
                const parts = query.match(/(\d+\.\d+),\s*(\d+\.\d+)/);
                if (parts && parts.length === 3) return { lat: parseFloat(parts[1]), lon: parseFloat(parts[2]) };
            }
            try {
                const searchQuery = `${query}, –ë–µ–ª–æ—É—Å–æ–≤–∫–∞, –í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`;
                const response = await fetch(url, { headers: { 'User-Agent': 'TaxiUspehApp/1.0' } });
                const data = await response.json();
                if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
            } catch (e) { console.warn("Geocoding failed:", e); }
            return null;
        }

        async function getRouteDistance(coord1, coord2) {
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${coord1.lon},${coord1.lat};${coord2.lon},${coord2.lat}?overview=false`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 'Ok' && data.routes.length > 0) return data.routes[0].distance; 
            } catch (e) { console.warn("Routing failed:", e); }
            return null;
        }

        async function calculateTaxiPriceOSRM() {
            const fromInput = document.getElementById('taxiFrom').value.trim();
            const toInput = document.getElementById('taxiTo').value.trim();
            const priceEl = document.getElementById('taxiPriceEstimate');
            if (fromInput.length < 3 || toInput.length < 3) return;
            priceEl.innerHTML = '<i class="fas fa-spinner animate-spin"></i> –°—á–∏—Ç–∞–µ–º...';
            const coordFrom = await getCoordinates(fromInput);
            const coordTo = await getCoordinates(toInput);
            if (coordFrom && coordTo) {
                const distMeters = await getRouteDistance(coordFrom, coordTo);
                if (distMeters !== null) {
                    const distKm = (distMeters / 1000).toFixed(1);
                    let price = CONFIG.TAXI.BASE_PRICE;
                    if (distKm > CONFIG.TAXI.BASE_DISTANCE_KM) {
                        price += (distKm - CONFIG.TAXI.BASE_DISTANCE_KM) * CONFIG.TAXI.PRICE_PER_KM;
                    }
                    price = price * priceMultiplier;
                    price = Math.ceil(price / 10) * 10;
                    priceEl.innerText = `~${distKm} –∫–º ‚Ä¢ ${price} ‚Ç∏`;
                    return;
                }
            }
            const addressCount = countFilledAddresses();
            let baseMin = (addressCount >= 3) ? CONFIG.TAXI.MANY_STOPS_MIN : CONFIG.TAXI.BASE_PRICE;
            let baseMax = (addressCount >= 3) ? CONFIG.TAXI.MANY_STOPS_MAX : (CONFIG.TAXI.BASE_PRICE + CONFIG.TAXI.MIN_PRICE_RANGE_OFFSET);
            baseMin = Math.ceil((baseMin * priceMultiplier) / 10) * 10;
            baseMax = Math.ceil((baseMax * priceMultiplier) / 10) * 10;
            priceEl.innerText = `–æ—Ç ${baseMin}‚Äì${baseMax} —Ç–≥`;
        }
        
        const debouncedOSRM = debounce(calculateTaxiPriceOSRM, 1500);

        async function initFirebaseAndAuth() {
            if (!firebaseConfig) return;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; syncAddressHistory(); } 
                    setAddressHistory();
                });
            } catch (error) { console.error(error); setAddressHistory(); }
        }
        
        const ADDRESS_HISTORY_DOC_PATH = "settings";
        const ADDRESS_HISTORY_FIELD = "addressHistory";

        async function loadAddresses() {
            let localData = [];
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_HISTORY_KEY);
                if (stored) localData = JSON.parse(stored);
            } catch (e) {}
            return localData; 
        }
        
        async function syncAddressHistory() {
            if (!db || !userId) return;
            try {
                const docRef = doc(db, "artifacts", appId, "users", userId, "data", ADDRESS_HISTORY_DOC_PATH);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const cloudData = docSnap.data()[ADDRESS_HISTORY_FIELD] || [];
                    if (cloudData.length > 0) {
                        localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(cloudData));
                        setAddressHistory();
                    }
                }
            } catch (e) {}
        }

        async function saveAddress(address) {
            if (!address || address.includes('[–ö–û–û–†–î–ò–ù–ê–¢–´]') || address.length < 3) return;
            let history = [];
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_HISTORY_KEY);
                if (stored) history = JSON.parse(stored);
            } catch(e) {}
            history = history.filter(item => item.toLowerCase() !== address.toLowerCase());
            history.unshift(address);
            history = history.slice(0, 10);
            localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(history));

            if (db && userId) {
                 const docRef = doc(db, "artifacts", appId, "users", userId, "data", ADDRESS_HISTORY_DOC_PATH);
                 setDoc(docRef, { [ADDRESS_HISTORY_FIELD]: history }, { merge: true }).catch(e => console.log(e));
            }
            await setAddressHistory();
        }

        window.saveOrderToFullHistory = function(from, to, price) {
            const now = new Date();
            const order = {
                id: Date.now(),
                date: now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }),
                time: now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                from: from,
                to: to,
                price: price
            };
            let orders = JSON.parse(localStorage.getItem(FULL_HISTORY_KEY) || '[]');
            orders.unshift(order);
            if(orders.length > 50) orders = orders.slice(0, 50);
            localStorage.setItem(FULL_HISTORY_KEY, JSON.stringify(orders));
        };

        // === UPDATED POPULATE DATALIST (SMART SUGGESTIONS) ===
        async function populateDatalist(datalistId) {
            const historyArray = await loadAddresses();
            const datalist = document.getElementById(datalistId);
            if (!datalist) return;
            datalist.innerHTML = ''; 
            
            if (historyArray.length === 0) {
                // If history is empty, show popular places from CONFIG
                CONFIG.POPULAR_PLACES.forEach(place => {
                    const option = document.createElement('option');
                    option.value = place;
                    datalist.appendChild(option);
                });
            } else {
                // Show history
                historyArray.forEach(address => {
                    const option = document.createElement('option');
                    option.value = address;
                    datalist.appendChild(option);
                });
            }
        }
        
        async function renderHistoryChips() {
            const historyArray = await loadAddresses();
            const container = document.getElementById('taxiHistoryChips');
            if (!container) return;
            container.innerHTML = '';
            const recent = historyArray.slice(0, 5);
            if (recent.length === 0) {
                 container.style.display = 'none';
                 return;
            } else {
                 container.style.display = 'flex';
            }
            recent.forEach(addr => {
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.className = 'history-chip btn-active';
                const displayAddr = addr.length > 20 ? addr.substring(0, 20) + '...' : addr;
                chip.innerHTML = `<i class="fas fa-history"></i> ${displayAddr}`;
                chip.onclick = () => fillAddressFromChip(addr);
                container.appendChild(chip);
            });
        }
        
        window.fillAddressFromChip = function(address) {
            const fromInput = document.getElementById('taxiFrom');
            const toInput = document.getElementById('taxiTo');
            if (!fromInput.value) fromInput.value = address;
            else if (!toInput.value) toInput.value = address;
            else toInput.value = address;
            updateTaxiPrice();
            if (navigator.vibrate) navigator.vibrate(10);
        }
        
        window.setAddressHistory = async function() {
             await populateDatalist('fromHistory');
             await populateDatalist('toHistory');
             await renderHistoryChips();
        }
        
        window.renderOrderHistory = function() {
            const container = document.getElementById('fullHistoryContainer');
            const orders = JSON.parse(localStorage.getItem(FULL_HISTORY_KEY) || '[]');
            if(orders.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫ –ø—É—Å—Ç–∞</div>';
                return;
            }
            container.innerHTML = orders.map(order => `
                <div class="p-3 border-b flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" onclick="window.repeatOrder('${order.from}', '${order.to}')">
                    <div class="flex-grow">
                        <div class="text-xs text-gray-400 font-bold mb-1">${order.date} –≤ ${order.time}</div>
                        <div class="text-sm font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                            <i class="far fa-dot-circle text-blue-500 text-xs"></i> ${order.from}
                        </div>
                        <div class="text-sm font-semibold text-gray-800 dark:text-white flex items-center gap-2 mt-1">
                            <i class="fas fa-map-marker-alt text-red-500 text-xs"></i> ${order.to}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-gray-900 dark:text-green-400">${order.price}</div>
                        <div class="text-[10px] text-blue-500 uppercase mt-1">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</div>
                    </div>
                </div>
            `).join('');
        };

        window.repeatOrder = function(from, to, openModalFlag = false) {
            document.getElementById('taxiFrom').value = from;
            document.getElementById('taxiTo').value = to;
            updateTaxiPrice();
            if(openModalFlag) window.openModal('taxiModal');
            else window.closeModal('historyModal');
        };

        initFirebaseAndAuth();

        window.toggleAccordion = function(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            if (!content) return;
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                if (icon) icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                if (icon) icon.classList.remove('rotate-180');
            }
        }

        const locationBtnTextEl = document.getElementById('locationBtnText');
        const locationResultEl = document.getElementById('locationResult');
        const locationAddressEl = document.getElementById('locationAddress');
        let currentGeolocatedAddress = '';

        const MODALS = {
            'taxi': { id: 'taxiModal', formId: 'taxiForm', title: '–¢–ê–ö–°–ò', prefix: 'üöï –ù–û–í–´–ô –ó–ê–ö–ê–ó: –¢–ê–ö–°–ò' },
            'delivery': { id: 'deliveryModal', formId: 'deliveryForm', title: '–î–û–°–¢–ê–í–ö–ê', prefix: 'üõçÔ∏è –ù–û–í–´–ô –ó–ê–ö–ê–ó: –î–û–°–¢–ê–í–ö–ê' },
            'cargo': { id: 'cargoModal', formId: 'cargoForm', title: '–ì–†–£–ó–û–í–û–ô', prefix: 'üöö –ù–û–í–´–ô –ó–ê–ö–ê–ó: –ì–†–£–ó–û–í–û–ô' },
            'soberDriver': { id: 'soberDriverModal', formId: 'soberDriverForm', title: '–¢–†–ï–ó–í–´–ô –í–û–î–ò–¢–ï–õ–¨', prefix: 'üîë –ù–û–í–´–ô –ó–ê–ö–ê–ó: –¢–†–ï–ó–í–´–ô –í–û–î–ò–¢–ï–õ–¨' },
            'assistance': { id: 'assistanceModal', formId: 'assistanceForm', title: '–ü–û–ú–û–©–¨', prefix: 'üôã –ù–û–í–´–ô –ó–ê–ö–ê–ó: –ü–û–ú–û–©–¨' },
            'auction': { id: 'auctionModal', formId: 'auctionForm', title: '–ê–£–ö–¶–ò–û–ù', prefix: 'üî® –ó–ê–ö–ê–ó: –ê–£–ö–¶–ò–û–ù (–¶–ï–ù–ê –ö–õ–ò–ï–ù–¢–ê)' },
        };
        const PHONE_NUMBER = CONFIG.PHONE_NUMBER; 
        const THEME_KEY = 'taxi_theme_preference';
        
        const body = document.body;
        const themeIcon = document.getElementById('themeIcon');
        
        function updateThemeIcon(theme) {
            if (themeIcon) {
                if (theme === 'dark') {
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                    themeIcon.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É';
                } else {
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                    themeIcon.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É';
                }
            }
        }
        
        function applyTheme(theme) {
            if (theme === 'dark') body.classList.add('dark');
            else body.classList.remove('dark');
            updateThemeIcon(theme);
        }

        window.toggleTheme = function() {
            const isDark = body.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem(THEME_KEY, newTheme);
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme) applyTheme(savedTheme);
            else {
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
        }

        function getFormattedCurrentTime() {
             const now = new Date();
             now.setMinutes(now.getMinutes() + 15); 
             const year = now.getFullYear();
             const month = String(now.getMonth() + 1).padStart(2, '0');
             const day = String(now.getDate()).padStart(2, '0');
             const hours = String(now.getHours()).padStart(2, '0');
             const minutes = String(now.getMinutes()).padStart(2, '0');
             return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        function initPhoneMask() {
            const phoneInput = document.getElementById('passengerPhone');
            if(phoneInput) {
                phoneInput.addEventListener('input', function (e) {
                    let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
                    if (!x[2]) { e.target.value = x[1] ? '+7' : ''; return; }
                    e.target.value = '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
                });
            }
        }
        
        document.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a')) {
                 if (navigator.vibrate) navigator.vibrate(5); 
            }
        });

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
        window.installApp = async function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
            } else {
                showPWAInstructions();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
             loadTheme(); 
             initPhoneMask(); 
             setAddressHistory(); 
             checkLineStatus(); 
             setInterval(checkLineStatus, 60000); 
             
             const formattedNow = getFormattedCurrentTime();
             const taxiDateTimeInput = document.getElementById('taxiDateTime');
             if (taxiDateTimeInput) {
                 taxiDateTimeInput.value = formattedNow;
                 taxiDateTimeInput.min = new Date().toISOString().slice(0, 16);
             }
             const cargoDateTimeInput = document.getElementById('cargoDateTime');
             if (cargoDateTimeInput) {
                 cargoDateTimeInput.value = formattedNow;
                 cargoDateTimeInput.min = new Date().toISOString().slice(0, 16);
             }
             updateCargoPrice(); 
             updateTaxiPrice(); 
             updateDeliveryPrice();
        });
        
        function setGeoButtonLoading(mode, isLoading, isError = false) {
            let buttonEl, iconEl, textEl;
            if (mode === 'main') {
                buttonEl = document.getElementById('locationBtn');
                textEl = document.getElementById('locationBtnText');
                if (isLoading) {
                    textEl.innerHTML = '<i class="fas fa-spinner animate-spin"></i> –û–ø—Ä–µ–¥–µ–ª—è–µ–º...';
                    buttonEl.disabled = true;
                } else {
                    buttonEl.disabled = false;
                    textEl.innerHTML = isError ? '<i class="fas fa-times"></i> –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è' : '<i class="fas fa-check"></i> –ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                }
                return;
            } 
            let iconId;
            switch(mode) {
                case 'taxi': iconId = 'taxiGeoIcon'; break;
                case 'auction': iconId = 'auctionGeoIcon'; break;
                case 'delivery': iconId = 'deliveryGeoIcon'; break;      
                case 'cargo': iconId = 'cargoGeoIcon'; break;            
                case 'soberDriver': iconId = 'soberDriverGeoIcon'; break; 
                case 'assistance': iconId = 'assistanceGeoIcon'; break; 
                default: return;
            }
            iconEl = document.getElementById(iconId);
            buttonEl = iconEl ? iconEl.closest('button') : null;
            if (buttonEl && iconEl) {
                buttonEl.disabled = isLoading;
                if (isLoading) {
                    iconEl.className = 'fas fa-spinner animate-spin';
                    buttonEl.title = '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...';
                } else {
                    iconEl.className = isError ? 'fas fa-exclamation-triangle' : 'fas fa-compass';
                    buttonEl.title = '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                }
            }
        }

        window.getCurrentLocation = function(trigger) {
            if (!navigator.geolocation) {
                displayMessageModal('–û—à–∏–±–∫–∞', '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.', true);
                setGeoButtonLoading(trigger, false, true);
                return;
            }
            setGeoButtonLoading(trigger, true);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    setGeoButtonLoading(trigger, false, false);
                    const lat = position.coords.latitude.toFixed(5);
                    const lon = position.coords.longitude.toFixed(5);
                    const yandexMapUrl = `https://yandex.kz/maps/?pt=${lon},${lat}&z=16&l=map`;
                    currentGeolocatedAddress = `[–ö–û–û–†–î–ò–ù–ê–¢–´] ${lat}, ${lon}. –°—Å—ã–ª–∫–∞: ${yandexMapUrl}`; 
                    
                    let inputId, message, placeholder, successMessage = '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–ª–µ "–û—Ç–∫—É–¥–∞".';

                    switch (trigger) {
                        case 'main':
                            locationResultEl.classList.remove('hidden');
                            locationAddressEl.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lon} (–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É)`;
                            locationAddressEl.href = yandexMapUrl; 
                            locationAddressEl.title = '–û—Ç–∫—Ä—ã—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ';
                            setAllLocationFields(currentGeolocatedAddress);
                            displayMessageModal('–ì–æ—Ç–æ–≤–æ!', '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ —Ñ–æ—Ä–º—ã –∑–∞–∫–∞–∑–∞!', false);
                            return;
                        case 'taxi': inputId = 'taxiFrom'; placeholder = '–û—Ç–∫—É–¥–∞ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)'; break;
                        case 'auction': inputId = 'auctionFrom'; placeholder = '–û—Ç–∫—É–¥–∞ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)'; break;
                        case 'delivery': inputId = 'deliveryAddress'; placeholder = '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)'; successMessage = '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–ª–µ "–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏".'; break;
                        case 'cargo': inputId = 'cargoFrom'; placeholder = '–ê–¥—Ä–µ—Å –ø–æ–≥—Ä—É–∑–∫–∏ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)'; successMessage = '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–ª–µ "–ê–¥—Ä–µ—Å –ø–æ–≥—Ä—É–∑–∫–∏".'; break;
                        case 'soberDriver': inputId = 'soberDriverFrom'; placeholder = '–ê–¥—Ä–µ—Å –∞–≤—Ç–æ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)'; successMessage = '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–ª–µ "–í–∞—à —Ç–µ–∫—É—â–∏–π –∞–¥—Ä–µ—Å".'; break;
                        case 'assistance': inputId = 'assistanceAddress'; placeholder = '–ê–¥—Ä–µ—Å –ø–æ–º–æ—â–∏ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)'; successMessage = '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–ª–µ "–ê–¥—Ä–µ—Å (–≥–¥–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å)".'; break;
                        default: return;
                    }
                    const input = document.getElementById(inputId);
                    if (input) { input.value = currentGeolocatedAddress; input.placeholder = placeholder; }
                    displayMessageModal('–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω', successMessage, false);
                    if (trigger === 'taxi') updateTaxiPrice();
                },
                (error) => {
                    setGeoButtonLoading(trigger, false, true);
                    let errorMessage = '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.';
                    if (error.code === error.PERMISSION_DENIED) errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω.';
                    displayMessageModal('–û—à–∏–±–∫–∞', errorMessage, true);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        let stopCounter = 0; 
        window.addStop = function(containerId, mode) {
            if (stopCounter >= 3) { displayMessageModal('–õ–∏–º–∏—Ç', '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ (3) –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ.', false); return; }
            stopCounter++;
            const stopsContainer = document.getElementById(containerId);
            const stopId = `${containerId}Input${stopCounter}`;
            const stopLabel = `–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å ${stopCounter}`;
            const stopDiv = document.createElement('div');
            stopDiv.className = "flex space-x-2 additional-stop-item input-with-plus-btn"; 
            const divId = `stopDiv${containerId}${stopCounter}`;
            stopDiv.id = divId;
            const inputEvents = (mode === 'taxi') ? 'oninput="updateTaxiPrice()"' : '';
            stopDiv.innerHTML = `<input id="${stopId}" name="${stopId}" type="text" list="toHistory" autocomplete="off" class="form-input-control" placeholder="${stopLabel} (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" required ${inputEvents}><button type="button" onclick="removeStop('${divId}', '${mode}')" class="remove-stop-btn btn-active" title="–£–¥–∞–ª–∏—Ç—å –∞–¥—Ä–µ—Å"><i class="fas fa-minus"></i></button>`;
            stopsContainer.appendChild(stopDiv);
            setAddressHistory(); 
            if (mode === 'taxi') updateTaxiPrice();
        }
        
        window.removeStop = function(divId, mode) {
            const elementToRemove = document.getElementById(divId);
            if (elementToRemove) { elementToRemove.remove(); stopCounter--; if (stopCounter < 0) stopCounter = 0; }
            if (mode === 'taxi') updateTaxiPrice();
        }
        
        function countFilledAddresses() {
            let count = 0;
            const fromInput = document.getElementById('taxiFrom');
            const toInput = document.getElementById('taxiTo');
            const stopsContainer = document.getElementById('additionalStops');
            if (fromInput && fromInput.value.trim().length > 0) count++; 
            if (toInput && toInput.value.trim().length > 0) count++;
            if (stopsContainer) { stopsContainer.querySelectorAll('input.form-input-control').forEach(input => { if (input.value.trim().length > 0) count++; }); }
            return count;
        }
        
        window.updateTaxiPrice = function() {
            const priceEl = document.getElementById('taxiPriceEstimate');
            if (!priceEl) return;
            const toInput = document.getElementById('taxiTo');
            const destination = toInput ? toInput.value.trim() : '';
            
            const rate = findIntercityRate(destination);
            if (rate) {
                const minPrice = Math.ceil((rate.min * priceMultiplier) / 50) * 50;
                const maxPrice = Math.ceil((rate.max * priceMultiplier) / 50) * 50;
                let priceText = (minPrice === maxPrice) ? `~ ${minPrice} ‚Ç∏` : `–æ—Ç ${minPrice}‚Äì${maxPrice} ‚Ç∏`;
                if (priceMultiplier > 1) priceText += " (–¢–∞—Ä–∏—Ñ –ø–æ–≤—ã—à–µ–Ω)";
                priceEl.textContent = priceText;
                return; 
            }
            const addressCount = countFilledAddresses();
            let baseMin = (addressCount >= 3) ? CONFIG.TAXI.MANY_STOPS_MIN : CONFIG.TAXI.BASE_PRICE;
            let baseMax = (addressCount >= 3) ? CONFIG.TAXI.MANY_STOPS_MAX : (CONFIG.TAXI.BASE_PRICE + CONFIG.TAXI.MIN_PRICE_RANGE_OFFSET);
            baseMin = Math.ceil((baseMin * priceMultiplier) / 10) * 10;
            baseMax = Math.ceil((baseMax * priceMultiplier) / 10) * 10;
            let priceText = `–æ—Ç ${baseMin}‚Äì${baseMax} —Ç–≥`;
            if (priceMultiplier > 1) priceText += " (–¢–∞—Ä–∏—Ñ –ø–æ–≤—ã—à–µ–Ω)";
            priceEl.textContent = priceText;
            debouncedOSRM();
        }
        
        window.updateDeliveryPrice = function() {
            const priceEl = document.getElementById('deliveryPriceEstimate');
            if (!priceEl) return;
            let base = CONFIG.DELIVERY.BASE_PRICE;
            let final = Math.ceil((base * priceMultiplier) / 50) * 50;
            let text = `–æ—Ç ${final} —Ç–≥`;
            if (priceMultiplier > 1) text += " (–í—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å)";
            priceEl.textContent = text;
        }

        window.openModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                document.querySelectorAll('.status-message').forEach(el => el.classList.remove('active'));
                if (modalId === 'taxiModal' || modalId === 'auctionModal') setAddressHistory();
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
                if (modalId === 'deliveryModal') {
                    const hour = new Date().getHours();
                    if (hour >= 23 || hour < 8) showStatus(modalId, '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ú–∞–≥–∞–∑–∏–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç –¥–æ 23:00. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.');
                    updateDeliveryPrice();
                }
                const formattedNow = getFormattedCurrentTime();
                const minTime = new Date().toISOString().slice(0, 16);
                 if (modalId === 'taxiModal') {
                      const dtInput = document.getElementById('taxiDateTime');
                      dtInput.value = formattedNow; dtInput.min = minTime; updateTaxiPrice(); 
                 }
                 if (modalId === 'cargoModal') {
                      const dtInput = document.getElementById('cargoDateTime');
                      dtInput.value = formattedNow; dtInput.min = minTime; document.getElementById('cargoMovers').value = '0'; updateCargoPrice(); 
                 }
                const firstInput = modal.querySelector('input, textarea, select');
                if (firstInput) firstInput.focus();
            }
        }

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
                if (modalId === 'taxiModal' || modalId === 'auctionModal') {
                    const stopsContainerTaxi = document.getElementById('additionalStops');
                    const stopsContainerAuction = document.getElementById('additionalStopsAuction');
                    if (stopsContainerTaxi) stopsContainerTaxi.innerHTML = '';
                    if (stopsContainerAuction) stopsContainerAuction.innerHTML = '';
                    stopCounter = 0; 
                    const form = document.getElementById(modalId.replace('Modal', 'Form'));
                    if (form) form.reset();
                } else if (modalId === 'servicesMenuModal') {
                } else {
                    const form = document.getElementById(modalId.replace('Modal', 'Form'));
                    if (form) form.reset();
                }
                if (modalId === 'assistanceModal') {
                    document.getElementById('carDetails').classList.add('hidden');
                    document.getElementById('assistanceType').value = '';
                }
                if (modalId === 'taxiModal') {
                      const content = document.getElementById('preorderContent');
                      const icon = document.getElementById('preorderIcon');
                      if (content && !content.classList.contains('hidden')) content.classList.add('hidden');
                      if (icon && icon.classList.contains('rotate-180')) icon.classList.remove('rotate-180');
                      const formattedNow = getFormattedCurrentTime();
                      document.getElementById('taxiDateTime').value = formattedNow;
                      updateTaxiPrice(); 
                 }
                 if (modalId === 'cargoModal') {
                      const formattedNow = getFormattedCurrentTime();
                      document.getElementById('cargoDateTime').value = formattedNow;
                      document.getElementById('cargoMovers').value = '0'; 
                      updateCargoPrice(); 
                 }
            }
        }

        function showStatus(modalId, message) {
            const statusEl = document.getElementById(modalId.replace('Modal', 'Status'));
            if (statusEl) { statusEl.textContent = message; statusEl.classList.add('active'); }
        }
        
        function displayMessageModal(title, message, isError = false) {
            const existingModal = document.getElementById('alertModal');
            if (existingModal) existingModal.remove();
            if (!isError && (title === '–ó–∞–∫–∞–∑ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω!' || title === '–ì–æ—Ç–æ–≤–æ!')) {
                 const modalHtml = `<div id="alertModal" class="fixed inset-0 bg-black bg-opacity-60 z-[2000] flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-100"><div class="success-checkmark mb-4"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2"><circle class="path circle" fill="none" stroke="#10b981" stroke-width="6" stroke-miterlimit="10" cx="65.1" cy="65.1" r="62.1"/><polyline class="path check" fill="none" stroke="#10b981" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" points="100.2,40.2 51.5,88.8 29.8,67.5 "/></svg></div><h3 class="text-2xl font-bold mb-2 text-gray-800 dark:text-white">${title}</h3><p class="mb-6 text-gray-600 dark:text-gray-300 text-sm">${message}</p><button onclick="document.getElementById('alertModal').remove()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-105 btn-active">–û—Ç–ª–∏—á–Ω–æ</button></div></div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                return;
            }
            const modalHtml = `<div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm text-center"><h3 class="text-xl font-bold mb-4 ${isError ? 'text-red-600' : 'text-indigo-600'}">${title}</h3><p class="mb-6 text-gray-700 dark:text-gray-300">${message}</p><button onclick="document.getElementById('alertModal').remove()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg btn-active">OK</button></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function setAllLocationFields(locationText) {
            const fieldsToFill = [ { id: 'taxiFrom', placeholder: '–û—Ç–∫—É–¥–∞ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)' }, { id: 'deliveryAddress', placeholder: '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)' }, { id: 'cargoFrom', placeholder: '–ê–¥—Ä–µ—Å –ø–æ–≥—Ä—É–∑–∫–∏ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)' }, { id: 'soberDriverFrom', placeholder: '–ê–¥—Ä–µ—Å –∞–≤—Ç–æ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)' }, { id: 'assistanceAddress', placeholder: '–ê–¥—Ä–µ—Å –ø–æ–º–æ—â–∏ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)' }, { id: 'auctionFrom', placeholder: '–û—Ç–∫—É–¥–∞ (–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)' } ];
            fieldsToFill.forEach(field => {
                const input = document.getElementById(field.id);
                if (input) { input.value = locationText; input.placeholder = field.placeholder; }
            });
            updateTaxiPrice();
        }
        
        window.updateCargoPrice = function() {
            const cargoMoversSelect = document.getElementById('cargoMovers');
            const cargoTotalPriceEl = document.getElementById('cargoTotalPrice');
            const cargoPriceNoteEl = document.getElementById('cargoPriceNote');
            if (!cargoMoversSelect || !cargoTotalPriceEl || !cargoPriceNoteEl) return;
            const moversCount = parseInt(cargoMoversSelect.value) || 0;
            const totalPrice = CONFIG.CARGO.HOURLY_RATE + (moversCount * CONFIG.CARGO.MOVER_RATE);
            const formattedPrice = totalPrice.toLocaleString('ru-RU');
            cargoTotalPriceEl.textContent = `${formattedPrice} —Ç–≥`;
            if (moversCount > 0) cargoPriceNoteEl.innerHTML = `–ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å ${CONFIG.CARGO.HOURLY_RATE.toLocaleString('ru-RU')} —Ç–≥ + –¥–æ–ø–ª–∞—Ç–∞ –∑–∞ ${moversCount} —á–µ–ª.`;
            else cargoPriceNoteEl.textContent = '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ - 1 —á–∞—Å.';
        }

        window.togglePreorder = function() {
            const content = document.getElementById('preorderContent');
            const icon = document.getElementById('preorderIcon');
            if (content.classList.contains('hidden')) { content.classList.remove('hidden'); if (icon) icon.classList.add('rotate-180'); } 
            else { content.classList.add('hidden'); if (icon) icon.classList.remove('rotate-180'); }
        }
        
        window.openServicesMenu = function(mode) {
            orderDestination = mode;
            const footer = document.getElementById('servicesMenuFooter');
            if (footer) {
                if (mode === 'telegram') footer.classList.remove('hidden');
                else footer.classList.add('hidden');
            }
            openModal('servicesMenuModal');
        }

        window.openServiceFromMenu = function(serviceKey) {
            closeModal('servicesMenuModal');
            setTimeout(() => {
                if (MODALS[serviceKey]) openModal(MODALS[serviceKey].id);
            }, 100);
        }
        
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.setAttribute('readonly', '');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try { document.execCommand('copy'); } catch (err) { console.error('Failed to copy', err); }
            document.body.removeChild(textarea);
        }

        window.swapTaxiAddresses = function() {
            const fromEl = document.getElementById('taxiFrom');
            const toEl = document.getElementById('taxiTo');
            const temp = fromEl.value;
            fromEl.value = toEl.value;
            toEl.value = temp;
            updateTaxiPrice();
        }

        window.addWish = function(text) {
            const wishEl = document.getElementById('taxiWishes');
            let currentText = wishEl.value.trim();
            if (!currentText) wishEl.value = text;
            else if (!currentText.includes(text)) wishEl.value = currentText + ', ' + text;
        }
        
        window.shareApp = async function() {
            const shareData = { title: '–¢–∞–∫—Å–∏ ¬´–£—Å–ø–µ—Ö¬ª', text: '–ó–∞–∫–∞–∑—ã–≤–∞–π —Ç–∞–∫—Å–∏ –≤ –ë–µ–ª–æ—É—Å–æ–≤–∫–µ –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ!', url: window.location.href };
            try {
                if (navigator.share) await navigator.share(shareData);
                else { copyToClipboard(window.location.href); displayMessageModal('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', '–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.', false); }
            } catch (err) { console.error(err); }
        }
        
        document.querySelectorAll('.service-btn').forEach(button => {
            button.addEventListener('click', () => {
                orderDestination = 'whatsapp';
                const service = button.getAttribute('data-service');
                if (MODALS[service]) openModal(MODALS[service].id);
            });
        });

        document.querySelectorAll('.close-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = button.getAttribute('data-modal');
                closeModal(modalId);
            });
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeModal(overlay.id);
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal-overlay.active');
                if (openModal) closeModal(openModal.id);
            }
        });
        
        const assistanceTypeSelect = document.getElementById('assistanceType');
        const carDetailsDiv = document.getElementById('carDetails');
        if (assistanceTypeSelect && carDetailsDiv) {
            assistanceTypeSelect.addEventListener('change', (e) => {
                const selectedType = e.target.value;
                if (selectedType === '–ü–æ–¥–∫–∞—á–∞—Ç—å –∫–æ–ª–µ—Å–æ' || selectedType === '–ü—Ä–∏–∫—É—Ä–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å') carDetailsDiv.classList.remove('hidden');
                else carDetailsDiv.classList.add('hidden');
            });
        }

        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formId = this.id;
                const modalKey = Object.keys(MODALS).find(key => MODALS[key].formId === formId);
                const modalConfig = MODALS[modalKey];
                
                if (!modalConfig) return;

                const modalId = modalConfig.id;
                const statusEl = document.getElementById(modalId.replace('Modal', 'Status'));
                if (statusEl) statusEl.classList.remove('active');

                let message = `${modalConfig.prefix}\n\n`;
                let requiredFieldsMissing = false;

                const getVal = (id, label, isRequired = false) => {
                    const input = document.getElementById(id);
                    let value = input ? input.value.trim() : '';
                    if (isRequired && !value) requiredFieldsMissing = true;
                    if (input && input.type === 'checkbox') value = input.checked ? '–î–∞' : '–ù–µ—Ç';
                    return `*${label}*:\n${value || '‚Äî'}\n\n`;
                };

                const collectStops = (containerId) => {
                    let stops = '';
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.querySelectorAll('input').forEach((input, index) => {
                            if (input.value.trim()) {
                                const stopLabel = `–î–æ–ø. –∞–¥—Ä–µ—Å ${index + 1}`;
                                stops += `*${stopLabel}*:\n${input.value.trim()}\n\n`;
                            }
                        });
                    }
                    return stops;
                };
                
                const handlePreorder = (dateTimeId, basePrefix) => {
                    const dateTimeInput = document.getElementById(dateTimeId).value;
                    let prefixMessage = basePrefix;
                    if (dateTimeInput) {
                        const selectedTime = new Date(dateTimeInput);
                        const currentTime = new Date();
                        if (selectedTime > currentTime) {
                            const formattedDate = selectedTime.toLocaleString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                            prefixMessage = `‚è∞ –ü–†–ï–î–ó–ê–ö–ê–ó (${modalConfig.title}) ‚è∞\n\n`;
                            prefixMessage += `*–í—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏*:\n${formattedDate}\n\n`;
                        }
                    }
                    return prefixMessage;
                };

                let addressesToSave = [];

                switch (modalKey) {
                    case 'taxi':
                        const fromAddress = document.getElementById('taxiFrom').value.trim();
                        const toAddress = document.getElementById('taxiTo').value.trim();
                        const wishes = document.getElementById('taxiWishes').value.trim();
                        const passengerPhone = document.getElementById('passengerPhone').value.trim(); 
                        const preorderContent = document.getElementById('preorderContent');
                        const isPreorderOpen = preorderContent && !preorderContent.classList.contains('hidden');
                        
                        if (isPreorderOpen) message = handlePreorder('taxiDateTime', modalConfig.prefix);
                        else message = `${modalConfig.prefix}\n\n`;
                        
                        if (!fromAddress) requiredFieldsMissing = true;
                        if (!toAddress) requiredFieldsMissing = true;
                        
                        message += `–û—Ç–∫—É–¥–∞:\n${fromAddress}\n\n`;
                        message += `–ö—É–¥–∞:\n${toAddress}\n\n`;
                        if (wishes) message += `*–ü–æ–∂–µ–ª–∞–Ω–∏—è*:\n${wishes}\n\n`;
                        let stopMessage = collectStops('additionalStops');
                        if (stopMessage) { message += '\n--- –î–û–ü. –ê–î–†–ï–°–ê –ü–û –ü–£–¢–ò ---\n\n' + stopMessage + '---------------------------\n\n'; }
                        if (passengerPhone) { message += 'üìû –ö–û–ù–¢–ê–ö–¢–´:\n' + `*–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏*:\n${passengerPhone}\n\n`; }
                        const currentPriceText = document.getElementById('taxiPriceEstimate').textContent;
                        message += `üí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞: ${currentPriceText} (—É—Ç–æ—á–Ω–∏—Ç –≤–æ–¥–∏—Ç–µ–ª—å)`;
                        
                        if (fromAddress) addressesToSave.push(fromAddress);
                        if (toAddress) addressesToSave.push(toAddress);
                        if (fromAddress && toAddress) { saveOrderToFullHistory(fromAddress, toAddress, currentPriceText); }
                        break;
                    case 'auction':
                        const auctionPrice = document.getElementById('auctionPrice').value;
                        if (!auctionPrice || parseInt(auctionPrice) < CONFIG.AUCTION.MIN_PRICE) {
                            requiredFieldsMissing = true;
                            showStatus(modalId, `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (–º–∏–Ω–∏–º—É–º ${CONFIG.AUCTION.MIN_PRICE} KZT).`);
                            return;
                        }
                        message += getVal('auctionFrom', '–û—Ç–∫—É–¥–∞', true);
                        message += getVal('auctionTo', '–ö—É–¥–∞', true);
                        message += collectStops('additionalStopsAuction');
                        message += `*–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è —Ü–µ–Ω–∞*:\n${auctionPrice} KZT\n\n`;
                        message += '‚ö†Ô∏è –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –≠—Ç–æ —Ü–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞. –ü—Ä–∏–º–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ –∑–∞–∫–∞–∑—É —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.';
                        if (document.getElementById('auctionFrom').value.trim()) addressesToSave.push(document.getElementById('auctionFrom').value.trim());
                        if (document.getElementById('auctionTo').value.trim()) addressesToSave.push(document.getElementById('auctionTo').value.trim());
                        break;
                    case 'delivery':
                        message += getVal('deliveryItems', '–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤', true);
                        message += getVal('deliveryAddress', '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏', true);
                        message += getVal('deliveryStore', '–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –º–∞–≥–∞–∑–∏–Ω—É');
                        const deliveryPriceText = document.getElementById('deliveryPriceEstimate').textContent;
                        message += `üí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞: ${deliveryPriceText}`;
                        if (document.getElementById('deliveryAddress').value.trim()) addressesToSave.push(document.getElementById('deliveryAddress').value.trim());
                        break;
                    case 'cargo':
                        const cargoMoversSelect = document.getElementById('cargoMovers');
                        const moversCount = parseInt(cargoMoversSelect.value);
                        const totalPrice = CONFIG.CARGO.HOURLY_RATE + (moversCount * CONFIG.CARGO.MOVER_RATE);
                        const formattedPrice = totalPrice.toLocaleString('ru-RU');
                        const moversText = (moversCount > 0) ? `${moversCount} —á–µ–ª. (–î–æ–ø–ª–∞—Ç–∞: ${moversCount * CONFIG.CARGO.MOVER_RATE} —Ç–≥/—á–∞—Å)` : '–ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è';
                        message = handlePreorder('cargoDateTime', modalConfig.prefix);
                        message += getVal('cargoFrom', '–ê–¥—Ä–µ—Å –ø–æ–≥—Ä—É–∑–∫–∏', true);
                        message += getVal('cargoTo', '–ê–¥—Ä–µ—Å –≤—ã–≥—Ä—É–∑–∫–∏', true);
                        message += getVal('cargoDescription', '–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞', true);
                        message += `*–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑—á–∏–∫–æ–≤*:\n${moversText}\n\n`;
                        message += `*–ò–¢–û–ì–û–í–ê–Ø –°–£–ú–ú–ê (–∑–∞ 1 —á–∞—Å)*:\n${formattedPrice} —Ç–≥\n\n`;
                        message += `üí∞ –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: ${CONFIG.CARGO.HOURLY_RATE.toLocaleString('ru-RU')} —Ç–≥/—á–∞—Å`;
                        if (document.getElementById('cargoFrom').value.trim()) addressesToSave.push(document.getElementById('cargoFrom').value.trim());
                        if (document.getElementById('cargoTo').value.trim()) addressesToSave.push(document.getElementById('cargoTo').value.trim());
                        break;
                    case 'soberDriver':
                        message += getVal('soberDriverFrom', '–¢–µ–∫—É—â–∏–π –∞–¥—Ä–µ—Å (–ê–≤—Ç–æ)', true);
                        message += getVal('soberDriverCarModel', '–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å –∞–≤—Ç–æ', true); 
                        message += getVal('soberDriverTo', '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –∞–≤—Ç–æ', true);
                        message += `üí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞: –æ—Ç ${CONFIG.SOBER_DRIVER.MIN_PRICE} —Ç–≥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è)`;
                        if (document.getElementById('soberDriverFrom').value.trim()) addressesToSave.push(document.getElementById('soberDriverFrom').value.trim());
                        break;
                    case 'assistance':
                        const type = document.getElementById('assistanceType').value;
                        if (!type) { requiredFieldsMissing = true; break; }
                        message += getVal('assistanceType', '–¢–∏–ø –ø–æ–º–æ—â–∏');
                        if (type === '–ü–æ–¥–∫–∞—á–∞—Ç—å –∫–æ–ª–µ—Å–æ' || type === '–ü—Ä–∏–∫—É—Ä–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å') {
                            message += getVal('carModel', '–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å –∞–≤—Ç–æ');
                            message += getVal('licencePlate', '–ì–æ—Å. –Ω–æ–º–µ—Ä');
                        }
                        message += getVal('assistanceTask', '–î–µ—Ç–∞–ª–∏ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è');
                        message += getVal('assistanceAddress', '–ê–¥—Ä–µ—Å (–≥–¥–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å)', true);
                        message += `üí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞: –æ—Ç ${CONFIG.ASSISTANCE.MIN_PRICE} —Ç–≥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ —Ç—Ä–µ–±—É–µ–º–æ–π –ø–æ–º–æ—â–∏)`;
                        if (document.getElementById('assistanceAddress').value.trim()) addressesToSave.push(document.getElementById('assistanceAddress').value.trim());
                        break;
                } 

                if (requiredFieldsMissing) {
                    showStatus(modalId, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.');
                    return;
                }
                
                for (const address of addressesToSave) {
                    await saveAddress(address);
                }

                if (navigator.vibrate) navigator.vibrate(200); 

                if (orderDestination === 'telegram') {
                    copyToClipboard(message);
                    displayMessageModal('–ó–∞–∫–∞–∑ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω!', '–¢–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –°–µ–π—á–∞—Å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è Telegram ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –≤ —á–∞—Ç.', false);
                    setTimeout(() => { window.open('https://t.me/TaxiUspehk', '_blank'); }, 1500); 
                } else {
                    displayMessageModal('–ó–∞–∫–∞–∑ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω!', '–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ WhatsApp –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è...', false);
                    setTimeout(() => {
                         const waLink = `https://wa.me/${CONFIG.PHONE_NUMBER}?text=${encodeURIComponent(message)}`;
                         window.open(waLink, '_blank');
                    }, 1000); 
                }
                
                closeModal(modalId);
                this.reset();
            }); 
        }); 

        window.showPWAInstructions = function() {
            document.getElementById('pwaModal').classList.remove('hidden');
        }
        
        window.showPartnerModal = function() {
            document.getElementById('partnerModal').classList.remove('hidden');
        }
    </script>
</body>
</html>
```
